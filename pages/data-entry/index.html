<!-- pages/data-entry/index.html -->
<div class="dataentry-page">
    <div class="container-page">
        <!-- Page head -->
        <div class="page-head">
            <div class="d-flex align-items-center gap-2">
                <h1 class="kh-head h4 m-0">បញ្ចូលទិន្នន័យ</h1>
                <nav aria-label="breadcrumb" class="small">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="#/">Dashboard</a></li>
                        <li class="breadcrumb-item">Data</li>
                        <li class="breadcrumb-item active" aria-current="page">Entry</li>
                    </ol>
                </nav>
            </div>
            <div class="separator-breadcrumb border-top"></div>
        </div>

        <!-- Body -->
        <div class="page-body">
            <div class="card shadow-sm centered-card w-100">
                <div class="card-body">

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="entryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-ind-tab" data-bs-toggle="tab" data-bs-target="#tab-ind" type="button" role="tab">សូចនាករ (Reports)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-iss-tab" data-bs-toggle="tab" data-bs-target="#tab-iss" type="button" role="tab">បញ្ហា (Issues)</button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3">
                        <!-- ================= Indicators ================= -->
                        <div class="tab-pane fade show active" id="tab-ind" role="tabpanel">
                            <!-- Filters -->
                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-sm-3">
                                    <label class="form-label">រយៈពេល (Period)</label>
                                    <select id="ind_period" class="form-select"></select>
                                </div>
                                <div class="col-sm-3">
                                    <label class="form-label">ការិយាល័យ</label>
                                    <select id="ind_department" class="form-select"></select>
                                </div>
                                <div class="col-sm-3">
                                    <label class="form-label">ផ្នែក</label>
                                    <select id="ind_unit" class="form-select"></select>
                                </div>
                                <div class="col-sm-3">
                                    <label class="form-label">សូចនាករ</label>
                                    <select id="ind_indicator" class="form-select"></select>
                                </div>
                            </div>

                            <!-- Entry form -->
                            <form id="frmReport" class="row g-3">
                                <input type="hidden" id="report_id" />
                                <div class="col-sm-4">
                                    <label class="form-label">តម្លៃ (Value) <span class="text-danger">*</span></label>
                                    <input id="ind_value" type="number" step="any" class="form-control" required />
                                    <div class="invalid-feedback">សូមបញ្ចូលតម្លៃ</div>
                                </div>
                                <div class="col-sm-8">
                                    <label class="form-label">កំណត់ចំណាំ</label>
                                    <input id="ind_note" class="form-control" placeholder="ចំណាំបន្ថែម…" />
                                </div>
                                <div class="col-12 d-flex gap-2">
                                    <button id="btnSaveReport" class="btn btn-primary" type="submit">រក្សាទុក</button>
                                    <button id="btnResetReport" class="btn btn-outline-secondary" type="button">សម្អាត</button>
                                </div>
                            </form>

                            <div class="separator-breadcrumb border-top my-3"></div>

                            <!-- Recent entries -->
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <h5 class="kh-head m-0">ធាតុថ្មីៗ</h5>
                                <span id="statusReports" class="small text-muted"></span>
                                <div class="ms-auto input-group input-group-sm" style="max-width:260px">
                                    <input id="qReports" class="form-control" placeholder="ស្វែងរក…">
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table id="tblReports" class="table table-striped table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th style="width:90px">ID</th>
                                        <th>Period</th>
                                        <th>Indicator</th>
                                        <th>Value</th>
                                        <th>Note</th>
                                        <th style="width:160px" class="text-end">សកម្មភាព</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="6" class="skel"></td></tr>
                                    <tr><td colspan="6" class="skel"></td></tr>
                                    <tr><td colspan="6" class="skel"></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ================= Issues ================= -->
                        <div class="tab-pane fade" id="tab-iss" role="tabpanel">
                            <!-- Filters -->
                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-sm-3">
                                    <label class="form-label">រយៈពេល</label>
                                    <select id="iss_period" class="form-select"></select>
                                </div>
                                <div class="col-sm-3">
                                    <label class="form-label">ការិយាល័យ</label>
                                    <select id="iss_department" class="form-select"></select>
                                </div>
                                <div class="col-sm-3">
                                    <label class="form-label">ផ្នែក</label>
                                    <select id="iss_unit" class="form-select"></select>
                                </div>
                                <div class="col-sm-3">
                                    <label class="form-label">ភ្ជាប់សូចនាករ (ស្រេចចិត្ត)</label>
                                    <select id="iss_indicator" class="form-select"></select>
                                </div>
                            </div>

                            <!-- Issue form -->
                            <form id="frmIssue" class="row g-3">
                                <input type="hidden" id="issue_id" />
                                <div class="col-md-6">
                                    <label class="form-label">ចំណងជើងបញ្ហា <span class="text-danger">*</span></label>
                                    <input id="iss_title" class="form-control" required />
                                    <div class="invalid-feedback">សូមបញ្ចូលចំណងជើង</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">កម្រិតធ្ងន់ធ្ងរ</label>
                                    <select id="iss_severity" class="form-select">
                                        <option value="">— ជ្រើស —</option>
                                        <option value="low">ទាប</option>
                                        <option value="medium">មធ្យម</option>
                                        <option value="high">ខ្ពស់</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">ពិពណ៌នា</label>
                                    <textarea id="iss_desc" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="col-12 d-flex gap-2">
                                    <button id="btnSaveIssue" class="btn btn-primary" type="submit">រក្សាទុក</button>
                                    <button id="btnResetIssue" class="btn btn-outline-secondary" type="button">សម្អាត</button>
                                </div>
                            </form>

                            <div class="separator-breadcrumb border-top my-3"></div>

                            <!-- Issues table -->
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <h5 class="kh-head m-0">បញ្ហាថ្មីៗ</h5>
                                <span id="statusIssues" class="small text-muted"></span>
                                <div class="ms-auto input-group input-group-sm" style="max-width:260px">
                                    <input id="qIssues" class="form-control" placeholder="ស្វែងរក…">
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table id="tblIssues" class="table table-striped table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th style="width:90px">ID</th>
                                        <th>Title</th>
                                        <th>Severity</th>
                                        <th>Period</th>
                                        <th>Indicator</th>
                                        <th style="width:160px" class="text-end">សកម្មភាព</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="6" class="skel"></td></tr>
                                    <tr><td colspan="6" class="skel"></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="small text-muted mt-2" id="statusEntry"></div>
        </div>
    </div>
</div>

<style>
    .dataentry-page{flex:1 1 auto; display:flex; flex-direction:column; min-height:0;}
    .container-page{width:100%; max-width:1280px; margin:0 auto; padding:16px 18px 12px; display:flex; flex-direction:column; min-height:0;}
    .page-head{display:flex; flex-direction:column; gap:10px; margin-bottom:12px;}
    .page-body{flex:1 1 auto; min-height:0; display:flex; justify-content:center;}
    .centered-card{max-width:1200px; border:1px solid #eef0f4; border-radius:14px;}
    .skel{ position:relative; overflow:hidden; background:#f3f4f6; height:44px; }
    .skel::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
      animation:shimmer 1.1s infinite }
    @keyframes shimmer{ 100%{ transform:translateX(100%);} }
    #tblReports th:last-child,#tblIssues th:last-child{ text-align:right; }
</style>

<script type="module">
    import { getAuth, isSuper } from '../../assets/js/app.auth.js';
    import { gasList, gasSave, ID_FIELDS } from '../../assets/js/app.menu.js';
    import { upsertReport } from '../../assets/js/app.api.js';

    /* ---------- Helpers ---------- */
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const prettyPeriod = pid=>{
      const mNames = ['មករា','កុម្ភះ','មីនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
      const y = (String(pid||'').match(/^(\d{4})/)||[])[1]||'';
      const tag = (String(pid||'').match(/(M\d{2}|Q[1-4]|H[12]|N9|Y12)$/)||[])[1]||'';
      if(/^M\d{2}$/.test(tag)) return `${mNames[+tag.slice(1)-1]} ${y}`;
      if(/^Q[1-4]$/.test(tag)) return `${tag} ${y}`;
      if(/^H[12]$/.test(tag))  return `${tag} ${y}`;
      if(tag==='N9') return `៩ខែ ${y}`;
      if(tag==='Y12') return `១២ខែ ${y}`;
      return pid||'';
    };
    function makeModal(id){
      const el = typeof id==='string'? document.getElementById(id): id;
      if (!el) return null;
      if (window.bootstrap?.Modal){
        let inst = bootstrap.Modal.getInstance ? bootstrap.Modal.getInstance(el) : null;
        if (!inst) inst = new bootstrap.Modal(el, {backdrop:true, keyboard:true, focus:true});
        return { show:()=>inst.show(), hide:()=>inst.hide() };
      }
      return { show(){ el.style.display='block'; }, hide(){ el.style.display='none'; } };
    }
    const setStatus = (id, msg)=>{ const el=document.getElementById(id); if(el) el.textContent=msg||''; };

    /* ====================== Init ====================== */
    async function initDataEntry(){
      const auth  = getAuth();
      const SUPER = isSuper(auth);

      // ---------- DOM refs ----------
      const elPeriodI = $('#ind_period'), elDeptI = $('#ind_department'), elUnitI = $('#ind_unit'), elInd = $('#ind_indicator');
      const elVal = $('#ind_value'), elNote = $('#ind_note');
      const tblRep = $('#tblReports tbody');
      const qReports = $('#qReports');
      const btnSaveReport = $('#btnSaveReport');

      const elPeriodS = $('#iss_period'), elDeptS = $('#iss_department'), elUnitS = $('#iss_unit'), elIndS = $('#iss_indicator');
      const issTitle = $('#iss_title'), issSeverity = $('#iss_severity'), issDesc = $('#iss_desc');
      const tblIss = $('#tblIssues tbody');
      const qIssues = $('#qIssues');
      const btnSaveIssue = $('#btnSaveIssue');

      // ---------- State ----------
      let PERIODS=[], DEPTS=[], UNITS=[], INDS=[], REPORTS=[], ISSUES=[];
      let unitsByDep=new Map();
      const deptName=id=>DEPTS.find(d=>String(d.department_id)===String(id))?.department_name||'';
      const unitName=id=>UNITS.find(u=>String(u.unit_id)===String(id))?.unit_name||'';
      const indName=id=>INDS.find(i=>String(i.indicator_id)===String(id))?.indicator_name||'';

      // ---------- Load master ----------
      try{
        const [periods,depts,units,inds] = await Promise.all([
          gasList('periods').catch(()=>[]),
          gasList('departments').catch(()=>[]),
          gasList('units').catch(()=>[]),
          gasList('indicators').catch(()=>[])
        ]);
        PERIODS=periods.sort((a,b)=>String(a.period_id).localeCompare(String(b.period_id)));
        DEPTS   = SUPER? depts : depts.filter(d=>String(d.department_id)===String(auth?.department_id));
        UNITS   = SUPER? units : units.filter(u=>String(u.department_id)===String(auth?.department_id));
        INDS    = SUPER? inds  : inds.filter(i=>String(i.department_id)===String(auth?.department_id) && (!auth?.unit_id || String(i.unit_id)===String(auth.unit_id)));

        // Fill selects
        elPeriodI.innerHTML = elPeriodS.innerHTML =
          PERIODS.map(p=>`<option value="${p.period_id}">${prettyPeriod(p.period_id)}</option>`).join('');

        elDeptI.innerHTML = elDeptS.innerHTML =
          `<option value="">— ការិយាល័យ —</option>` +
          DEPTS.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
        if (!SUPER){ elDeptI.value = elDeptS.value = auth?.department_id||''; elDeptI.disabled = elDeptS.disabled = true; }

        const fillUnits = (sel, depId)=>{
          const list = UNITS.filter(u=>String(u.department_id)===String(depId));
          sel.innerHTML = `<option value="">— ផ្នែក —</option>` + list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
          if (!SUPER) { sel.value = auth?.unit_id||''; sel.disabled = true; }
        };
        const dep0 = SUPER ? elDeptI.value || DEPTS[0]?.department_id : (auth?.department_id || '');
        if (dep0){ fillUnits(elUnitI,dep0); fillUnits(elUnitS,dep0); }

        const fillIndicators = ()=>{
          const dep = elDeptI.value || (SUPER? '' : auth?.department_id);
          const uni = elUnitI.value || (SUPER? '' : auth?.unit_id);
          const list = INDS.filter(i => (!dep || String(i.department_id)===String(dep)) && (!uni || String(i.unit_id)===String(uni)));
          elInd.innerHTML = list.length
            ? list.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('')
            : `<option value="">— គ្មានសូចនាករ —</option>`;
          // Same for issue side (optional)
          elIndS.innerHTML = `<option value="">— (ស្រេចចិត្ត) —</option>` +
            list.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
        };
        fillIndicators();

        // Load latest reports & issues (limit ~50)
        REPORTS = (await gasList('reports').catch(()=>[])).slice(-50).reverse();
        ISSUES  = (await gasList('issues').catch(()=>[])).slice(-50).reverse();

        renderReports(); renderIssues();
        setStatus('statusEntry', 'បានផ្ទុកទិន្នន័យផ្ទុកចូល');
      }catch(e){
        console.error(e);
        setStatus('statusEntry','បរាជ័យផ្ទុកទិន្នន័យ');
      }

      // ---------- Change handlers ----------
      elDeptI.addEventListener('change', ()=>{
        const dep = elDeptI.value;
        const list = UNITS.filter(u=>String(u.department_id)===String(dep));
        elUnitI.innerHTML = `<option value="">— ផ្នែក —</option>` + list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
        if (!SUPER) { elUnitI.value = auth?.unit_id||''; elUnitI.disabled=true; }
        // filter indicators
        const inds = INDS.filter(i=>(!dep || String(i.department_id)===String(dep)));
        elInd.innerHTML = inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
        elIndS.innerHTML = `<option value="">— (ស្រេចចិត្ត) —</option>` + inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
      });
      elUnitI.addEventListener('change', ()=>{
        const dep = elDeptI.value, uni = elUnitI.value;
        const inds = INDS.filter(i=>(!dep || String(i.department_id)===String(dep)) && (!uni || String(i.unit_id)===String(uni)));
        elInd.innerHTML = inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
        elIndS.innerHTML = `<option value="">— (ស្រេចចិត្ត) —</option>` + inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
      });
      elDeptS.addEventListener('change', ()=>{
        const dep = elDeptS.value;
        const list = UNITS.filter(u=>String(u.department_id)===String(dep));
        elUnitS.innerHTML = `<option value="">— ផ្នែក —</option>` + list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
        if (!SUPER) { elUnitS.value = auth?.unit_id||''; elUnitS.disabled=true; }
      });

      /* ================= Reports form ================= */
      $('#btnResetReport').addEventListener('click', ()=>{
        $('#report_id').value=''; elVal.value=''; elNote.value='';
      });

      $('#frmReport').addEventListener('submit', async (e)=>{
        e.preventDefault();
        // validate
        const value = (elVal.value||'').trim();
        elVal.classList.toggle('is-invalid', !value);
        if (!value) return;

        const payload = {
          report_id    : $('#report_id').value || null,
          period_id    : elPeriodI.value,
          indicator_id : elInd.value,
          department_id: (isSuper()? elDeptI.value : (auth?.department_id || '')),
          unit_id      : (isSuper()? elUnitI.value : (auth?.unit_id || '')),
          value        : Number(value),
          note         : elNote.value||'',
        };

        const old = btnSaveReport.innerHTML; btnSaveReport.disabled=true; btnSaveReport.innerHTML='កំពុងរក្សាទុក…';
        try{
          const res = await upsertReport(payload); // server helper (alias POST reports upsert)
          const row = res.row || res;
          // update local list (top)
          const i = REPORTS.findIndex(r=>String(r.report_id)===String(row.report_id));
          if (i>=0) REPORTS[i]=row; else REPORTS.unshift(row);
          renderReports(); $('#report_id').value=''; elVal.value=''; elNote.value='';
          setStatus('statusReports','រក្សាទុករួចរាល់');
        }catch(err){
          alert('បរាជ័យរក្សាទុក: ' + (err?.message||err));
        }finally{
          btnSaveReport.disabled=false; btnSaveReport.innerHTML=old;
        }
      });

      function renderReports(){
        const q = String(qReports.value||'').trim().toLowerCase();
        const rows = REPORTS.filter(r=>{
          const hay = `${r.report_id} ${r.period_id} ${prettyPeriod(r.period_id)} ${indName(r.indicator_id)||''} ${r.value||''} ${r.note||''}`.toLowerCase();
          return !q || hay.includes(q);
        });
        if (!rows.length){ tblRep.innerHTML=`<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
        const frag=document.createDocumentFragment();
        for(const r of rows){
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><span class="badge text-bg-light border">#${r.report_id||''}</span></td>
            <td>${prettyPeriod(r.period_id)}</td>
            <td>${indName(r.indicator_id)||r.indicator_id}</td>
            <td>${r.value ?? ''}</td>
            <td>${r.note||''}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-warning me-1" data-act="edit" data-id="${r.report_id}">កែ</button>
              <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${r.report_id}">លុប</button>
            </td>`;
          frag.appendChild(tr);
        }
        tblRep.innerHTML=''; tblRep.appendChild(frag);
      }
      qReports.addEventListener('input', renderReports);
      tblRep.addEventListener('click', async (e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id;
        const row = REPORTS.find(r=>String(r.report_id)===String(id));
        if (!row) return;

        if (btn.dataset.act==='edit'){
          $('#report_id').value=row.report_id||'';
          elPeriodI.value=row.period_id||elPeriodI.value;
          elDeptI.value=row.department_id||elDeptI.value; elDeptI.dispatchEvent(new Event('change'));
          elUnitI.value=row.unit_id||elUnitI.value;       elUnitI.dispatchEvent(new Event('change'));
          elInd.value = row.indicator_id||elInd.value;
          elVal.value = row.value || '';
          elNote.value= row.note  || '';
          window.scrollTo({top:0, behavior:'smooth'});
        }
        if (btn.dataset.act==='del'){
          if(!confirm('លុបរបាយការណ៍នេះមែនទេ?')) return;
          try{
            await gasSave('reports', { report_id: row.report_id, _delete:true }); // backend ត្រូវគាំទ្រ flag ឬប្រើ apiDelete ប្រសិនបើមាន
            REPORTS = REPORTS.filter(r=>String(r.report_id)!==String(id));
            renderReports(); setStatus('statusReports','លុបរួចរាល់');
          }catch(err){ alert(err?.message||err); }
        }
      });

      /* ================= Issues form ================= */
      $('#btnResetIssue').addEventListener('click', ()=>{
        $('#issue_id').value=''; issTitle.value=''; issDesc.value=''; issSeverity.value='';
      });

      $('#frmIssue').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const title=(issTitle.value||'').trim();
        issTitle.classList.toggle('is-invalid', !title);
        if(!title) return;

        const payload = {
          issue_id     : $('#issue_id').value || null,
          title        : title,
          description  : issDesc.value || '',
          severity     : issSeverity.value || '',
          period_id    : elPeriodS.value,
          indicator_id : elIndS.value || '',
          department_id: isSuper()? elDeptS.value : (auth?.department_id||''),
          unit_id      : isSuper()? elUnitS.value : (auth?.unit_id||''),
          status       : 'open'
        };

        const old=btnSaveIssue.innerHTML; btnSaveIssue.disabled=true; btnSaveIssue.innerHTML='កំពុងរក្សាទុក…';
        try{
          const res = await gasSave('issues', payload); // apiUpsert issues
          const row = res.row || res;
          const i = ISSUES.findIndex(x=>String(x.issue_id)===String(row.issue_id));
          if (i>=0) ISSUES[i]=row; else ISSUES.unshift(row);
          renderIssues(); $('#issue_id').value=''; issTitle.value=''; issDesc.value=''; issSeverity.value='';
          setStatus('statusIssues','រក្សាទុករួចរាល់');
        }catch(err){
          alert('បរាជ័យរក្សាទុក: '+(err?.message||err));
        }finally{
          btnSaveIssue.disabled=false; btnSaveIssue.innerHTML=old;
        }
      });

      function renderIssues(){
        const q = String(qIssues.value||'').trim().toLowerCase();
        const rows = ISSUES.filter(r=>{
          const hay = `${r.issue_id} ${r.title||''} ${r.severity||''} ${r.period_id||''} ${indName(r.indicator_id)||''}`.toLowerCase();
          return !q || hay.includes(q);
        });
        if (!rows.length){ tblIss.innerHTML=`<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
        const frag=document.createDocumentFragment();
        for(const r of rows){
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><span class="badge text-bg-light border">#${r.issue_id||''}</span></td>
            <td>${r.title || ''}</td>
            <td>${(r.severity||'').toUpperCase()}</td>
            <td>${prettyPeriod(r.period_id)}</td>
            <td>${indName(r.indicator_id)||''}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-warning me-1" data-act="edit" data-id="${r.issue_id}">កែ</button>
              <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${r.issue_id}">លុប</button>
            </td>`;
          frag.appendChild(tr);
        }
        tblIss.innerHTML=''; tblIss.appendChild(frag);
      }
      qIssues.addEventListener('input', renderIssues);
      tblIss.addEventListener('click', async (e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id;
        const row = ISSUES.find(r=>String(r.issue_id)===String(id));
        if (!row) return;

        if (btn.dataset.act==='edit'){
          $('#issue_id').value=row.issue_id||'';
          elPeriodS.value=row.period_id||elPeriodS.value;
          elDeptS.value=row.department_id||elDeptS.value; elDeptS.dispatchEvent(new Event('change'));
          elUnitS.value=row.unit_id||elUnitS.value;
          elIndS.value = row.indicator_id || '';
          issTitle.value = row.title || '';
          issDesc.value  = row.description || '';
          issSeverity.value = row.severity || '';
          window.scrollTo({top:0, behavior:'smooth'});
        }
        if (btn.dataset.act==='del'){
          if(!confirm('លុបបញ្ហានេះមែនទេ?')) return;
          try{
            await gasSave('issues', { issue_id: row.issue_id, _delete:true }); // ឬប្រើ apiDelete ប្រសិនបើ backend មាន
            ISSUES = ISSUES.filter(r=>String(r.issue_id)!==String(id));
            renderIssues(); setStatus('statusIssues','លុបរួចរាល់');
          }catch(err){ alert(err?.message||err); }
        }
      });
    }

    // boot for this page
    initDataEntry();
</script>
