<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>គ្រប់គ្រងការិយាល័យ | PHD Report</title>

  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="../../dist-assets/css/themes/lite-purple.min.css" rel="stylesheet"/>
</head>
<body>

<div class="main-content-wrap p-3">
  <h4 class="kh-head">គ្រប់គ្រងការិយាល័យ</h4>
  <button id="btnAdd" class="btn btn-primary btn-sm mb-2">+ បន្ថែម</button>
  <div id="alertBox" class="alert d-none"></div>
  <table class="table table-striped">
    <thead><tr><th>ID</th><th>ឈ្មោះ</th><th>សកម្មភាព</th></tr></thead>
    <tbody id="tbody"><tr><td colspan="3">កំពុងទាញ...</td></tr></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="depModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="depForm">
      <div class="modal-header">
        <h5 class="modal-title kh-head" id="mdlTitle">បន្ថែម</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="department_id"/>
        <label class="form-label">ឈ្មោះ</label>
        <input id="department_name" class="form-control" required/>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">បោះបង់</button>
        <button class="btn btn-primary" type="submit">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<script src="../../dist-assets/js/plugins/bootstrap.bundle.min.js"></script>
<script type="module">
  import { GAS_BASE, gasGet, gasPost } from '../../assets/js/config.js';
  import { getAuth } from '../../assets/js/app.auth.js';

  const auth=getAuth(); if(!auth) location.replace('../../login.html');
  const tbody=document.getElementById('tbody');
  const mdl=new bootstrap.Modal(document.getElementById('depModal'));

  function showAlert(msg,type='success'){
    const box=document.getElementById('alertBox');
    box.className='alert alert-'+type; box.textContent=msg;
    box.classList.remove('d-none'); setTimeout(()=>box.classList.add('d-none'),2500);
  }

  async function loadTable(){
    tbody.innerHTML='<tr><td colspan="3">កំពុងទាញ...</td></tr>';
    try{
      const res=await gasGet({route:'departments',op:'list',token:auth.token});
      console.log('📥 list',res);
      const rows=res.rows||[];
      if(!rows.length){ tbody.innerHTML='<tr><td colspan="3">គ្មានទិន្នន័យ</td></tr>'; return; }
      tbody.innerHTML=rows.map(r=>`
        <tr data-id="${r.department_id}">
          <td>${r.department_id}</td>
          <td>${r.department_name}</td>
          <td>
            <button class="btn btn-sm btn-link text-primary btn-edit">កែ</button>
            <button class="btn btn-sm btn-link text-danger btn-del">លុប</button>
          </td>
        </tr>`).join('');
      tbody.querySelectorAll('.btn-edit').forEach(b=>b.onclick=()=>openEdit(b.closest('tr').dataset.id,rows));
      tbody.querySelectorAll('.btn-del').forEach(b=>b.onclick=()=>doDelete(b.closest('tr').dataset.id));
    }catch(e){ tbody.innerHTML='<tr><td colspan="3" class="text-danger">'+e.message+'</td></tr>'; }
  }

  function openEdit(id,rows){
    const r=rows.find(x=>String(x.department_id)===String(id));
    document.getElementById('mdlTitle').textContent='កែប្រែ';
    document.getElementById('department_id').value=r.department_id;
    document.getElementById('department_name').value=r.department_name;
    mdl.show();
  }
  function openAdd(){
    document.getElementById('mdlTitle').textContent='បន្ថែម';
    document.getElementById('department_id').value='';
    document.getElementById('department_name').value='';
    mdl.show();
  }
  async function doDelete(id){
    if(!confirm('លុបមែនទេ?')) return;
    try{
      await gasPost({route:'departments',op:'delete',token:auth.token},{department_id:id});
      showAlert('លុបរួចរាល់'); loadTable();
    }catch(e){ showAlert(e.message,'danger'); }
  }

  document.getElementById('btnAdd').onclick=openAdd;
  document.getElementById('depForm').onsubmit=async e=>{
    e.preventDefault();
    const id=document.getElementById('department_id').value;
    const name=document.getElementById('department_name').value.trim();
    if(!name) return;
    const payload={department_name:name}; if(id) payload.department_id=Number(id);
    try{
      await gasPost({route:'departments',op:'upsert',token:auth.token},payload);
      mdl.hide(); showAlert('រក្សាទុករួចរាល់'); loadTable();
    }catch(e){ showAlert(e.message,'danger'); }
  };

  loadTable();
</script>
</body>
</html>
