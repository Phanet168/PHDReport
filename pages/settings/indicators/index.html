<!-- pages/settings/indicators/index.html -->
<div class="container-page">
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <h1 class="me-2 kh-head">សូចនាករ</h1>
    <ul>
      <li><a href="#/">Dashboard</a></li>
      <li>Settings</li>
      <li>Indicators</li>
    </ul>
  </div>
  <div class="separator-breadcrumb border-top"></div>

  <!-- Card: Table -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title kh-head m-0">បញ្ជីសូចនាករ</h4>
        <!-- ប៊ូតុងនេះ JS នឹងលាក់បើគ្មានសិទ្ធិ -->
        <button id="btnAdd" class="btn btn-primary btn-sm">
          <i class="i-Add"></i> បន្ថែម
        </button>
      </div>

      <div class="table-responsive">
        <table id="tblIndicators" class="display table table-striped" style="width:100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>ឈ្មោះសូចនាករ</th>
              <th>ប្រភេទ</th>
              <th>នាយកដ្ឋាន</th>
              <th style="width:120px;">សកម្មភាព</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add/Edit -->
<div class="modal fade" id="mdlIndicator" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="frmIndicator" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title kh-head">ព័ត៌មានសូចនាករ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="indicator_id" />

        <div class="mb-3">
          <label for="indicator_name" class="form-label">ឈ្មោះសូចនាករ <span class="text-danger">*</span></label>
          <input id="indicator_name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label for="indicator_type" class="form-label">ប្រភេទ</label>
          <input id="indicator_type" class="form-control" placeholder="ឧ. Output / Outcome / Process …" />
        </div>

        <div class="mb-3">
          <label for="department_id" class="form-label">នាយកដ្ឋាន</label>
          <select id="department_id" class="form-select"></select>
          <div class="form-text">Non-super ត្រូវចាក់សោរ (ប្រើ department របស់ខ្លួនដោយស្វ័យប្រវត្តិ)។</div>
        </div>

        <input type="hidden" id="unit_id" />
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">បោះបង់</button>
        <button class="btn btn-primary" type="submit">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<style>
  .container-page { max-width: 1100px; margin: 0 auto; }
  #tblIndicators td:last-child { white-space: nowrap; }
</style>

<script type="module">
  // សំខាន់៖ ប្រើ relative paths (កុំប្រើ '/assets/...')
  import { getAuth, isSuper } from './assets/js/app.auth.js';
  import { gasList, gasSave, gasDelete } from './assets/js/app.menu.js';

  // expose function សម្រាប់ router នៅ index.html
  window.initIndicators = initIndicators;

  async function initIndicators() {
    try {
      const $table = document.querySelector('#tblIndicators');
      const $btnAdd = document.getElementById('btnAdd');
      if (!$table) return;

      const auth       = getAuth();
      const superUser  = isSuper(auth);
      const ownDept    = auth?.department_id || null;
      const ownUnit    = auth?.unit_id || null;
      const canCreate  = superUser || String(auth?.role||'').toLowerCase() === 'dataentry';

      // 1) Departments (Super = ជ្រើសបាន / Non-super = ចាក់សោរ)
      const $depSel = document.getElementById('department_id');
      if ($depSel) {
        let depts = await gasList('departments').catch(() => []);
        if (!superUser && ownDept) {
          depts = depts.filter(d => String(d.department_id) === String(ownDept));
        }
        $depSel.innerHTML =
          `<option value="">— ជ្រើស —</option>` +
          depts.map(d => `<option value="\${d.department_id}">\${d.department_name}</option>`).join('');
        $depSel.disabled = !superUser;
        if (!superUser && ownDept) $depSel.value = ownDept;
      }

      // 2) Load data
      let [indicators, departments] = await Promise.all([
        gasList('indicators').catch(() => []),
        gasList('departments').catch(() => [])
      ]);
      const deptMap = Object.fromEntries(departments.map(d => [d.department_id, d.department_name]));

      // Non-super: filter តែនាយកដ្ឋានខ្លួន
      if (!superUser && ownDept) {
        indicators = indicators.filter(x => String(x.department_id) === String(ownDept));
      }

      // 3) DataTable (re-init safely)
      const $ = window.jQuery;
      const dt = $ ? $( $table ).DataTable({ destroy: true }) : null;
      if (!dt) return;

      dt.clear();
      indicators.forEach(ind => {
        dt.row.add([
          ind.indicator_id,
          ind.indicator_name,
          ind.indicator_type || '',
          deptMap[ind.department_id] || '',
          renderActions(ind, auth)
        ]);
      });
      dt.draw();

      // 4) Add button (role-aware)
      if ($btnAdd) {
        $btnAdd.style.display = canCreate ? '' : 'none';
        $btnAdd.onclick = canCreate ? () => {
          document.getElementById('frmIndicator').reset();
          document.getElementById('indicator_id').value = '';
          if (!superUser && ownDept) document.getElementById('department_id').value = ownDept;
          $('#mdlIndicator').modal('show');
        } : null;
      }

      // 5) Submit (Add/Update)
      $('#frmIndicator').off('submit').on('submit', async (e) => {
        e.preventDefault();
        if (!canCreate) return;

        const payload = {
          indicator_id   : document.getElementById('indicator_id').value || null,
          indicator_name : document.getElementById('indicator_name').value.trim(),
          indicator_type : document.getElementById('indicator_type').value.trim(),
          department_id  : superUser ? document.getElementById('department_id').value : ownDept,
          unit_id        : ownUnit || null
        };
        if (!payload.indicator_name) {
          alert('សូមបញ្ចូល ឈ្មោះសូចនាករ');
          return;
        }

        try {
          await gasSave('indicators', payload);     // server: op=upsert (+token)
          $('#mdlIndicator').modal('hide');
          await initIndicators();                   // reload table
        } catch (err) {
          alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
        }
      });

      // 6) Edit/Delete (delegate events)
      $('#tblIndicators')
        .off('click', '.btnEdit')
        .on('click', '.btnEdit', function () {
          const row = dt.row($(this).closest('tr')).data();
          const [id, name, type, deptName] = row;
          if (!canEditRow(auth, deptName, deptMap)) return;

          document.getElementById('indicator_id').value   = id;
          document.getElementById('indicator_name').value = name;
          document.getElementById('indicator_type').value = type;
          const depId = findDeptIdByName(deptName, deptMap) || ownDept || '';
          document.getElementById('department_id').value  = depId;

          $('#mdlIndicator').modal('show');
        });

      $('#tblIndicators')
        .off('click', '.btnDel')
        .on('click', '.btnDel', async function () {
          const row = dt.row($(this).closest('tr')).data();
          const [id, , , deptName] = row;
          if (!canCreate || !canEditRow(auth, deptName, deptMap)) return;

          if (confirm('តើចង់លុបធាតុនេះមែនទេ?')) {
            try {
              await gasDelete('indicators', 'indicator_id', id); // server: ?indicator_id=...
              await initIndicators();
            } catch (err) {
              alert('បរាជ័យលុប: ' + (err?.message || err));
            }
          }
        });
    } catch (err) {
      console.error('[Indicators] init failed:', err);
      alert('មិនអាចផ្ទុកទំព័រ Indicators: ' + (err?.message || err));
    }
  }

  /* ===== Helpers ===== */
  function renderActions(ind, auth) {
    const can = isSuper(auth)
      || (String(auth?.role||'').toLowerCase() === 'dataentry'
          && String(ind.department_id) === String(auth?.department_id));
    return can
      ? `<button class="btn btn-sm btn-warning btnEdit">កែ</button>
         <button class="btn btn-sm btn-danger btnDel">លុប</button>`
      : '';
  }

  function canEditRow(auth, deptName, map) {
    if (isSuper(auth)) return true;
    const isDE = String(auth?.role||'').toLowerCase() === 'dataentry';
    if (!isDE) return false;
    const depId = findDeptIdByName(deptName, map);
    return String(depId) === String(auth?.department_id);
  }

  function findDeptIdByName(name, map) {
    const pair = Object.entries(map).find(([, v]) => v === name);
    return pair ? pair[0] : null;
  }
</script>
