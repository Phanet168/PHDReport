<!-- pages/settings/indicators/index.html -->
<div class="settings-page">
  <div class="container-page">

    <!-- Page head -->
    <div class="page-head">
      <div class="d-flex align-items-center gap-2">
        <h1 class="kh-head h4 m-0">សូចនាករ</h1>
        <nav aria-label="breadcrumb" class="small">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a href="#/">Dashboard</a></li>
            <li class="breadcrumb-item">Settings</li>
            <li class="breadcrumb-item active" aria-current="page">Indicators</li>
          </ol>
        </nav>
      </div>
      <div class="separator-breadcrumb border-top"></div>
    </div>

    <!-- Body -->
    <div class="page-body">
      <div class="card shadow-sm centered-card w-100">
        <div class="card-body">

          <!-- Toolbar -->
<div class="toolbar mb-3">
  <h4 class="card-title kh-head m-0">បញ្ជីសូចនាករ</h4>

  <!-- Actions at right -->
  <div class="actions ms-auto">
    <div class="input-group input-group-sm">
      <input id="txtSearch" class="form-control" placeholder="ស្វែងរក...">
      <button id="btnAdd" class="btn btn-primary">
        <i class="i-Add"></i> បន្ថែម
      </button>
    </div>
  </div>
</div>


          <div class="table-responsive">
            <table id="tblIndicators" class="table table-striped table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:90px">ID</th>
                  <th>ឈ្មោះសូចនាករ</th>
                  <th style="width:160px">ប្រភេទ</th>
                  <th style="width:220px">ការិយាល័យ</th>
                  <th style="width:220px">ផ្នែក</th>
                  <th style="width:160px">សកម្មភាព</th>
                </tr>
              </thead>
              <tbody><!-- initIndicators() will render --></tbody>
            </table>
          </div>

          <div class="small text-muted mt-2" id="statusLine"></div>
        </div>
      </div>
    </div>

  </div>
</div>


<!-- Modal Add/Edit -->
<div class="modal fade" id="mdlIndicator" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="frmIndicator" novalidate>
      <div class="modal-header">
        <h5 class="modal-title kh-head">ព័ត៌មានសូចនាករ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="បិទ"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="indicator_id" />

        <div class="mb-3">
          <label for="indicator_name" class="form-label">ឈ្មោះសូចនាករ <span class="text-danger">*</span></label>
          <input id="indicator_name" class="form-control" required />
          <div class="invalid-feedback">សូមបញ្ចូលឈ្មោះសូចនាក់រ</div>
        </div>

        <div class="mb-3">
          <label for="indicator_type" class="form-label">ប្រភេទ</label>
          <input id="indicator_type" class="form-control" placeholder="ឧ. Output / Outcome / Process" />
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label for="department_id" class="form-label">ការិយាល័យ</label>
            <select id="department_id" class="form-select"></select>
            <div class="form-text">មិនមែន super នឹងត្រូវចាក់សោរនៅការិយាល័យខ្លួនឯង</div>
          </div>
          <div class="col-md-6">
            <label for="unit_id" class="form-label">ផ្នែក</label>
            <select id="unit_id" class="form-select">
              <option value="">— ជ្រើសផ្នែក —</option>
            </select>
            <div class="form-text">មិនមែន super នឹងត្រូវចាក់សោរផ្នែកខ្លួនឯង</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">បោះបង់</button>
        <button class="btn btn-primary" type="submit" id="btnSave">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<style>
  .settings-page{flex:1 1 auto; display:flex; flex-direction:column; min-height:0;}
  .container-page{width:100%; max-width:1280px; margin:0 auto; padding:16px 18px 12px; display:flex; flex-direction:column; min-height:0;}
  .page-head{display:flex; flex-direction:column; gap:10px; margin-bottom:12px;}
  .page-body{flex:1 1 auto; min-height:0; display:flex; justify-content:center;}
  .centered-card{max-width:1200px; border:1px solid #eef0f4; border-radius:14px;}
  .table thead th{ white-space:nowrap; }
  #tblIndicators td:last-child{ white-space:nowrap; }
  .skel{ position:relative; overflow:hidden; background:#f3f4f6; height:44px; }
  .skel::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
    animation:shimmer 1.1s infinite }
  @keyframes shimmer{ 100%{ transform:translateX(100%);} }
  /* Spinner នៅក្នុង select */
.select-loading { position: relative; }
.select-loading::after{
  content:""; position:absolute; right:12px; top:50%;
  width:16px; height:16px; margin-top:-8px;
  border-radius:50%; border:2px solid #cfd3d7; border-top-color:#6f42c1;
  animation:spin .8s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg) } }

/* toolbar layout: title left, search+add right (equal height) */
.toolbar{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
.toolbar .actions{min-width:260px;}

/* make it responsive on small screens: full width row */
@media (max-width: 576px){
  .toolbar{gap:8px;}
  .toolbar .actions{min-width:0; width:100%;}
  .toolbar .input-group{width:100%;}
}

/* align action column to the right for neat look */
#tblIndicators td:last-child{ text-align:right; white-space:nowrap; }
#tblIndicators th:last-child{ text-align:right; }
/* កំណត់ទំហំ/ទីតាំងជួរឈរ សកម្មភាព */
#tblIndicators th:last-child,
#tblIndicators td.td-actions{
  width:170px;                 /* ប្ដូរទំហំតាមចិត្ត */
  padding-right:12px;
}
#tblIndicators td.td-actions .actions-right{
  display:flex;
  justify-content:flex-end;    /* ប៊ូតុងទៅស្តាំ */
  gap:.45rem;
}



</style>

<script type="module">
  import { getAuth, isSuper } from '../../../assets/js/app.auth.js';
  import { gasList, gasSave, gasDelete, ID_FIELDS } from '../../../assets/js/app.menu.js';

  // ---- Modal helper: works with BS5/BS4/no-BS
  function makeModal(id){
    const el = document.getElementById(id);
    if (!el) return null;
    if (window.bootstrap && bootstrap.Modal){
      let inst = bootstrap.Modal.getInstance ? bootstrap.Modal.getInstance(el) : null;
      if (!inst) inst = new bootstrap.Modal(el, {backdrop:true, keyboard:true, focus:true});
      return { show:()=>inst.show(), hide:()=>inst.hide() };
    }
    if (window.jQuery && jQuery.fn && jQuery.fn.modal){
      const $el = jQuery(el);
      return { show:()=>$el.modal('show'), hide:()=>$el.modal('hide') };
    }
    return { show(){ el.style.display='block'; }, hide(){ el.style.display='none'; } };
  }

  // ====== Page logic ======
  const $status = msg => (document.getElementById('statusLine').textContent = msg || '');

  const auth = getAuth();
  const SUPER = isSuper(auth);
  const modal = makeModal('mdlIndicator');

  const tbl   = document.getElementById('tblIndicators');
  const tbody = tbl.querySelector('tbody');
  const frm   = document.getElementById('frmIndicator');
  const btnAdd= document.getElementById('btnAdd');

  const selDept = document.getElementById('department_id');
  const selUnit = document.getElementById('unit_id');
  const txtSearch = document.getElementById('txtSearch');

  let CACHE = {
    departments: [],
    unitsByDept: {},   // { [depId]: [units] }
    indicators:  []
  };
  let FILTER_Q = '';

  // skeleton rows
  tbody.innerHTML = '';
  for (let i=0;i<4;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" class="skel"></td>`;
    tbody.appendChild(tr);
  }

  init().catch(err=>{
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">បរាជ័យផ្ទុកទិន្នន័យ</td></tr>`;
    $status('បរាជ័យផ្ទុកទិន្នន័យ');
  });

  async function init(){
    $status('កំពុងផ្ទុកទិន្នន័យ…');
    let [depts, inds] = await Promise.all([
      gasList('departments'),
      gasList('indicators')
    ]);

    // scope for non-super
    if (!SUPER && auth?.department_id){
      depts = depts.filter(d => String(d.department_id) === String(auth.department_id));
      inds  = inds.filter(r => String(r.department_id) === String(auth.department_id));
    }

    CACHE.departments = depts;
    CACHE.indicators  = inds;

    await fillDeptSelect(SUPER ? '' : auth?.department_id);
    await fillUnitSelect(selDept.value || auth?.department_id, SUPER ? '' : auth?.unit_id);

    renderTable();
    $status(`បានផ្ទុក ${inds.length} សូចនាករ`);
  }

  // --- Select helpers
  async function ensureUnitsLoaded(depId){
    const key = String(depId||'');
    if (!key) { CACHE.unitsByDept[key] = []; return; }
    if (CACHE.unitsByDept[key]) return;
    const rows = await gasList('units', { department_id: key });
    CACHE.unitsByDept[key] = rows || [];
  }

  async function fillDeptSelect(selected){
    selDept.innerHTML = `<option value="">— ជ្រើស —</option>` +
      CACHE.departments.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
    if (selected) selDept.value = selected;
    selDept.disabled = !SUPER; // lock non-super
  }

  async function fillUnitSelect(depId, selected){
    await ensureUnitsLoaded(depId);
    const units = CACHE.unitsByDept[String(depId||'')] || [];
    selUnit.innerHTML = `<option value="">— ជ្រើស —</option>` +
      units.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
    if (selected) selUnit.value = selected;
    selUnit.disabled = !SUPER; // lock non-super
  }

  // department change (super can switch → reload units)
  selDept.addEventListener('change', async ()=>{
    await fillUnitSelect(selDept.value, '');
  });

  // --- Table
  function canEditRow(ind){
    if (SUPER) return true;
    return String(ind.department_id) === String(auth?.department_id)
        && String(ind.unit_id||'')  === String(auth?.unit_id||'');
  }

  function renderTable(){
  const deptName = Object.fromEntries(CACHE.departments.map(d => [String(d.department_id), d.department_name]));
  const unitNameByDept = {};
  for (const [depId, units] of Object.entries(CACHE.unitsByDept)){
    unitNameByDept[depId] = Object.fromEntries((units || []).map(u => [String(u.unit_id), u.unit_name]));
  }

  const rows = CACHE.indicators.filter(r => {
    if (!FILTER_Q) return true;
    return JSON.stringify(r).toLowerCase().includes(FILTER_Q);
  });

  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
    return;
  }

  const frag = document.createDocumentFragment();
  for (const ind of rows){
    const depId = String(ind.department_id || '');
    const unitId = String(ind.unit_id || '');

    const actions = canEditRow(ind)
      ? `<div class="actions-right">
           <button class="btn btn-sm btn-warning" data-act="edit" data-id="${ind.indicator_id}">កែ</button>
           <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${ind.indicator_id}">លុប</button>
         </div>`
      : `<div class="actions-right"><span class="text-muted">—</span></div>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${ind.indicator_id}</td>
      <td>${ind.indicator_name}</td>
      <td>${ind.indicator_type || ''}</td>
      <td>${deptName[depId] || ''}</td>
      <td>${(unitNameByDept[depId] || {})[unitId] || ''}</td>
      <td class="td-actions">${actions}</td>`;
    frag.appendChild(tr);
  }
  tbody.innerHTML = '';
  tbody.appendChild(frag);
}

  const deptName = Object.fromEntries(CACHE.departments.map(d=>[String(d.department_id), d.department_name]));
  const unitNameByDept = {};
  for (const [depId, units] of Object.entries(CACHE.unitsByDept)){
    unitNameByDept[depId] = Object.fromEntries((units||[]).map(u=>[String(u.unit_id), u.unit_name]));
  }

  const rows = CACHE.indicators.filter(r=>{
    if (!FILTER_Q) return true;
    return JSON.stringify(r).toLowerCase().includes(FILTER_Q);
  });

  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
    return;
  }

  const frag = document.createDocumentFragment();
  for (const ind of rows){
    const depId = String(ind.department_id||'');
    const unitId= String(ind.unit_id||'');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${ind.indicator_id}</td>
      <td>${ind.indicator_name}</td>
      <td>${ind.indicator_type||''}</td>
      <td>${deptName[depId] || ''}</td>
      <td>${(unitNameByDept[depId]||{})[unitId] || ''}</td>
      <td>
        <div class="actions-right">
          <button class="btn btn-sm btn-warning" data-act="edit" data-id="${ind.indicator_id}">កែ</button>
          <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${ind.indicator_id}">លុប</button>
        </div>
      </td>`;
    frag.appendChild(tr);
  }
  tbody.innerHTML = '';
  tbody.appendChild(frag);
}

  // search
  if (txtSearch){
    txtSearch.addEventListener('input', e=>{
      FILTER_Q = String(e.target.value||'').trim().toLowerCase();
      renderTable();
    });
  }

  // Add
  btnAdd.addEventListener('click', async ()=>{
    frm.reset();
    document.getElementById('indicator_id').value = '';
    // lock to own dep/unit for non-super
    const dep = SUPER ? (selDept.value || '') : (auth?.department_id || '');
    await fillDeptSelect(dep);
    await fillUnitSelect(dep, SUPER ? '' : (auth?.unit_id || ''));
    modal && modal.show();
  });

  // Edit/Delete delegate
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const id  = btn.getAttribute('data-id');
    const row = CACHE.indicators.find(x=>String(x.indicator_id)===String(id));
    if (!row) return;

    if (btn.dataset.act === 'edit'){
      document.getElementById('indicator_id').value   = row.indicator_id;
      document.getElementById('indicator_name').value = row.indicator_name || '';
      document.getElementById('indicator_type').value = row.indicator_type || '';

      const dep = String(row.department_id||'');
      await fillDeptSelect(SUPER ? dep : (auth?.department_id || dep));
      await fillUnitSelect(dep, String(row.unit_id||''));
      modal && modal.show();
    }

    if (btn.dataset.act === 'del'){
      if (!confirm('តើចង់លុបធាតុនេះមែនទេ?')) return;
      try{
        await gasDelete('indicators', ID_FIELDS.indicators, row.indicator_id);
        CACHE.indicators = CACHE.indicators.filter(x=>String(x.indicator_id)!==String(id));
        renderTable();
        $status('លុបរួចរាល់');
      }catch(err){
        console.error(err);
        alert('បរាជ័យលុប: ' + (err?.message || err));
      }
    }
  });

  // Save
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      indicator_id   : document.getElementById('indicator_id').value || null,
      indicator_name : document.getElementById('indicator_name').value.trim(),
      indicator_type : document.getElementById('indicator_type').value.trim(),
      department_id  : SUPER ? selDept.value : (auth?.department_id || ''),
      unit_id        : SUPER ? selUnit.value : (auth?.unit_id || '')
    };
    if (!payload.indicator_name){
      const el = document.getElementById('indicator_name');
      el.classList.add('is-invalid'); el.focus(); return;
    } else document.getElementById('indicator_name').classList.remove('is-invalid');

    const btn = document.getElementById('btnSave');
    const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'កំពុងរក្សាទុក…';
    try{
      const saved = await gasSave('indicators', payload);
      const row = saved.row || saved;
      const i = CACHE.indicators.findIndex(x=>String(x.indicator_id)===String(row.indicator_id));
      if (i>=0) CACHE.indicators[i]=row; else CACHE.indicators.push(row);

      // ensure units cache contains the row's unit (in case just added)
      await ensureUnitsLoaded(row.department_id);
      renderTable();
      modal && modal.hide();
      $status('រក្សាទុករួចរាល់');
    }catch(err){
      console.error(err);
      alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
    }finally{
      btn.disabled = false; btn.innerHTML = old;
    }
  });
</script>
