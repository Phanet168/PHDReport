<!-- pages/settings/indicators/index.html.html -->
<div class="settings-page">
  <div class="container-page">

    <!-- Page head -->
    <div class="page-head">
      <div class="d-flex align-items-center gap-2">
        <h1 class="kh-head h4 m-0">សូចនាករ</h1>
        <nav aria-label="breadcrumb" class="small">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a href="#/">Dashboard</a></li>
            <li class="breadcrumb-item">Settings</li>
            <li class="breadcrumb-item active" aria-current="page">Indicators</li>
          </ol>
        </nav>
      </div>
      <div class="separator-breadcrumb border-top"></div>
    </div>

    <!-- Body -->
    <div class="page-body">
      <div class="card shadow-sm centered-card w-100">
        <div class="card-body">

          <!-- Toolbar -->
          <div class="toolbar mb-3">
            <h4 class="card-title kh-head m-0">បញ្ជីសូចនាករ</h4>
            <div class="actions ms-auto">
              <div class="input-group input-group-sm">
                <input id="txtSearch" class="form-control" placeholder="ស្វែងរក...">
                <button id="btnAdd" class="btn btn-primary">
                  <i class="i-Add"></i> បន្ថែម
                </button>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="table-responsive">
            <table id="tblIndicators" class="table table-striped table-hover align-middle mb-0">
              <thead>
              <tr>
                <th style="width:80px">ID</th>
                <th>ឈ្មោះសូចនាករ</th>
                <th style="width:160px">ប្រភេទ</th>
                <th style="width:200px">ជំពូក</th>
                <th style="width:200px">ផ្នែក</th>
                <th style="width:200px">ម្ចាស់ (Owner)</th>
                <th style="width:160px" class="text-end">សកម្មភាព</th>
              </tr>
              </thead>
              <tbody>
              <tr><td colspan="7" class="skel"></td></tr>
              <tr><td colspan="7" class="skel"></td></tr>
              <tr><td colspan="7" class="skel"></td></tr>
              <tr><td colspan="7" class="skel"></td></tr>
              </tbody>
            </table>
          </div>

          <div class="small text-muted mt-2" id="statusLine"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal Add/Edit -->
<div class="modal fade" id="mdlIndicator" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="frmIndicator" novalidate>
      <div class="modal-header">
        <h5 class="modal-title kh-head">ព័ត៌មានសូចនាករ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="បិទ"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="indicator_id" />

        <div class="mb-3">
          <label class="form-label">ឈ្មោះសូចនាករ <span class="text-danger">*</span></label>
          <input id="indicator_name" class="form-control" required />
          <div class="invalid-feedback">សូមបញ្ចូលឈ្មោះសូចនាករ</div>
        </div>

        <div class="mb-3">
          <label class="form-label">ប្រភេទ</label>
          <input id="indicator_type" class="form-control" placeholder="ឧ. Output / Outcome / Process" />
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">ជំពូក</label>
            <select id="department_id" class="form-select"></select>
            <div class="form-text">មិនមែន SUPER ចាក់សោរ​ត្រឹមជំពូកខ្លួន</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">ផ្នែក</label>
            <select id="unit_id" class="form-select">
              <option value="">— ជ្រើសផ្នែក —</option>
            </select>
            <div class="form-text">មិនមែន SUPER ចាក់សោរ​ផ្នែកខ្លួន</div>
          </div>
        </div>

        <!-- Owner (SUPER only editable) -->
        <div class="mt-3">
          <label class="form-label">ម្ចាស់ (Owner)</label>
          <select id="owner_id" class="form-select">
            <option value="">— ជ្រើសម្ចាស់ —</option>
          </select>
          <div class="form-text">SUPER អាច delegate សូចនាករ អោយអ្នកប្រើណាមួយ</div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">បោះបង់</button>
        <button class="btn btn-primary" type="submit" id="btnSave">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<style>
  .settings-page{flex:1 1 auto; display:flex; flex-direction:column; min-height:0;}
  .container-page{width:100%; max-width:1280px; margin:0 auto; padding:16px 18px 12px; display:flex; flex-direction:column; min-height:0;}
  .page-head{display:flex; flex-direction:column; gap:10px; margin-bottom:12px;}
  .page-body{flex:1 1 auto; min-height:0; display:flex; justify-content:center;}
  .centered-card{max-width:1200px; border:1px solid #eef0f4; border-radius:14px;}
  .table thead th{ white-space:nowrap; }
  .skel{ position:relative; overflow:hidden; background:#f3f4f6; height:44px; }
  .skel::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
    animation:shimmer 1.1s infinite }
  @keyframes shimmer{ 100%{ transform:translateX(100%);} }

  .toolbar{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
  .toolbar .actions{min-width:260px;}
  @media (max-width: 576px){
    .toolbar .actions{min-width:0; width:100%;}
    .toolbar .input-group{width:100%;}
  }

  #tblIndicators th:last-child{ text-align:right; }
  #tblIndicators td.td-actions{ text-align:right; width:170px; }
  #tblIndicators td.td-actions .actions-right{ display:flex; justify-content:flex-end; gap:.45rem; }

  .select-loading select{ background-image: repeating-linear-gradient(45deg, #f3f4f6, #f3f4f6 10px, #fff 10px, #fff 20px); }
</style>

<script type="module">
  import { getAuth, isSuper } from '../../../assets/js/app.auth.js';
  import { gasList, gasSave, gasDelete, ID_FIELDS } from '../../../assets/js/app.menu.js';

  // modal helper
  function makeModal(id){
    const el = document.getElementById(id);
    if (!el) return null;
    if (window.bootstrap?.Modal){
      let inst = bootstrap.Modal.getInstance ? bootstrap.Modal.getInstance(el) : null;
      if (!inst) inst = new bootstrap.Modal(el, {backdrop:true, keyboard:true, focus:true});
      return { show:()=>inst.show(), hide:()=>inst.hide() };
    }
    return { show(){ el.style.display='block'; }, hide(){ el.style.display='none'; } };
  }
  const $status = msg => (document.getElementById('statusLine').textContent = msg || '');

  /* ======================= Indicators ======================= */
  async function initIndicators(){
    const auth   = getAuth();
    const SUPER  = isSuper(auth);

    const table   = document.getElementById('tblIndicators');
    const tbody   = table?.querySelector('tbody');
    const btnAdd  = document.getElementById('btnAdd');
    const frm     = document.getElementById('frmIndicator');
    const selDept = document.getElementById('department_id');
    const selUnit = document.getElementById('unit_id');
    const selOwner= document.getElementById('owner_id');
    const btnSave = document.getElementById('btnSave');
    const modal   = makeModal('mdlIndicator');

    if (!table || !tbody || !btnAdd || !frm || !selDept || !selUnit || !btnSave) return;

    let CACHE = { departments:[], unitsAll:[], usersAll:[], indicators:[], unitsByDep:new Map() };
    let MAPS  = { deptName:{}, unitName:{}, userName:{} };

    const setStatus = m=>{ const el=document.getElementById('statusLine'); if(el) el.textContent=m||''; };
    const skel=()=>{ tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7" class="skel"></td>`; tbody.appendChild(tr);} };
    skel();

    try{
      let [depts, inds] = await Promise.all([
        gasList('departments'),
        gasList('indicators')
      ]);

      if (!SUPER && auth?.department_id){
        const depId=String(auth.department_id);
        depts = depts.filter(d=>String(d.department_id)===depId);
        inds  = inds.filter(r=>String(r.department_id)===depId);
      }

      let unitsAll = SUPER ? await gasList('units')
                           : (auth?.department_id ? await gasList('units',{department_id:auth.department_id}) : []);

      let usersAll=[];
      if (selOwner){
        if (SUPER) usersAll = await gasList('users');
        else usersAll=[{user_id:auth?.user_id,user_name:auth?.user_name,full_name:auth?.full_name,department_id:auth?.department_id,unit_id:auth?.unit_id}];
      }

      CACHE.departments=depts;
      CACHE.unitsAll=unitsAll||[];
      CACHE.usersAll=usersAll||[];
      CACHE.indicators=inds;

      MAPS.deptName = Object.fromEntries(CACHE.departments.map(d=>[String(d.department_id),d.department_name]));
      MAPS.unitName = Object.fromEntries(CACHE.unitsAll.map(u=>[String(u.unit_id),u.unit_name]));
      MAPS.userName = Object.fromEntries(CACHE.usersAll.map(u=>[String(u.user_id),(u.full_name||u.user_name||('User#'+u.user_id))]));

      await fillDeptSelect(SUPER?'':auth?.department_id);
      await fillUnitSelect(SUPER?selDept.value:auth?.department_id, SUPER?'':auth?.unit_id);

      // owner select
      const usersById=Object.fromEntries((CACHE.usersAll||[]).map(u=>[String(u.user_id),u]));
      if (selOwner){
        if (SUPER){
          selOwner.innerHTML=`<option value="">— ជ្រើសម្ចាស់ —</option>`+
            CACHE.usersAll.map(u=>`<option value="${u.user_id}">${MAPS.userName[String(u.user_id)]}</option>`).join('');
          selOwner.disabled=false;

          // auto align dep/unit when owner changes
          selOwner.addEventListener('change', async ()=>{
            const u=usersById[String(selOwner.value||'')]; if(!u) return;
            selDept.value=u.department_id||'';
            selDept.disabled=false;
            await fillUnitSelect(u.department_id, u.unit_id||'');
            selUnit.disabled=false;
            setStatus(`Aligned to ${u.full_name||u.user_name}`);
          });
        } else {
          selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`;
          selOwner.disabled=true;
        }
      }

      renderTable();
      setStatus(`បានផ្ទុក ${inds.length} សូចនាករ`);
    }catch(e){
      console.error(e);
      tbody.innerHTML=`<tr><td colspan="7" class="text-center text-danger py-4">បរាជ័យផ្ទុកទិន្នន័យ</td></tr>`;
      setStatus('បរាជ័យផ្ទុកទិន្នន័យ');
    }

    async function fillDeptSelect(selected){
      selDept.innerHTML=`<option value="">— ជ្រើសជំពូក —</option>`+
        CACHE.departments.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
      if(selected) selDept.value=selected;
      selDept.disabled=!SUPER;
    }
    async function fillUnitSelect(depId,selected){
      selUnit.innerHTML=`<option value="">— ជ្រើសផ្នែក —</option>`;
      if(!depId){ selUnit.disabled=true; return; }
      let units=CACHE.unitsByDep.get(String(depId));
      if(!units){
        const fromAll=CACHE.unitsAll.filter(u=>String(u.department_id)===String(depId));
        units=fromAll.length?fromAll:await gasList('units',{department_id:depId});
        CACHE.unitsByDep.set(String(depId),units);
        for(const u of units) MAPS.unitName[String(u.unit_id)]=u.unit_name;
      }
      selUnit.innerHTML=`<option value="">— ជ្រើសផ្នែក —</option>`+(units||[]).map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
      if(selected) selUnit.value=selected;
      selUnit.disabled=!SUPER;
    }

    function canEditRow(ind){
      if(SUPER) return true;
      return String(ind.department_id)===String(auth?.department_id||'')
          && String(ind.unit_id||'')===String(auth?.unit_id||'')
          && String(ind.owner_id||'')===String(auth?.user_id||'');
    }

    function renderTable(){
      const q = String(document.getElementById('txtSearch')?.value||'').trim().toLowerCase();
      const rows = CACHE.indicators.filter(r => !q || JSON.stringify(r).toLowerCase().includes(q));
      if(!rows.length){
        tbody.innerHTML=`<tr><td colspan="7" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
        return;
      }
      const frag=document.createDocumentFragment();
      for(const ind of rows){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${ind.indicator_id}</td>
          <td>${ind.indicator_name||''}</td>
          <td>${ind.indicator_type||''}</td>
          <td>${MAPS.deptName[String(ind.department_id)]||''}</td>
          <td>${MAPS.unitName[String(ind.unit_id)]||''}</td>
          <td>${MAPS.userName[String(ind.owner_id)]||''}</td>
          <td class="td-actions text-end">
            <div class="actions-right">
              ${canEditRow(ind)
                ? `<button class="btn btn-sm btn-warning" data-act="edit" data-id="${ind.indicator_id}">កែ</button>
                   <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${ind.indicator_id}">លុប</button>`
                : `<span class="text-muted">—</span>`}
            </div>
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML=''; tbody.appendChild(frag);
    }

    // events
    document.getElementById('txtSearch')?.addEventListener('input', renderTable);
    selDept.addEventListener('change', e=>fillUnitSelect(e.target.value,''));

    btnAdd.addEventListener('click',async()=>{
      frm.reset(); document.getElementById('indicator_id').value='';
      if(SUPER){
        selDept.disabled=false; await fillUnitSelect(selDept.value,'');
        if(selOwner){ selOwner.disabled=false; selOwner.value=''; }
      }else{
        selDept.value=auth?.department_id||''; selDept.disabled=true;
        await fillUnitSelect(auth?.department_id,auth?.unit_id); selUnit.disabled=true;
        if(selOwner){
          selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`;
          selOwner.disabled=true;
        }
      }
      modal?.show();
    });

    tbody.addEventListener('click',async e=>{
      const btn=e.target.closest('button[data-act]'); if(!btn) return;
      const id=btn.getAttribute('data-id');
      const row=CACHE.indicators.find(x=>String(x.indicator_id)===String(id));
      if(!row) return;

      if(btn.dataset.act==='edit'){
        if(!canEditRow(row) && !SUPER) return alert('Permission denied');
        frm.reset();
        document.getElementById('indicator_id').value=row.indicator_id;
        document.getElementById('indicator_name').value=row.indicator_name||'';
        document.getElementById('indicator_type').value=row.indicator_type||'';
        selDept.value=row.department_id||''; if(!SUPER) selDept.disabled=true;
        await fillUnitSelect(row.department_id,row.unit_id||''); if(!SUPER) selUnit.disabled=true;
        if(selOwner){
          if(SUPER){ selOwner.value=row.owner_id||''; selOwner.disabled=false; }
          else{ selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`; selOwner.disabled=true; }
        }
        modal?.show();
      }

      if(btn.dataset.act==='del'){
        if(!canEditRow(row) && !SUPER) return alert('Permission denied');
        if(!confirm('លុបមែនទេ?')) return;
        try{
          await gasDelete('indicators',ID_FIELDS.indicators,row.indicator_id);
          CACHE.indicators=CACHE.indicators.filter(x=>String(x.indicator_id)!==String(id));
          renderTable(); $status('លុបរួចរាល់');
        }catch(err){ alert('បរាជ័យលុប: '+(err?.message||err)); }
      }
    });

    frm.addEventListener('submit',async e=>{
      e.preventDefault();
      const payload={
        indicator_id  : document.getElementById('indicator_id').value||null,
        indicator_name: document.getElementById('indicator_name').value.trim(),
        indicator_type: document.getElementById('indicator_type').value.trim(),
        department_id : SUPER?selDept.value:(auth?.department_id||''),
        unit_id       : SUPER?selUnit.value:(auth?.unit_id||''),
        owner_id      : SUPER?(selOwner.value||''):(auth?.user_id||'')
      };
      const nameEl=document.getElementById('indicator_name');
      nameEl.classList.toggle('is-invalid',!payload.indicator_name);
      if(!payload.indicator_name) return;

      const old=btnSave.innerHTML; btnSave.disabled=true; btnSave.innerHTML='កំពុងរក្សាទុក…';
      try{
        const saved=await gasSave('indicators',payload);
        const row=saved.row||saved;
        const i=CACHE.indicators.findIndex(x=>String(x.indicator_id)===String(row.indicator_id));
        if(i>=0) CACHE.indicators[i]=row; else CACHE.indicators.push(row);
        renderTable(); modal?.hide(); $status('រក្សាទុករួចរាល់');
      }catch(err){ alert('បរាជ័យរក្សាទុក: '+(err?.message||err)); }
      finally{ btnSave.disabled=false; btnSave.innerHTML=old; }
    });
  }

  // boot
  initIndicators();
</script>
