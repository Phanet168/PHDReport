<!-- pages/settings/periods/index.html -->
<div class="settings-page">
    <div class="container-page">

        <!-- Page head -->
        <div class="page-head">
            <div class="d-flex align-items-center gap-2">
                <h1 class="kh-head h4 m-0">រយៈពេល (Periods)</h1>
                <nav aria-label="breadcrumb" class="small">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="#/">Dashboard</a></li>
                        <li class="breadcrumb-item">Settings</li>
                        <li class="breadcrumb-item active" aria-current="page">Periods</li>
                    </ol>
                </nav>
            </div>
            <div class="separator-breadcrumb border-top"></div>
        </div>

        <!-- Body -->
        <div class="page-body">
            <div class="card shadow-sm centered-card w-100">
                <div class="card-body">

                    <!-- Toolbar -->
                    <div class="toolbar mb-3">
                        <h4 class="card-title kh-head m-0">បញ្ជីរយៈពេល</h4>
                        <div class="actions ms-auto">
                            <div class="input-group input-group-sm" style="gap:8px">
                                <input id="txtSearch" class="form-control" placeholder="ស្វែងរក...">
                                <input id="yearInput" class="form-control" type="number" style="max-width:120px" />
                                <button id="btnFilterYear" class="btn btn-outline-secondary">Filter</button>
                                <button id="btnGen" class="btn btn-primary">
                                    <i class="i-Add"></i> Generate Year
                                </button>
                            </div>
                            <div class="form-text text-end">Generate មានសិទ្ធិ <em>SUPER</em> ប៉ុណ្ណោះ</div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table id="tblPeriods" class="table table-striped table-hover align-middle mb-0">
                            <thead>
                            <tr>
                                <th style="width:160px">Period ID</th>
                                <th>ឈ្មោះ</th>
                                <th style="width:100px">Year</th>
                                <th style="width:100px">Month</th>
                                <th style="width:160px">សកម្មភាព</th>
                            </tr>
                            </thead>
                            <tbody><!-- render here --></tbody>
                        </table>
                    </div>

                    <div id="statusPeriods" class="small text-muted mt-2"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    .settings-page{flex:1 1 auto; display:flex; flex-direction:column; min-height:0;}
    .container-page{width:100%; max-width:1280px; margin:0 auto; padding:16px 18px 12px; display:flex; flex-direction:column; min-height:0;}
    .page-head{display:flex; flex-direction:column; gap:10px; margin-bottom:12px;}
    .page-body{flex:1 1 auto; min-height:0; display:flex; justify-content:center;}
    .centered-card{max-width:1200px; border:1px solid #eef0f4; border-radius:14px;}
    .table thead th{ white-space:nowrap; }
    .skel{ position:relative; overflow:hidden; background:#f3f4f6; height:44px; }
    .skel::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
      animation:shimmer 1.1s infinite }
    @keyframes shimmer{ 100%{ transform:translateX(100%);} }

    .toolbar{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    .toolbar .actions{min-width:320px;}
    @media (max-width: 576px){
      .toolbar{gap:8px;}
      .toolbar .actions{min-width:0; width:100%;}
      .toolbar .input-group{width:100%;}
    }

    #tblPeriods th:last-child{ text-align:right; }
    #tblPeriods td.td-actions{ text-align:right; width:170px; }
    #tblPeriods td.td-actions .actions-right{ display:flex; justify-content:flex-end; gap:.45rem; }
</style>

<script type="module">
    import { getAuth, isSuper } from '../../../assets/js/app.auth.js';
    import { gasList, gasDelete } from '../../../assets/js/app.menu.js';
    import { GAS_BASE } from '../../../assets/js/config.js';

    const $status = (m)=> document.getElementById('statusPeriods').textContent = m || '';

    const auth  = getAuth();
    const SUPER = isSuper(auth);

    const tbl       = document.getElementById('tblPeriods');
    const tbody     = tbl.querySelector('tbody');
    const txtSearch = document.getElementById('txtSearch');
    const yearInput = document.getElementById('yearInput');
    const btnFilter = document.getElementById('btnFilterYear');
    const btnGen    = document.getElementById('btnGen');

    let PERIODS = [];
    let FILTER_Q = '';
    let FILTER_YEAR = new Date().getFullYear();

    yearInput.value = FILTER_YEAR;

    // skeleton
    tbody.innerHTML = '';
    for (let i=0;i<6;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" class="skel"></td>`;
      tbody.appendChild(tr);
    }

    init().catch(err=>{
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">បរាជ័យផ្ទុកទិន្នន័យ</td></tr>`;
      $status('បរាជ័យផ្ទុកទិន្នន័យ');
    });

    async function init(){
      $status('កំពុងផ្ទុកទិន្នន័យ…');
      PERIODS = await gasList('periods').catch(()=>[]);
      renderTable();
      $status(`បានផ្ទុក ${PERIODS.length} រយៈពេល`);
      if (!SUPER) btnGen?.classList.add('d-none'); // Generate SUPER only
    }

    function renderTable(){
      const rows = PERIODS
        .filter(r => !FILTER_YEAR || String(r.year) === String(FILTER_YEAR))
        .filter(r => !FILTER_Q || JSON.stringify(r).toLowerCase().includes(FILTER_Q));

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const p of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.period_id}</td>
          <td>${p.period_name || ''}</td>
          <td>${p.year ?? ''}</td>
          <td>${p.month ?? ''}</td>
          <td class="td-actions">
            <div class="actions-right">
              ${SUPER
                ? `<button class="btn btn-sm btn-danger" data-act="del" data-id="${p.period_id}">លុប</button>`
                : `<span class="text-muted">—</span>`}
            </div>
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);
    }

    // Search + filter
    txtSearch?.addEventListener('input', e=>{
      FILTER_Q = String(e.target.value||'').trim().toLowerCase();
      renderTable();
    });
    btnFilter?.addEventListener('click', ()=>{
      FILTER_YEAR = Number(yearInput.value)||'';
      renderTable();
    });

    // Delete (SUPER)
    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act="del"]');
      if (!btn) return;
      if (!SUPER) return;
      const id = btn.getAttribute('data-id');
      if (!confirm('លុបរយៈពេលនេះមែនទេ?')) return;
      try{
        await gasDelete('periods', 'period_id', id);
        PERIODS = PERIODS.filter(x=>String(x.period_id)!==String(id));
        renderTable();
        $status('លុបរួចរាល់');
      }catch(err){
        console.error(err);
        alert('បរាជ័យលុប: '+(err?.message||err));
      }
    });

    // Generate year (SUPER)
    btnGen?.addEventListener('click', async ()=>{
      if (!SUPER) return;
      const y = Number(yearInput.value)||new Date().getFullYear();
      if (!confirm(`បង្កើត periods សម្រាប់ឆ្នាំ ${y} មែនទេ?`)) return;

      // POST /exec?api=1&route=period&op=generate&year=YYYY
      const u = new URL(GAS_BASE);
      if (!u.searchParams.has('api')) u.searchParams.set('api','1');
      u.searchParams.set('route','period');
      u.searchParams.set('op','generate');
      u.searchParams.set('year', String(y));

      // token (optional here, but good to include)
      const tok = auth?.token || '';
      if (tok) u.searchParams.set('token', tok);

      try{
        $status('កំពុងបង្កើត…');
        const r = await fetch(u.toString(), {
          method:'POST',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ token: tok })
        });
        const text = await r.text();
        if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText} — ${text||'(no body)'}`);
        const j = text ? JSON.parse(text) : {};
        if (j && j.ok === false) throw new Error(j.error || 'API error');

        // reload list
        PERIODS = await gasList('periods').catch(()=>[]);
        FILTER_YEAR = y;
        yearInput.value = y;
        renderTable();
        $status(`Generate រួចរាល់ សម្រាប់ឆ្នាំ ${y}`);
      }catch(err){
        console.error(err);
        alert('បរាជ័យ Generate: '+(err?.message||err));
        $status('បរាជ័យ Generate');
      }
    });
</script>
