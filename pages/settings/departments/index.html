<div class="settings-page">
  <div class="container-page">

    <div class="page-head">
      <div class="d-flex align-items-center gap-2">
        <h1 class="kh-head h4 m-0">នាយកដ្ឋាន</h1>
        <nav aria-label="breadcrumb" class="small">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a href="#/">Dashboard</a></li>
            <li class="breadcrumb-item">Settings</li>
            <li class="breadcrumb-item active">Departments</li>
          </ol>
        </nav>
      </div>
      <div class="separator-breadcrumb border-top"></div>
    </div>

    <div class="page-body">
      <div class="card shadow-sm centered-card">
        <div class="card-body">

          <div class="d-flex justify-content-between mb-3">
            <h4 class="card-title kh-head m-0">បញ្ជីនាយកដ្ឋាន</h4>
            <button id="btnAdd" class="btn btn-primary btn-sm"><i class="i-Add"></i> បន្ថែម</button>
          </div>

          <div class="table-responsive">
            <table id="tblDepts" class="table table-striped table-hover align-middle mb-0">
              <thead>
              <tr>
                <th style="width:90px">ID</th>
                <th>ឈ្មោះនាយកដ្ឋាន</th>
                <th style="width:160px">សកម្មភាព</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="small text-muted mt-2" id="statusLine"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="mdlDept" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="frmDept" novalidate>
      <div class="modal-header">
        <h5 class="modal-title kh-head">ព័ត៌មាននាយកដ្ឋាន</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="department_id" />
        <div class="mb-3">
          <label for="department_name" class="form-label">ឈ្មោះនាយកដ្ឋាន <span class="text-danger">*</span></label>
          <input id="department_name" class="form-control" required />
          <div class="invalid-feedback">សូមបញ្ចូលឈ្មោះ</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">បោះបង់</button>
        <button class="btn btn-primary" type="submit">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import { apiList, apiUpsert, apiDelete, apiLogin } from '../../../assets/js/config.js';

  const TBL = 'departments';
  const PK = 'department_id';
  let AUTH = { token:'' };

  const tbody = document.querySelector('#tblDepts tbody');
  const statusLine = document.getElementById('statusLine');
  const btnAdd = document.getElementById('btnAdd');
  const frm = document.getElementById('frmDept');
  const $id = document.getElementById('department_id');
  const $name = document.getElementById('department_name');
  let mdl;

  function setStatus(msg, ok=true){ statusLine.textContent=msg; statusLine.classList.toggle('text-danger',!ok); }
  async function ensureLogin(){ if(AUTH.token) return; const res=await apiLogin('admin','123'); AUTH.token=res.token; }

  function render(rows){
    if(!rows.length){ tbody.innerHTML=`<tr><td colspan="3" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r[PK]}</td>
        <td>${r.department_name||''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${r[PK]}">កែប្រែ</button>
          <button class="btn btn-sm btn-outline-danger" data-act="remove" data-id="${r[PK]}">លុប</button>
        </td>
      </tr>`).join('');
  }

  async function loadAll(){
    setStatus('កំពុងផ្ទុក…');
    try{
      const rows = await apiList(TBL);
      render(rows);
      setStatus(`បានផ្ទុកសរុប: ${rows.length}`);
    }catch(err){ console.error(err); setStatus('បរាជ័យ: '+err.message,false); }
  }

  btnAdd.addEventListener('click',()=>{ $id.value=''; $name.value=''; if(!mdl) mdl=new bootstrap.Modal(document.getElementById('mdlDept')); mdl.show(); });
  tbody.addEventListener('click',async ev=>{
    const btn=ev.target.closest('button[data-act]'); if(!btn) return;
    const id=btn.dataset.id;
    if(btn.dataset.act==='edit'){
      const rows=await apiList(TBL); const row=rows.find(r=>String(r[PK])===String(id));
      if(row){ $id.value=row[PK]; $name.value=row.department_name; if(!mdl) mdl=new bootstrap.Modal(document.getElementById('mdlDept')); mdl.show(); }
    }
    if(btn.dataset.act==='remove'){
      if(!confirm('លុបទិន្នន័យនេះ?')) return;
      try{ await ensureLogin(); await apiDelete(TBL,PK,id,AUTH.token); loadAll(); }
      catch(err){ setStatus('បរាជ័យ: '+err.message,false); }
    }
  });

  frm.addEventListener('submit',async e=>{
    e.preventDefault(); e.stopPropagation();
    if(!frm.checkValidity()){ frm.classList.add('was-validated'); return; }
    const payload={[PK]:$id.value||undefined,department_name:$name.value.trim()};
    try{ await ensureLogin(); await apiUpsert(TBL,payload,AUTH.token); mdl?.hide(); loadAll(); }
    catch(err){ setStatus('បរាជ័យ: '+err.message,false); }
  });

  document.addEventListener('DOMContentLoaded',loadAll);
</script>
