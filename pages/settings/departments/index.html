<!-- pages/settings/departments/index.html.html -->
<div class="settings-page">
  <div class="container-page">

    <!-- Page head -->
    <div class="page-head">
      <div class="d-flex align-items-center gap-2">
        <h1 class="kh-head h4 m-0">ជំពូក</h1>
        <nav aria-label="breadcrumb" class="small">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a href="#/">Dashboard</a></li>
            <li class="breadcrumb-item">Settings</li>
            <li class="breadcrumb-item active" aria-current="page">Departments</li>
          </ol>
        </nav>
      </div>
      <div class="separator-breadcrumb border-top"></div>
    </div>

    <!-- Body -->
    <div class="page-body">
      <div class="card shadow-sm centered-card w-100">
        <div class="card-body">

          <!-- Toolbar -->
          <div class="toolbar mb-3">
            <h4 class="card-title kh-head m-0">បញ្ជីជំពូក</h4>
            <div class="ms-auto d-flex gap-2 flex-wrap">
              <input id="txtSearchDept" class="form-control form-control-sm" style="width:220px" placeholder="ស្វែងរក...">
              <button id="btnAddDept" class="btn btn-primary btn-sm">
                <i class="i-Add"></i> បន្ថែម
              </button>
            </div>
          </div>

          <!-- Table -->
          <div class="table-responsive">
            <table id="tblDepts" class="table table-striped table-hover align-middle mb-0">
              <thead>
              <tr>
                <th style="width:110px" data-sort="department_id" class="th-sort">ID</th>
                <th data-sort="department_name" class="th-sort">ឈ្មោះ</th>
                <th class="text-end" style="width:160px">សកម្មភាព</th>
              </tr>
              </thead>
              <tbody>
              <tr><td colspan="3" class="skel"></td></tr>
              <tr><td colspan="3" class="skel"></td></tr>
              <tr><td colspan="3" class="skel"></td></tr>
              </tbody>
            </table>
          </div>

          <div id="statusDept" class="small text-muted mt-2"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal Add/Edit -->
<div class="modal fade" id="mdlDept" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="frmDept" novalidate>
      <div class="modal-header">
        <h5 class="modal-title kh-head">ព័ត៌មានជំពូក</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="បិទ"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="department_id">
        <div class="mb-3">
          <label class="form-label">ឈ្មោះ <span class="text-danger">*</span></label>
          <input id="department_name" class="form-control" required>
          <div class="invalid-feedback">សូមបញ្ចូលឈ្មោះ</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">បោះបង់</button>
        <button id="btnSaveDept" class="btn btn-primary" type="submit">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<style>
  .settings-page{flex:1 1 auto; display:flex; flex-direction:column; min-height:0;}
  .container-page{width:100%; max-width:1280px; margin:0 auto; padding:16px 18px 12px; display:flex; flex-direction:column; min-height:0;}
  .page-head{display:flex; flex-direction:column; gap:10px; margin-bottom:12px;}
  .page-body{flex:1 1 auto; min-height:0; display:flex; justify-content:center;}
  .centered-card{max-width:1200px; border:1px solid #eef0f4; border-radius:14px;}
  .toolbar{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
  .skel{ position:relative; overflow:hidden; background:#f3f4f6; height:44px; border-radius:6px; }
  .skel::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
    animation:shimmer 1.1s infinite }
  @keyframes shimmer{ 100%{ transform:translateX(100%);} }

  /* Actions column align */
  #tblDepts th:last-child{ text-align:right; }
  #tblDepts td.td-actions{ text-align:right; width:160px; }
  #tblDepts td.td-actions .actions-right{ display:flex; justify-content:flex-end; gap:.45rem; }

  /* Sort header visual */
  .th-sort{ cursor:pointer; user-select:none; }
  .th-sort.asc::after{ content:" \\25B2"; font-size:.8em; }
  .th-sort.desc::after{ content:" \\25BC"; font-size:.8em; }
</style>

<script type="module">
  import { getAuth, isSuper } from '../../../assets/js/app.auth.js';
  import { gasList, gasSave, gasDelete, ID_FIELDS } from '../../../assets/js/app.menu.js';

  /* Modal helper */
  function makeModal(id){
    const el = document.getElementById(id);
    if (!el) return null;
    if (window.bootstrap?.Modal){
      let inst = bootstrap.Modal.getInstance ? bootstrap.Modal.getInstance(el) : null;
      if (!inst) inst = new bootstrap.Modal(el, {backdrop:true, keyboard:true, focus:true});
      return { show:()=>inst.show(), hide:()=>inst.hide() };
    }
    if (window.jQuery?.fn?.modal){
      const $el = jQuery(el);
      return { show:()=>$el.modal('show'), hide:()=>$el.modal('hide') };
    }
    return { show(){ el.style.display='block'; }, hide(){ el.style.display='none'; } };
  }

  const auth   = getAuth();
  const SUPER  = isSuper(auth);
  const modal  = makeModal('mdlDept');

  const tbl    = document.getElementById('tblDepts');
  const tbody  = tbl.querySelector('tbody');
  const btnAdd = document.getElementById('btnAddDept');
  const frm    = document.getElementById('frmDept');
  const idEl   = document.getElementById('department_id');
  const nameEl = document.getElementById('department_name');
  const txtQ   = document.getElementById('txtSearchDept');
  const $status= (m)=>{ const el=document.getElementById('statusDept'); if(el) el.textContent=m||''; };

  // State
  let ROWS = [];
  let FILTER_Q = '';
  let SORT = { key: 'department_id', dir: 1 }; // 1=asc, -1=desc

  // Skeleton already in HTML

  // Load
  try{
    ROWS = await gasList('departments');
    render();
    $status(`បានផ្ទុក ${ROWS.length} ជំពូក`);
  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
    $status('បរាជ័យទាញទិន្នន័យ');
  }

  // Render
  function render(){
    let list = ROWS.slice();

    // filter
    if (FILTER_Q){
      const q = FILTER_Q;
      list = list.filter(r =>
        String(r.department_id).toLowerCase().includes(q) ||
        String(r.department_name||'').toLowerCase().includes(q)
      );
    }

    // sort
    const k = SORT.key;
    list.sort((a,b)=>{
      const av = (a[k] ?? '').toString().toLowerCase();
      const bv = (b[k] ?? '').toString().toLowerCase();
      return av.localeCompare(bv, undefined, {numeric:true}) * SORT.dir;
    });

    if (!list.length){
      tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
      return;
    }

    const frag = document.createDocumentFragment();
    for (const r of list){
      const tr = document.createElement('tr');
      tr.dataset.id = r.department_id;
      tr.innerHTML = `
        <td style="width:110px"><span class="badge text-bg-light border">#${r.department_id}</span></td>
        <td>${r.department_name || ''}</td>
        <td class="td-actions">
          <div class="actions-right">
            ${SUPER
              ? `<button class="btn btn-sm btn-warning" data-act="edit">កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del">លុប</button>`
              : `<span class="text-muted">—</span>`}
          </div>
        </td>`;
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    // update sort icons
    tbl.querySelectorAll('th.th-sort').forEach(th=>{
      th.classList.remove('asc','desc');
      if (th.dataset.sort === SORT.key) th.classList.add(SORT.dir===1?'asc':'desc');
    });
  }

  // Search
  txtQ?.addEventListener('input', e=>{
    FILTER_Q = String(e.target.value||'').trim().toLowerCase();
    render();
  });

  // Sort header click
  tbl.querySelectorAll('th.th-sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.sort;
      if (!key) return;
      if (SORT.key === key) SORT.dir *= -1;
      else { SORT.key = key; SORT.dir = 1; }
      render();
    });
  });

  // Add
  btnAdd?.addEventListener('click', ()=>{
    if (!SUPER) return alert('ត្រូវការ SUPER');
    frm.reset();
    idEl.value   = '';
    nameEl.value = '';
    nameEl.classList.remove('is-invalid');
    modal?.show();
  });

  // Row actions (edit/delete)
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    if (!SUPER) return alert('ត្រូវការ SUPER');

    const id  = btn.closest('tr')?.dataset?.id;
    const row = ROWS.find(x=>String(x.department_id)===String(id));
    if (!row) return;

    if (btn.dataset.act === 'edit'){
      idEl.value   = row.department_id;
      nameEl.value = row.department_name || '';
      nameEl.classList.remove('is-invalid');
      modal?.show();
    }

    if (btn.dataset.act === 'del'){
      if (!confirm('តើចង់លុបធាតុនេះមែនទេ?')) return;
      try{
        await gasDelete('departments', ID_FIELDS.departments, row.department_id);
        ROWS = ROWS.filter(x=>String(x.department_id)!==String(id));
        render();
        $status('លុបរួចរាល់');
      }catch(err){
        console.error(err);
        alert('បរាជ័យលុប: ' + (err?.message || err));
      }
    }
  });

  // Save
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!SUPER) return alert('ត្រូវការ SUPER');

    const name = (nameEl.value||'').trim();
    nameEl.classList.toggle('is-invalid', !name);
    if (!name) return;

    const payload = idEl.value
      ? { department_id: Number(idEl.value), department_name: name }
      : { department_name: name };

    const btn = document.getElementById('btnSaveDept');
    const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'កំពុងរក្សាទុក…';
    try{
      const res = await gasSave('departments', payload);
      const row = res.row || res;
      const i = ROWS.findIndex(x=>String(x.department_id)===String(row.department_id));
      if (i>=0) ROWS[i]=row; else ROWS.push(row);
      render();
      modal?.hide();
      $status('រក្សាទុករួចរាល់');
    }catch(err){
      console.error(err);
      alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
    }finally{
      btn.disabled = false; btn.innerHTML = old;
    }
  });
</script>
