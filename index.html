<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>PHD Report | Dashboard</title>

  <!-- Fonts Khmer -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@300;400;500;700&display=swap" rel="stylesheet"/>

  <!-- Gull CSS & Plugins -->
  <link href="dist-assets/css/themes/lite-purple.min.css" rel="stylesheet"/>
  <link href="dist-assets/css/plugins/perfect-scrollbar.min.css" rel="stylesheet"/>
  <link href="dist-assets/css/plugins/datatables.min.css" rel="stylesheet"/>

  <style>
    /* ========= Typography & Base ========= */
    :root{
      --kh-font: "Noto Sans Khmer","Khmer OS Siemreap","Battambang",
                 system-ui,-apple-system,"Segoe UI",Arial,Helvetica,sans-serif;
      --kh-head: "Khmer Moul","Noto Sans Khmer",sans-serif;
    }
    html,body{ font-family:var(--kh-font)!important; background:#fafbfc; height:100%; }
    html,body{
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    .kh-head{ font-family:var(--kh-head)!important }

    /* ========= Layout: make footer stick to bottom ========= */
    .app-admin-wrap{ height:100%; }
    .main-content-wrap{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
    }
    .app-footer{ margin-top:auto; }

    /* ========= Header ========= */
    .main-header{
      position:sticky; top:0; z-index:100;
      backdrop-filter:none;
      background:#ffffffCC;
      border-bottom:1px solid #eef0f4;
    }

    .container-page{ max-width:1200px; margin:0 auto; padding:8px }
    .g-kpi .card{ border:0; box-shadow:0 8px 20px rgba(0,0,0,.06) }

    /* ---------- Full-page Loading Overlay ---------- */
    .app-loading{
      position:fixed; inset:0; z-index:2000;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:14px; background:#fff; transition:opacity .2s ease;
    }
    .app-loading.hidden{ opacity:0; pointer-events:none }
    .loader-spin{
      width:52px; height:52px; border-radius:50%;
      border:4px solid #e9ecef; border-top-color:#6f42c1;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* ---------- Skeleton for menus ---------- */
    .skeleton{ position:relative; overflow:hidden; background:#e9ecef; border-radius:6px; }
    .skeleton::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
      animation:shimmer 1.1s infinite;
    }
    .skeleton-text{ display:block; height:14px; width:70%; margin:10px 16px; }
    @keyframes shimmer{ 100% { transform: translateX(100%); } }

    /* ---------- Header right: user box ---------- */
    .userbox{
      display:flex; align-items:center; gap:10px; padding:6px 10px;
      background:#fff; border-radius:999px; box-shadow:0 4px 16px rgba(0,0,0,.08);
      border:1px solid #eee;
    }
    .userbox .avatar{
      width:30px; height:30px; border-radius:50%; background:#6f42c1; color:#fff;
      display:grid; place-items:center; font-weight:700;
    }
    .userbox .meta{ line-height:1.1 }
    .badge-role{ padding:.15rem .45rem; font-size:.7rem; border-radius:6px }

    /* ---------- Footer clock ---------- */
    .footer-clock{ display:flex; align-items:center; gap:10px; font-weight:600; }
    .dot{
      width:8px; height:8px; border-radius:50%; background:#28a745; box-shadow:0 0 0 0 rgba(40,167,69,.7);
      animation:pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform:scale(.9); box-shadow:0 0 0 0 rgba(40,167,69,.7); }
      70% { transform:scale(1); box-shadow:0 0 0 8px rgba(40,167,69,0); }
      100% { transform:scale(.9); box-shadow:0 0 0 0 rgba(40,167,69,0); }
    }

    /* ---------- Stop Gull's iconsmind font requests (avoid 404) ---------- */
    @font-face { font-family:'iconsmind'; src: local('x'); }
  </style>
</head>

<body class="text-start">
<!-- Full-page loading -->
<div id="appLoading" class="app-loading">
  <div class="loader-spin" aria-hidden="true"></div>
  <div id="appLoadingText" class="text-muted">កំពុងផ្ទុកទិន្នន័យ…</div>
</div>

<div class="app-admin-wrap layout-sidebar-compact sidebar-dark-purple sidenav-open clearfix">

  <!-- ======= LEFT: primary ======= -->
  <div class="side-content-wrap">
    <div class="sidebar-left open rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
      <ul class="navigation-left">
        <li class="nav-item active" data-item="dashboard">
          <a class="nav-item-hold" href="#/"><i class="nav-icon i-Bar-Chart"></i><span class="nav-text">ផ្ទាំងគ្រប់គ្រង</span></a><div class="triangle"></div>
        </li>

        <li class="nav-item">
          <a class="nav-item-hold" href="#/issues"><i class="nav-icon i-Information"></i><span class="nav-text">បញ្ហាប្រឈម</span></a><div class="triangle"></div>
        </li>

        <li class="nav-item" data-item="depts">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-Library"></i><span class="nav-text">ការិយាល័យ</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item" data-item="reports">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-File-Clipboard-File--Text"></i><span class="nav-text">របាយការណ៍</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item menu-super-only" data-item="users">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-Administrator"></i><span class="nav-text">អ្នកប្រើប្រាស់</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item" data-item="settings">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-Gear-2"></i><span class="nav-text">កំណត់</span></a><div class="triangle"></div>
        </li>
      </ul>
    </div>

    <!-- ======= LEFT: secondary (submenus) ======= -->
    <div class="sidebar-left-secondary rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
      <i class="sidebar-close i-Close"></i>

      <header class="px-3 pt-3">
        <div class="logo d-flex align-items-center gap-2">
          <img src="dist-assets/images/logo-text.png" alt=""/> <span class="kh-head">PHD Report</span>
        </div>
      </header>

      <!-- Dashboard submenu -->
      <div class="submenu-area" data-parent="dashboard">
        <header><h6>Dashboard</h6><p>ស្ថានភាពសរុប</p></header>
        <ul class="childNav">
          <li class="nav-item"><a href="#/"><i class="nav-icon i-Clock-3"></i><span class="item-name">Overview</span></a></li>
        </ul>
      </div>

      <!-- Depts submenu (dynamic) -->
      <div class="submenu-area" data-parent="depts">
        <header><h6>បញ្ចូលទិន្នន័យ</h6><p>តាមផ្នែក</p></header>
        <ul id="deptMenu" class="childNav">
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
        </ul>
      </div>

      <!-- Reports submenu -->
      <div class="submenu-area" data-parent="reports">
        <header><h6>របាយការណ៍</h6><p>សង្ខេប និងនាំចេញ</p></header>
        <ul class="childNav">
          <li class="nav-item"><a href="#/"><i class="nav-icon i-Bar-Chart"></i><span class="item-name">សង្ខេបឆ្នាំ</span></a></li>
        </ul>
      </div>

      <!-- Settings submenu (role-aware) -->
      <div class="submenu-area" data-parent="settings">
        <header><h6>ការកំណត់</h6><p>ទិន្នន័យមេ</p></header>
        <ul id="settingsMenu" class="childNav">
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ======= RIGHT: main ======= -->
  <div class="main-content-wrap d-flex flex-column">
    <div class="main-header px-3 py-2 d-flex align-items-center">
      <div class="logo"><img src="dist-assets/images/logo.png" alt=""/></div>
      <div class="menu-toggle ms-2"><div></div><div></div><div></div></div>
      <div class="flex-grow-1"></div>

      <!-- User box -->
      <div id="userBox" class="userbox">
        <div class="avatar" id="userAvatar">U</div>
        <div class="meta">
          <div id="userName" class="small">អ្នកប្រើប្រាស់</div>
          <div id="userRole" class="badge-role bg-light text-secondary">viewer</div>
        </div>
        <a id="btnLogin" class="btn btn-sm btn-outline-primary ms-2" href="login.html">ចូលប្រើប្រាស់</a>
      </div>
    </div>

    <!-- Router outlet -->
    <div id="route-outlet"></div>

    <!-- Footer always at bottom -->
    <div class="app-footer">
      <div class="footer-bottom border-top pt-3 d-flex flex-column flex-sm-row align-items-center">
        <span class="flex-grow-1"></span>
        <div class="d-flex align-items-center gap-3">
          <div class="footer-clock">
            <span class="dot" aria-hidden="true"></span>
            <span id="clockKh">-- -- ---- --:--:--</span>
          </div>
          <div class="d-flex align-items-center">
            <img class="logo me-2" src="dist-assets/images/logo-text.png" alt=""/>
            <div><p class="m-0">&copy; PHD Report</p><p class="m-0">លាង ផានិត្យ</p><p class="m-0">០៩៧២០៩៧៨៨៨</p></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Vendor JS -->
<script src="dist-assets/js/plugins/jquery-3.3.1.min.js"></script>
<script src="dist-assets/js/plugins/bootstrap.bundle.min.js"></script>
<script src="dist-assets/js/plugins/perfect-scrollbar.min.js"></script>
<script src="dist-assets/js/plugins/datatables.min.js"></script>
<script src="dist-assets/js/plugins/echarts.min.js"></script>
<script src="dist-assets/js/scripts/script.min.js"></script>
<script src="dist-assets/js/scripts/sidebar.compact.script.min.js"></script>
<script src="dist-assets/js/scripts/customizer.script.min.js"></script>

<!-- App JS -->
<script type="module">
  /* ===== GAS_BASE import FIRST (fix ReferenceError) ===== */
  import { GAS_BASE as CONFIG_GAS_BASE } from './assets/js/config.js';
  const GAS_BASE = CONFIG_GAS_BASE;
  window.GAS_BASE = GAS_BASE; // (optional) if some non-module code needs it

  /* ===== rest of module imports ===== */
  import { ensureLoggedIn, applyLoginButton, getAuth, isSuper } from './assets/js/app.auth.js';
  import { buildDeptMenu, buildSettingsMenu, gasList, gasSave, gasDelete, ID_FIELDS } from './assets/js/app.menu.js';


  /* ---------- Simple loader ---------- */
  const AppLoader = (() => {
    let n = 0;
    const el = document.getElementById('appLoading');
    const textEl = document.getElementById('appLoadingText');
    const show = (m) => { n++; if (m && textEl) textEl.textContent = m; el?.classList.remove('hidden'); };
    const hide = () => { n = Math.max(0, n-1); if (!n) el?.classList.add('hidden'); };
    const wrap = async (p, m) => { show(m); try { return await p; } finally { hide(); } };
    return { show, hide, wrap };
  })();

  /* ---------- Require login ---------- */
  console.debug('[auth@boot]', getAuth());
  applyLoginButton();
  ensureLoggedIn('login.html');

  /* ---------- Menus (left sidebar) ---------- */
  await AppLoader.wrap(Promise.all([
    buildDeptMenu('deptMenu'),
    buildSettingsMenu('settingsMenu'),
  ]), 'កំពុងផ្ទុកទិន្នន័យ…');

  /* ---------- Header user UI ---------- */
  (function updateUserUI(){
    const auth = getAuth();
    const btn   = document.getElementById('btnLogin');
    const nameEl= document.getElementById('userName');
    const roleEl= document.getElementById('userRole');
    const avatar= document.getElementById('userAvatar');

    const displayName = (a)=> a?.full_name || a?.display_name || a?.user_fullname || a?.user_name || a?.username || 'អ្នកប្រើប្រាស់';
    const role = String(auth?.role || 'viewer').toLowerCase();

    nameEl && (nameEl.textContent = displayName(auth));
    if (roleEl){
      roleEl.textContent = role;
      roleEl.className   = 'badge-role ' + (role==='super' ? 'bg-primary text-white'
                                     : role.includes('data') ? 'bg-success text-white'
                                     : 'bg-light text-secondary');
    }
    if (avatar){
      const letter = (displayName(auth).match(/[A-Za-zក-ហ]/) || ['U'])[0].toUpperCase();
      avatar.textContent = letter;
    }
    btn && applyLoginButton(btn);
    document.querySelectorAll('.menu-super-only').forEach(el=>{
      el.style.display = isSuper(auth) ? '' : 'none';
    });
  })();

  /* ======================= Tiny Router (hash) ======================= */
  const outlet = document.getElementById('route-outlet');
  const baseDir = location.pathname.replace(/\/[^\/]*$/, '/');
  const viewUrl = (p) => baseDir + p.replace(/^\/+/,'');

  const routes = {
    '':                     { view:'pages/home.html',                        init:initDashboard },
    'settings/indicators':  { view:'pages/settings/indicators/index.html',  init:initIndicators },
    'settings/departments': { view:'pages/settings/departments/index.html',  init:initDepartments },
    'settings/units':       { view:'pages/settings/units/index.html',        init:initUnits },
    'settings/periods':     { view:'pages/settings/periods/index.html',      init:initPeriods },
    'settings/users':       { view:'pages/settings/users/index.html',        init:initUsers },
    'data-entry':           { view:'pages/data-entry/index.html',            init:initDataEntry },
    'issues':               { view:'pages/issues/index.html',                init:initIssues },

};

  async function render(path){
    const conf = routes[path] || routes[''];
    try{
      const res = await fetch(viewUrl(conf.view), { cache:'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const html = await res.text();
      outlet && (outlet.innerHTML = html);
      if (typeof conf.init === 'function') {
        await AppLoader.wrap(conf.init(), 'កំពុងរៀបចំទំព័រ…');
      }
      setActiveByHash(path);
    }catch(e){
      outlet && (outlet.innerHTML = `
        <div class="container-page">
          <div class="alert alert-danger mt-3">
            មិនអាចផ្ទុកទំព័រ: ${conf.view}<br/>
            <small class="text-muted">${e.message || e}</small>
          </div>
        </div>`);
    }
  }
  const parseHash = () => (location.hash || '#/').replace(/^#\//,'');
  window.addEventListener('hashchange', () => AppLoader.wrap(render(parseHash()), 'កំពុងផ្ទុកទំព័រ…'));
  await AppLoader.wrap(render(parseHash()), 'កំពុងផ្ទុកទំព័រ…');

  function setActiveByHash(h){
    const top = h.startsWith('settings/') ? 'settings'
             : h.startsWith('issues') ? 'issues'
             : h.startsWith('depts')      ? 'depts'
             : h.startsWith('reports')    ? 'reports'
             : 'dashboard';
    document.querySelectorAll('.navigation-left .nav-item').forEach(li=>{
      li.classList.toggle('active', li.getAttribute('data-item')===top);
    });
  }

  /* ======================= Dashboard ======================= */
  async function initDashboard(){
    const $ = s => document.querySelector(s);

    const [indicators, departments, units, reports] = await AppLoader.wrap(Promise.all([
      gasList('indicators').catch(()=>[]),
      gasList('departments').catch(()=>[]),
      gasList('units').catch(()=>[]),
      gasList('reports').catch(()=>[]),
    ]), 'កំពុងទាញទិន្នន័យ Dashboard…');

    $('#kpiIndicators') && ( $('#kpiIndicators').textContent = indicators.length );
    $('#kpiDepts')      && ( $('#kpiDepts').textContent      = departments.length );
    $('#kpiUnits')      && ( $('#kpiUnits').textContent      = units.length );
    $('#kpiReports')    && ( $('#kpiReports').textContent    = reports.length );

    if (window.echarts){
      const ec = window.echarts;

      // Monthly bar
      const aggMonth = {};
      for(const r of reports){
        const d = new Date(r.date || r._createdAt || Date.now());
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        aggMonth[key] = (aggMonth[key]||0)+1;
      }
      const months = Object.keys(aggMonth).sort();
      const series = months.map(m=>aggMonth[m]);
      const c1El = document.getElementById('chartMonthly');
      if (c1El){
        const c1 = ec.init(c1El, null, { devicePixelRatio: window.devicePixelRatio || 1 });
        c1.setOption({ tooltip:{}, xAxis:{type:'category',data:months}, yAxis:{type:'value'}, series:[{type:'bar',data:series}] });
      }

      // By department pie
      const nameByDept = Object.fromEntries(departments.map(d=>[d.department_id,d.department_name]));
      const aggDept = {};
      for(const r of reports){
        const name = nameByDept[r.department_id] || 'មិនបានកំណត់';
        aggDept[name] = (aggDept[name]||0)+1;
      }
      const data = Object.entries(aggDept).map(([name,value])=>({name,value}));
      const c2El = document.getElementById('chartDept');
      if (c2El){
        const c2 = ec.init(c2El, null, { devicePixelRatio: window.devicePixelRatio || 1 });
        c2.setOption({ tooltip:{trigger:'item'}, series:[{type:'pie',radius:'70%',data}] });
      }
    }
  }

/* ======================= initDataEntry ======================= */
async function initDataEntry(){
  /* ---------- DOM ---------- */
  const $  = (s, r=document)=> r.querySelector(s);
  const toArr = (x)=> Array.isArray(x) ? x : (x?.rows||x?.content||[]);
  const auth = getAuth() || {};

  const selYear   = $('#selYear');
  const selPeriod = $('#selPeriod');
  const selDept   = $('#selDept');
  const selUnit   = $('#selUnit');
  const inpSearch = $('#inpSearch');
  const swOnlyMy  = $('#swOnlyMy');
  const completeInfo = $('#completeInfo');
  const onlyEmpty    = $('#onlyEmpty');

  const tbl       = $('#tblReports');
  const tbody     = tbl?.querySelector('tbody');
  const btnCopy   = $('#btnCopyPrev');
  const btnSaveAll= $('#btnSaveAll');
  const statusEl  = $('#status');
  const countInfo = $('#countInfo');
  const dirtyBadge= $('#dirtyCount');

  // Modal
  const mdlEl = $('#mdlIssue'), frm = $('#frmIssue');
  const f_aid=$('#f_action_id'), f_iid=$('#f_indicator_id'), f_uid=$('#f_unit_id');
  const f_iname=$('#f_indicator_name'), f_plbl=$('#f_period_label');
  const f_issue=$('#f_issue_text'), f_act=$('#f_action_text');
  const f_owner=$('#f_action_owner'), f_due=$('#f_action_due'), f_stat=$('#f_action_status');
  const Modal = window.bootstrap?.Modal; const mdl = (Modal && mdlEl) ? new Modal(mdlEl) : null;

  const setStatus = (m)=>{ if(statusEl) statusEl.textContent = m || ''; };
  const setDirty  = ()=>{ if(dirtyBadge) dirtyBadge.textContent = String(DIRTY.size); };

  /* ---------- Period helpers (self-contained) ---------- */
  const KH_MONTHS = ['មករា','កុម្ភៈ','មិនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
  const pidOfMonth   = (y,m)=>`${y}M${String(m).padStart(2,'0')}`;
  const pidOfQuarter = (y,q)=>`${y}Q${q}`;
  const pidOfHalf    = (y,h)=>`${y}H${h}`;
  const pidOfYear    = (y)=>`${y}Y12`;

  function parsePid(pid){
    const y = +String(pid).slice(0,4);
    const tag = String(pid).slice(4); // M09 / Q3 / H1 / Y12
    const type = tag.startsWith('M') ? 'month'
               : tag.startsWith('Q') ? 'quarter'
               : tag.startsWith('H') ? 'half'
               : 'year';
    const m = (type==='month') ? +tag.slice(1) : null;
    return { year:y, tag, type, month:m };
  }
  function prettyPid(pid){
    const {year, type, month, tag} = parsePid(pid);
    if (type==='month')   return `${KH_MONTHS[month-1]} ${year}`;
    if (type==='quarter') return `ត្រីមាស ${tag.slice(1)} • ${year}`;
    if (type==='half')    return `ឆមាស ${tag.slice(1)} • ${year}`;
    return `ឆ្នាំ ${year}`;
  }
  function prevPid(pid){
    const p = parsePid(pid);
    if (p.type==='month'){ let y=p.year, m=p.month-1; if(m<1){y--; m=12;} return pidOfMonth(y,m); }
    if (p.type==='quarter'){ let y=p.year, q=+p.tag.slice(1)-1; if(q<1){y--; q=4;} return pidOfQuarter(y,q); }
    if (p.type==='half'){ let y=p.year, h=(+p.tag.slice(1)===2)?1:2; if(+p.tag.slice(1)===1){y--; h=2;} return pidOfHalf(y,h); }
    return pidOfYear(p.year-1);
  }

  async function buildPeriodSelectors(selYearEl, selPeriodEl, onChange){
    // years ±3
    const nowY = new Date().getFullYear();
    if (!selYearEl.options.length){
      for (let y=nowY-3; y<=nowY+3; y++){
        const o=document.createElement('option'); o.value=y; o.textContent=y; selYearEl.appendChild(o);
      }
      selYearEl.value = String(nowY);
    }

    // try fetch periods; if fail → build local
    let periods = await gasList('periods').catch(()=>[]);
    periods = toArr(periods).map(r=>String(r.period_id)).filter(Boolean);

    const ensureYear = (y)=>{
      const has = periods.some(pid=>String(pid).startsWith(String(y)));
      if (has) return;
      for (let m=1;m<=12;m++) periods.push(pidOfMonth(y,m));
      for (let q=1;q<=4;q++) periods.push(pidOfQuarter(y,q));
      periods.push(pidOfHalf(y,1), pidOfHalf(y,2), pidOfYear(y));
    };
    [nowY-1, nowY, nowY+1, +selYearEl.value].forEach(ensureYear);

    const renderForYear=(y)=>{
      const pids = periods.filter(pid=>String(pid).startsWith(String(y)));
      const months   = pids.filter(pid=>/M\d{2}$/.test(pid));
      const quarters = pids.filter(pid=>/Q[1-4]$/.test(pid));
      const halves   = pids.filter(pid=>/H[12]$/.test(pid));
      const years    = pids.filter(pid=>/Y\d{2}$/.test(pid));
      const opt = pid=>`<option value="${pid}">${prettyPid(pid)}</option>`;
      const og  = (label,arr)=> arr.length ? `<optgroup label="${label}">${arr.map(opt).join('')}</optgroup>` : '';
      selPeriodEl.innerHTML = og('ខែ (Monthly)', months)
                            + og('ត្រីមាស (Quarterly)', quarters)
                            + og('ឆមាស (Half-year)', halves)
                            + og('ឆ្នាំ (Yearly)', years);
      const d=new Date();
      const prefer = (y===d.getFullYear()) ? pidOfMonth(y, d.getMonth()+1)
                                           : (months[0]||quarters[0]||halves[0]||years[0]);
      if (prefer) selPeriodEl.value = prefer;
    };

    renderForYear(+selYearEl.value);
    selYearEl.addEventListener('change', ()=>{ renderForYear(+selYearEl.value); onChange?.(); });
    selPeriodEl.addEventListener('change', ()=> onChange?.());
  }

  const curPeriod = ()=>{
    const pid = selPeriod?.value || '';
    const {year, tag, type, month} = parsePid(pid);
    return { pid, year, monthTag: tag, type, monthNum: month };
  };

  /* ---------- State ---------- */
  let DEPTS=[], UNITS=[], IND=[], VALUES=[], ACTIONS=[];
  let ROWS=[]; let FILTER_Q=''; let ONLY_MY=false; let SHOW_ONLY_EMPTY=false;
  const DIRTY = new Map(); // key "indicator_id|unit_id" -> payload

  /* ---------- UI helpers ---------- */
  function fillDept(){
    selDept.innerHTML = `<option value="">ការិយាល័យទាំងអស់</option>`+
      DEPTS.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
  }
  function fillUnit(depId){
    const list = depId ? UNITS.filter(u=>String(u.department_id)===String(depId)) : UNITS;
    selUnit.innerHTML = `<option value="">ផ្នែកទាំងអស់</option>`+
      list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
  }
  function applyFilters(list){
    const dep = selDept.value||''; const unit=selUnit.value||'';
    let out = list.slice();
    if (dep)  out = out.filter(r=>String(r.department_id)===String(dep));
    if (unit) out = out.filter(r=>String(r.unit_id)===String(unit));
    if (ONLY_MY){
      const uid = auth?.unit_id;
      if (uid!=null) out = out.filter(r=>String(r.unit_id)===String(uid));
    }
    if (FILTER_Q){
      const q = FILTER_Q.toLowerCase();
      out = out.filter(r =>
        String(r.indicator_id).includes(q) ||
        (r.indicator_name||'').toLowerCase().includes(q) ||
        (r.unit_name||'').toLowerCase().includes(q) ||
        (r.department_name||'').toLowerCase().includes(q)
      );
    }
    if (SHOW_ONLY_EMPTY){
      out = out.filter(r => r.value==='' || r.value==null || String(r.value).trim()==='');
    }
    return out;
  }

  function render(){
    const rowsAll = ROWS.slice();
    const filledCount = rowsAll.reduce((n,r)=>{
      const v = (DIRTY.get(`${r.indicator_id}|${r.unit_id}`)?.value ?? r.value);
      return n + ((v!=='' && v!=null && String(v).trim()!=='') ? 1 : 0);
    }, 0);
    if (completeInfo) completeInfo.textContent = `${filledCount} / ${rowsAll.length}`;

    const rows = applyFilters(ROWS);
    if (countInfo) countInfo.textContent = `${rows.length}`;
    if (!tbody) return;

    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
      return;
    }

    const frag = document.createDocumentFragment();
    for (const r of rows){
      const key = `${r.indicator_id}|${r.unit_id}`;
      const val = (DIRTY.get(key)?.value ?? r.value ?? '');
      const missing = (val==='' || val==null || String(val).trim()==='');

      const pidLabel = prettyPid(`${r.year}${r.month}`);
      const tr  = document.createElement('tr');
      if (missing) tr.classList.add('row-missing');

      tr.innerHTML = `
        <td>${r.indicator_id}</td>
        <td>
          <div class="fw-semibold">${r.indicator_name||''}</div>
          <div class="small mt-1">
            ${missing
              ? '<span class="badge badge-missing">មិនទាន់</span>'
              : '<span class="badge badge-done">បានបំពេញ</span>'}
          </div>
        </td>
        <td>${r.department_name||''}${r.unit_name?` / ${r.unit_name}`:''}</td>
        <td>${pidLabel}</td>
        <td>
          <input
            type="number" inputmode="decimal" pattern="^[0-9]+(\\.[0-9]*)?$"
            step="any" min="0"
            class="form-control form-control-sm inp-val"
            data-key="${key}" value="${missing ? '' : val}" placeholder="0"
          />
        </td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-act="issue" data-key="${key}">
            Issue / Action
          </button>
        </td>`;
      frag.appendChild(tr);
    }
    tbody.innerHTML=''; tbody.appendChild(frag);
  }

  /* ---------- Initial load ---------- */
  try{
    await buildPeriodSelectors(selYear, selPeriod, ()=>reloadPeriod());

    const [deps, units, inds] = await Promise.all([
      gasList('departments'), gasList('units'), gasList('indicators')
    ]);
    DEPTS = toArr(deps); UNITS = toArr(units); IND = toArr(inds);

    fillDept(); fillUnit('');
    await reloadPeriod();
  }catch(e){
    console.error(e);
    setStatus('បរាជ័យផ្ទុកទិន្នន័យ');
    if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center py-4">មិនអាចទាញទិន្នន័យបាន</td></tr>`;
  }

  /* ---------- Data reload ---------- */
  async function reloadPeriod(){
    const P = curPeriod();
    setStatus('កំពុងផ្ទុកទិន្នន័យរយៈពេល…');

    const [values, actions] = await Promise.all([
      gasList('reports', { year:P.year, month:P.monthTag }),
      gasList('actions', { year:P.year, month:P.monthTag }),
    ]).catch(()=>[[],[]]);

    VALUES  = toArr(values);
    ACTIONS = toArr(actions);

    const depName = Object.fromEntries(DEPTS.map(d=>[String(d.department_id), d.department_name]));
    const unitName= Object.fromEntries(UNITS.map(u=>[String(u.unit_id), u.unit_name]));
    const vMap = new Map(VALUES.map(v => [`${v.indicator_id}|${v.unit_id}`, v]));
    const aMap = new Map(ACTIONS.map(a => [`${a.indicator_id}|${a.unit_id}`, a]));
    const myUnit = String(auth?.unit_id||'');

    ROWS = IND.map(ind=>{
      const key = `${ind.indicator_id}|${ind.unit_id}`;
      const v = vMap.get(key) || {};
      const a = aMap.get(key) || {};
      return {
        indicator_id   : ind.indicator_id,
        indicator_name : ind.indicator_name,
        department_id  : ind.department_id,
        department_name: depName[String(ind.department_id)]||'',
        unit_id        : ind.unit_id,
        unit_name      : unitName[String(ind.unit_id)]||'',
        assigned_to_me : String(ind.unit_id)===myUnit,
        year           : P.year,
        month          : P.monthTag,    // e.g. M09 / Q3 / H1 / Y12
        value          : v.value ?? null,
        report_id      : v.report_id || null,
        action_id      : a.action_id || null,
        issue_text     : a.issue_text||'',
        action_text    : a.action_text||'',
        action_owner   : a.action_owner||'',
        action_due     : a.action_due||'',
        action_status  : a.action_status||'',
      };
    });

    DIRTY.clear(); setDirty(); setStatus('');
    render();
  }

  /* ---------- Input sanitizers & save ---------- */
  function cleanDecimal(s){
    s = String(s || '');
    s = s.replace(/[^0-9.]/g, '');
    const i = s.indexOf('.');
    if (i !== -1) s = s.slice(0,i+1) + s.slice(i+1).replace(/\./g,'');
    if (s === '.') s = '';
    return s;
  }
  function markDirtyFromInput(inp){
    const key = inp.dataset.key;
    const [indicator_id, unit_id] = key.split('|');
    const P = curPeriod();
    const base = ROWS.find(r=>String(r.indicator_id)===indicator_id && String(r.unit_id)===unit_id) || {};
    DIRTY.set(key, {
      indicator_id: +indicator_id,
      unit_id: +unit_id,
      year: P.year,
      month: P.monthTag,
      value: inp.value,
      report_id: base.report_id || null
    });
    setDirty();
  }
  async function saveOne(key){
    const row = DIRTY.get(key); if(!row) return;
    try{
      const res = await gasSave('reports', row);
      const saved = res?.row || res || {};
      const i = ROWS.findIndex(r=>`${r.indicator_id}|${r.unit_id}`===key);
      if (i>=0){
        ROWS[i].value     = row.value;
        ROWS[i].report_id = saved.report_id || ROWS[i].report_id || null;
      }
      DIRTY.delete(key); setDirty(); setStatus('បានរក្សាទុក');
    }catch(err){
      console.error(err); setStatus('បរាជ័យរក្សាទុក ('+key+')');
    }
  }

  /* ---------- Events ---------- */
  selDept?.addEventListener('change', ()=>{ fillUnit(selDept.value); render(); });
  selUnit?.addEventListener('change', ()=>render());
  inpSearch?.addEventListener('input', e=>{ FILTER_Q = String(e.target.value||'').trim().toLowerCase(); render(); });
  swOnlyMy?.addEventListener('change', e=>{ ONLY_MY = !!e.target.checked; render(); });
  onlyEmpty?.addEventListener('change', e=>{ SHOW_ONLY_EMPTY = !!e.target.checked; render(); });

  // numeric-only inputs
  tbody?.addEventListener('keydown', (e)=>{
    const inp = e.target.closest('.inp-val'); if(!inp) return;
    const ctrl = ['Backspace','Delete','Tab','Escape','Enter','ArrowLeft','ArrowRight','Home','End'];
    if (ctrl.includes(e.key)) {
      if (e.key==='Enter'){ e.preventDefault(); inp.blur(); }
      return;
    }
    if (e.key === '.') { if (inp.value.includes('.')) e.preventDefault(); return; }
    if (!/^[0-9]$/.test(e.key)) e.preventDefault();
  });
  tbody?.addEventListener('input', (e)=>{
    const inp = e.target.closest('.inp-val'); if(!inp) return;
    const cleaned = cleanDecimal(inp.value);
    if (inp.value !== cleaned) inp.value = cleaned;
    markDirtyFromInput(inp);
  });
  tbody?.addEventListener('paste', (e)=>{
    const inp = e.target.closest('.inp-val'); if(!inp) return;
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text');
    const cleaned = cleanDecimal(text);
    const { selectionStart:s, selectionEnd:t, value:v } = inp;
    inp.value = cleanDecimal(v.slice(0,s) + cleaned + v.slice(t));
    markDirtyFromInput(inp);
  });
  tbody?.addEventListener('blur', async (e)=>{
    const inp = e.target.closest('.inp-val'); if(!inp) return;
    const key = inp.dataset.key;
    if (!DIRTY.has(key)) return;
    await saveOne(key);
  }, true);

  btnSaveAll?.addEventListener('click', async ()=>{
    const keys = Array.from(DIRTY.keys());
    if (!keys.length){ setStatus('គ្មានអ្វីត្រូវរក្សាទុក'); return; }
    setStatus('កំពុងរក្សាទុកទាំងអស់…');
    for (const k of keys){ /* eslint-disable no-await-in-loop */ await saveOne(k); }
    render(); setStatus('រក្សាទុករួចរាល់');
  });

  btnCopy?.addEventListener('click', async ()=>{
    const cur = curPeriod(); const prev = prevPid(cur.pid);
    setStatus('កំពុងយកតម្លៃរយៈពេលមុន…');
    try{
      const pp = parsePid(prev);
      const prevVals = toArr(await gasList('reports', { year:pp.year, month:pp.tag }));
      const mapPrev = new Map(prevVals.map(r=>[`${r.indicator_id}|${r.unit_id}`, r.value]));
      let changed=0;
      for (const r of ROWS){
        const key = `${r.indicator_id}|${r.unit_id}`;
        if ((r.value==null||r.value==='') && mapPrev.has(key)){
          DIRTY.set(key, {
            indicator_id:r.indicator_id, unit_id:r.unit_id,
            year:cur.year, month:cur.monthTag,
            value: mapPrev.get(key), report_id:r.report_id||null
          });
          changed++;
        }
      }
      setDirty(); render();
      setStatus(`បានបំពេញពីរយៈពេលមុន ${changed} ជួរ (សូមចុច "រក្សាទុកទាំងអស់")`);
    }catch(err){ console.error(err); setStatus('បរាជ័យយករយៈពេលមុន'); }
  });

  // Issue/Action modal
  tbody?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act="issue"]'); if(!btn) return;
    const key = btn.dataset.key;
    const row = ROWS.find(r=>`${r.indicator_id}|${r.unit_id}`===key); if(!row) return;
    const P = curPeriod();
    f_aid.value = row.action_id || '';
    f_iid.value = row.indicator_id;
    f_uid.value = row.unit_id;
    f_iname.textContent = row.indicator_name||'';
    f_plbl.textContent  = prettyPid(P.pid);
    f_issue.value = row.issue_text || '';
    f_act.value   = row.action_text || '';
    f_owner.value = row.action_owner || '';
    f_due.value   = row.action_due || '';
    f_stat.value  = row.action_status || '';
    $('#editStatus').textContent='';
    mdl?.show();
  });
  frm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const P = curPeriod();
    const payload = {
      action_id   : f_aid.value || null,
      indicator_id: +f_iid.value,
      unit_id     : +f_uid.value,
      year:P.year, month:P.monthTag,
      issue_text  : f_issue.value.trim(),
      action_text : f_act.value.trim(),
      action_owner: f_owner.value.trim(),
      action_due  : f_due.value || '',
      action_status: f_stat.value || ''
    };
    const btn = $('#btnSaveIssue'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='កំពុងរក្សាទុក…';
    try{
      const res = await gasSave('actions', payload);
      const saved = res?.row || res || {};
      const i = ROWS.findIndex(r => r.indicator_id===payload.indicator_id && r.unit_id===payload.unit_id);
      if (i>=0){
        ROWS[i].action_id    = saved.action_id || ROWS[i].action_id || null;
        ROWS[i].issue_text   = payload.issue_text;
        ROWS[i].action_text  = payload.action_text;
        ROWS[i].action_owner = payload.action_owner;
        ROWS[i].action_due   = payload.action_due;
        ROWS[i].action_status= payload.action_status;
      }
      mdl?.hide(); setStatus('រក្សាទុក Issue/Action រួចរាល់');
    }catch(err){
      console.error(err);
      $('#editStatus').textContent = 'បរាជ័យរក្សាទុក: ' + (err?.message || err);
    }finally{
      btn.disabled=false; btn.innerHTML=old;
    }
  });

  // filters re-render
  selDept?.addEventListener('change', ()=>{ fillUnit(selDept.value); render(); });
}




// ======================= main index / initIssues ===========================
/// ======================= Issues: simplified full version (fixed) =======================
async function initIssues() {
  /* ====== CONFIG: GAS Web App (Google Docs → PDF) ====== */
  const GAS_WEBAPP = 'https://script.google.com/macros/s/AKfycbxHb9mWIaeZWy7zwqbC74DKzKoeYYIYPgrVfX1mbWZngP8R4uNMP6LoAlfeXp-OSpZueg/exec';

  /* ====== Role (strict) ====== */
  function getAuthSafe(){
    try{
      const a = (typeof window.getAuth === "function" ? window.getAuth() : {}) || {};
      const raw  = String(a.role ?? a.user_type ?? "").trim().toLowerCase();
      const role = (raw === "superuser") ? "super" : raw;
      return { ...a, role };
    }catch{ return { role:"" }; }
  }
  const AUTH  = getAuthSafe();
  const SUPER = AUTH.role === "super";
  document.documentElement.classList.toggle("is-super", SUPER);

  /* ====== DOM ====== */
  const $ = s => document.querySelector(s);
  const tbody   = $("#tblIssues tbody");
  const thead   = $("#tblIssues thead");
  const sumEl   = $("#issuesSummary");
  const segBtns = [...document.querySelectorAll(".segbtn")];
  const ySel    = $("#ySel");
  const tagWrap = $("#tagWrap");
  const tagSel  = $("#tagSel");
  const btnApply= $("#btnApply");
  const btnReset= $("#btnReset");
  const btnPdf  = $("#btnDownloadPdf");
  if (!tbody || !thead || !sumEl) return;

  /* ====== Utils ====== */
  const KH_MONTHS=['មករា','កុម្ភៈ','មិនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
  const fmtDate=s=>{
    if(!s) return '';
    const d=new Date(s); if (Number.isNaN(+d)) return esc(s);
    const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  };
  const pretty=(y,t)=>!y||!t?''
    : /^M\d{2}$/.test(t) ? `${KH_MONTHS[+t.slice(1)-1]} ${y}`
    : /^Q[1-4]$/.test(t) ? `ត្រីមាស ${t.slice(1)} • ${y}`
    : /^H[12]$/.test(t) ? `ឆមាស ${t.slice(1)} • ${y}`
    : t==='Y12' ? `ឆ្នាំ ${y}` : `${y} ${t}`;
  const khStatusLabel = (s) => {
    const v = String(s||'').toLowerCase();
    if (v === 'planned')  return 'បានគ្រោង';
    if (v === 'ongoing' || v === 'in-progress') return 'កំពុងដំណើរការ';
    if (v === 'done' || v === 'completed') return 'បានបញ្ចប់';
    if (v === 'blocked') return 'មានឧបសគ្គ';
    return 'កំពុងរៀបចំ';
  };
  const statusClass = (s)=>{
    const v = String(s||'').toLowerCase();
    if (v==='done' || v==='completed') return 'status-done';
    if (v==='ongoing' || v==='in-progress') return 'status-progress';
    if (v==='blocked') return 'status-blocked';
    if (v==='planned') return 'status-pending';
    return 'status-pending';
  };
  const periodToSortable=(y,t)=>{t=String(t||'').toUpperCase();
    if(/^M\d{2}$/.test(t))return y*10000+(+t.slice(1));
    if(/^Q[1-4]$/.test(t))return y*10000+(['Q1','Q2','Q3','Q4'].indexOf(t)+1)*100;
    if(/^H[12]$/.test(t))return y*10000+(t==='H1'?10:20)*100;
    if(t==='Y12')return y*10000+9999; return y*10000;};

  /* ====== State ====== */
  let MODE='all', sortBy=null, sortDir=1;
  let ALL=[];
  const PERIOD={
    months:['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12'],
    quarters:['Q1','Q2','Q3','Q4'],
    halves:['H1','H2']
  };
  const SORT_KEYS=[
    {idx:0,key:'indicator_name',type:'text'},
    {idx:1,key:'period_sort',type:'number'},
    {idx:2,key:'issue_text',type:'text'},
    {idx:3,key:'action_text',type:'text'},
    {idx:4,key:'action_owner',type:'text'},
    {idx:5,key:'action_due',type:'date'},
    {idx:6,key:'action_status',type:'text'},
  ];

  /* ====== Skeleton while loading ====== */
  (function skeleton(n=6){
    tbody.innerHTML=''; for(let i=0;i<n;i++){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><div class="skel" style="width:70%"></div><div class="skel mt-1" style="width:40%"></div></td>
      <td><div class="skel" style="width:80px"></div></td><td><div class="skel"></div></td>
      <td><div class="skel"></div></td><td><div class="skel" style="width:120px"></div></td>
      <td><div class="skel" style="width:84px"></div></td><td><div class="skel" style="width:160px"></div></td>`;
      tbody.appendChild(tr);
    }
  })();

  /* ====== Lookups & data ====== */
  const [indicators, units, depts] = await Promise.all([
    gasList('indicators').catch(()=>[]),
    gasList('units').catch(()=>[]),
    gasList('departments').catch(()=>[]),
  ]);
  const indById = new Map((indicators||[]).map(i=>[String(i.indicator_id), i]));
  const unitName= Object.fromEntries((units||[]).map(u=>[String(u.unit_id), u.unit_name]));
  const deptName= Object.fromEntries((depts||[]).map(d=>[String(d.department_id), d.department_name]));

  async function loadActionsSmart(){
    const d = new Date();
    const y = d.getFullYear();
    const m = 'M' + String(d.getMonth()+1).padStart(2,'0');
    let rows = await gasList('actions',{year:y,month:m}).catch(()=>[]);
    if (!rows.length) rows = await gasList('actions').catch(()=>[]);
    return rows;
  }

  ALL = (await loadActionsSmart()).map(a=>({
    ...a,
    indicator_name: a.indicator_name || indById.get(String(a.indicator_id))?.indicator_name || '',
    period_sort: periodToSortable(a.year, a.month || a.tag || '')
  }));
  window.ALL = ALL; // expose

  /* ====== Render ====== */
  function buildYearOptions(list){
    const years=[...new Set(list.map(a=>a.year).filter(Boolean))].sort((a,b)=>b-a);
    if(!years.length) years.push(new Date().getFullYear());
    ySel.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join('');
  }
  function fillTagOptions(){
    let opts='';
    if (MODE==='month')   opts = PERIOD.months.map(t=>`<option value="${t}">${t}</option>`).join('');
    else if (MODE==='quarter') opts = PERIOD.quarters.map(t=>`<option value="${t}">${t}</option>`).join('');
    else if (MODE==='half')    opts = PERIOD.halves.map(t=>`<option value="${t}">${t}</option>`).join('');
    tagSel.innerHTML = opts;
    tagWrap.style.display = (MODE==='month'||MODE==='quarter'||MODE==='half') ? '' : 'none';
  }
  function setHeaderMark(){
    thead.querySelectorAll('th').forEach(th=>{ th.classList.remove('sorted-asc','sorted-desc'); th.querySelector('.sort-mark')?.remove(); });
    if(sortBy==null) return;
    const conf=SORT_KEYS.find(c=>c.key===sortBy); if(!conf) return;
    const th=thead.querySelectorAll('th')[conf.idx];
    const m=document.createElement('span'); m.className='sort-mark'; m.textContent= sortDir===1?' ▲':' ▼';
    th.appendChild(m); th.classList.add(sortDir===1?'sorted-asc':'sorted-desc');
  }
  function applySort(rows){
    if(!sortBy) return rows;
    const conf=SORT_KEYS.find(c=>c.key===sortBy); if(!conf) return rows;
    const {type,key}=conf;
    return rows.slice().sort((a,b)=>{
      let va=a[key], vb=b[key];
      if(type==='date'){ va=va?+new Date(va):0; vb=vb?+new Date(vb):0; return (va-vb)*sortDir; }
      if(type==='text'){ return String(va||'').localeCompare(String(vb||''),'km-KH',{numeric:true,sensitivity:'base'})*sortDir; }
      return ((va||0)-(vb||0))*sortDir;
    });
  }
  function updateSummary(rows){
    const low=v=>String(v||'').toLowerCase();
    const planned=rows.filter(a=>low(a.action_status)==='planned').length;
    const ongoing=rows.filter(a=>low(a.action_status)==='ongoing' || low(a.action_status)==='in-progress').length;
    const done   =rows.filter(a=>low(a.action_status)==='done' || low(a.action_status)==='completed').length;
    const blocked=rows.filter(a=>low(a.action_status)==='blocked').length;
    sumEl.textContent=`សរុប ${rows.length} • បានគ្រោង ${planned} • កំពុងដំណើរការ ${ongoing} • បានបញ្ចប់ ${done} • ឧបសគ្គ ${blocked}`;
  }
  function matches(a, mode, year, tag){
    if(mode==='all') return true;
    if(String(a.year)!==String(year)) return false;
    const t=String(a.month||a.tag||'').toUpperCase();
    if(mode==='year') return t==='Y12';
    if(mode==='month') return /^M\d{2}$/.test(t) && t===tag;
    if(mode==='quarter') return /^Q[1-4]$/.test(t) && t===tag;
    if(mode==='half') return /^H[12]$/.test(t) && t===tag;
    return true;
  }
  function renderRows(rows){
    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
    } else {
      const frag=document.createDocumentFragment();
      for (const a of rows){
        const ind=indById.get(String(a.indicator_id));
        const depId=a.department_id ?? ind?.department_id ?? '';
        const depLbl= deptName[String(depId)]||'';
        const unitLbl= a.unit_id ? (unitName[String(a.unit_id)]||'') : '';
        const actionId = a.action_id ?? a.actionId ?? a.id ?? '';

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>
            <div class="fw-semibold">${esc(ind?.indicator_name || a.indicator_id || '')}</div>
            <div class="small text-muted">${esc(depLbl)}${unitLbl?` / ${esc(unitLbl)}`:''}</div>
          </td>
          <td>${esc(pretty(a.year, a.month || a.tag))}</td>
          <td>${esc(a.issue_text || '')}</td>
          <td>${esc(a.action_text || '')}</td>
          <td>${esc(Array.isArray(a.action_owner)?a.action_owner.join(', '):(a.action_owner||''))}</td>
          <td>${fmtDate(a.action_due)}</td>
          <td class="text-end">
            <span class="badge-status ${statusClass(a.action_status)}">${esc(khStatusLabel(a.action_status))}</span>
            ${ (SUPER && actionId) ? `<button class="btn btn-sm btn-outline-danger ms-2 btn-del" data-del="${esc(actionId)}">លុប</button>` : '' }
          </td>`;
        frag.appendChild(tr);
      }
      tbody.replaceChildren(frag);
    }
  }

  /* ====== First paint ====== */
  buildYearOptions(ALL);
  const first = ALL.slice().sort((a,b)=>(a.action_due?+new Date(a.action_due):Infinity)-(b.action_due?+new Date(b.action_due):Infinity));
  renderRows(first); updateSummary(first); setHeaderMark(); fillTagOptions();

  /* ====== Events: filter/sort ====== */
  segBtns.forEach(b=>b.addEventListener('click', ()=>{
    segBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); MODE=b.dataset.type; fillTagOptions();
  }));
  btnApply?.addEventListener('click', ()=>{
    const year=String(ySel.value||''); const tag=String(tagSel.value||'').toUpperCase();
    const rows=ALL.filter(a=>matches(a, MODE, year, tag));
    renderRows(applySort(rows)); updateSummary(rows); setHeaderMark();
  });
  btnReset?.addEventListener('click', ()=>{
    MODE='all'; segBtns.forEach(x=>x.classList.toggle('active',x.dataset.type==='all')); fillTagOptions();
    const rows=applySort(ALL);
    renderRows(rows); updateSummary(rows); setHeaderMark();
  });
  thead.addEventListener('click',(e)=>{
    const th=e.target.closest('th'); if(!th) return;
    const idx=[...thead.querySelectorAll('th')].indexOf(th);
    const conf=SORT_KEYS.find(c=>c.idx===idx); if(!conf) return;
    if(sortBy===conf.key){ sortDir*=-1; } else { sortBy=conf.key; sortDir=1; }
    const year=String(ySel.value||''); const tag=String(tagSel.value||'').toUpperCase();
    const base=(MODE==='all')?ALL:ALL.filter(a=>matches(a, MODE, year, tag));
    const rows=applySort(base);
    renderRows(rows); updateSummary(base); setHeaderMark();
  });

  /* ====== Delete (SUPER only) ====== */
  if (SUPER) {
    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-del]'); if(!btn) return;
      const id  = btn.getAttribute('data-del'); if(!id) return alert('មិនមាន action_id ដើម្បីលុប');
      if(!confirm('លុបធាតុនេះមែនទេ?')) return;
      try{
        const idField = (window.ID_FIELDS && window.ID_FIELDS.actions) || 'action_id';
        await gasDelete('actions', idField, id);
        ALL = ALL.filter(r => String(r.action_id ?? r.actionId ?? r.id) !== String(id));
        const year=String(ySel.value||''); const tag=String(tagSel.value||'').toUpperCase();
        const base=(MODE==='all')?ALL:ALL.filter(a=>matches(a, MODE, year, tag));
        renderRows(applySort(base)); updateSummary(base);
      }catch(err){ console.error(err); alert('បរាជ័យលុប: '+(err?.message||err)); }
    }, { passive:true });
  }

  /* ======================== Google Docs PDF (no HTML inside JS) ======================== */

  // UTF-8 → Base64 (safe)
  function toB64UTF8(obj){
    const s = JSON.stringify(obj);
    return btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g, (_,h)=>String.fromCharCode('0x'+h)));
  }

  // ប្រមូល meta + rows ពី UI state បច្ចុប្បន្ន
  function gatherMetaRows(){
    const year = String(ySel?.value || new Date().getFullYear());
    const activeBtn = document.querySelector('.segbtn.active');
    const CUR_MODE = activeBtn ? activeBtn.dataset.type : MODE;
    const tag  = String(tagSel?.value || '').toUpperCase();

    const base = (CUR_MODE==='all') ? (ALL||[]) : (ALL||[]).filter(a=>{
      if (String(a.year)!==String(year)) return false;
      const t=String(a.month||a.tag||'').toUpperCase();
      if (CUR_MODE==='year')    return t==='Y12';
      if (CUR_MODE==='month')   return /^M\d{2}$/.test(t) && t===tag;
      if (CUR_MODE==='quarter') return /^Q[1-4]$/.test(t) && t===tag;
      if (CUR_MODE==='half')    return /^H[12]$/.test(t) && t===tag;
      return true;
    });

    const rows = base.slice()
      .sort((a,b)=>(a.action_due?+new Date(a.action_due):Infinity)-(b.action_due?+new Date(b.action_due):Infinity))
      .map(a=>({
        indicator_id   : a.indicator_id,
        indicator_name : a.indicator_name,
        department_name: a.department_name,
        unit_name      : a.unit_name,
        year           : a.year,
        month          : a.month || a.tag,
        issue_text     : a.issue_text,
        action_text    : a.action_text,
        action_owner   : Array.isArray(a.action_owner)? a.action_owner.join(', ') : (a.action_owner||''),
        action_due     : a.action_due || '',
        action_status  : a.action_status || ''
      }));

    const meta = {
      year,
      tag : (CUR_MODE==='all') ? '' : (tag || ('M'+String(new Date().getMonth()+1).padStart(2,'0'))),
      summaryText: (sumEl?.textContent || '').trim(),
      org1:'មន្ទីរសុខាភិបាលខេត្ត',
      org2:'ផ្នែកផែនការ និងត្រួតពិនិត្យ',
      title1:'របាយការណ៍បញ្ហាប្រឈម',
      title2:'និង សកម្មភាព ដោះស្រាយ'
    };
    return { meta, rows };
  }

  // បង្កើត hidden form ដោយ JS (គ្មាន HTML ក្នុង module)
  function ensureHiddenForm(){
    let form = document.getElementById('pdfForm');
    if (!form){
      form = document.createElement('form');
      form.id = 'pdfForm';
      form.action = `${GAS_WEBAPP}?route=issuesPdf&dl=1`;
      form.method = 'POST';
      form.target = '_blank';
      form.style.display = 'none';
      const input = document.createElement('input');
      input.type = 'hidden'; input.name = 'payload'; input.id = 'payloadB64';
      form.appendChild(input);
      document.body.appendChild(form);
    }
    return form;
  }

  function triggerDocsPdf(){
    const { meta, rows } = gatherMetaRows();
    const form = ensureHiddenForm();
    const input = document.getElementById('payloadB64');
    input.value = toB64UTF8({ meta, rows });
    form.submit(); // open new tab + download
  }

  if (btnPdf){
    const t = btnPdf.textContent;
    btnPdf.addEventListener('click', ()=>{
      btnPdf.disabled = true; btnPdf.textContent = 'កំពុងបង្កើត…';
      try{ triggerDocsPdf(); }
      finally{ setTimeout(()=>{ btnPdf.disabled=false; btnPdf.textContent=t; }, 1200); }
    });
  }
}








/* ======================= Indicators ======================= */
  async function initIndicators(){
    const auth   = getAuth();
    const SUPER  = isSuper(auth);

    const table   = document.getElementById('tblIndicators');
    const tbody   = table?.querySelector('tbody');
    const btnAdd  = document.getElementById('btnAdd');
    const frm     = document.getElementById('frmIndicator');
    const selDept = document.getElementById('department_id');
    const selUnit = document.getElementById('unit_id');
    const selOwner= document.getElementById('owner_id');
    const btnSave = document.getElementById('btnSave');
    const modal   = makeModal('mdlIndicator');

    if (!table || !tbody || !btnAdd || !frm || !selDept || !selUnit || !btnSave) return;

    let CACHE = { departments:[], unitsAll:[], usersAll:[], indicators:[], unitsByDep:new Map() };
    let MAPS  = { deptName:{}, unitName:{}, userName:{} };

    const setStatus = m=>{ const el=document.getElementById('statusLine'); if(el) el.textContent=m||''; };
    const skel=()=>{ tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="6" class="skel"></td>`; tbody.appendChild(tr);} };
    skel();

    try{
      let [depts, inds] = await Promise.all([
        gasList('departments'),
        gasList('indicators')
      ]);

      if (!SUPER && auth?.department_id){
        const depId=String(auth.department_id);
        depts = depts.filter(d=>String(d.department_id)===depId);
        inds  = inds.filter(r=>String(r.department_id)===depId);
      }

      let unitsAll = SUPER ? await gasList('units')
                           : await gasList('units',{department_id:auth?.department_id||''});

      let usersAll=[];
      if (selOwner){
        if (SUPER) usersAll = await gasList('users');
        else usersAll=[{user_id:auth?.user_id,user_name:auth?.user_name,full_name:auth?.full_name}];
      }

      CACHE.departments=depts||[];
      CACHE.unitsAll=unitsAll||[];
      CACHE.usersAll=usersAll||[];
      CACHE.indicators=inds||[];

      MAPS.deptName = Object.fromEntries(CACHE.departments.map(d=>[String(d.department_id),d.department_name]));
      MAPS.unitName = Object.fromEntries(CACHE.unitsAll.map(u=>[String(u.unit_id),u.unit_name]));
      MAPS.userName = Object.fromEntries(CACHE.usersAll.map(u=>[String(u.user_id),(u.full_name||u.user_name||('User#'+u.user_id))]));

      await fillDeptSelect(SUPER?'':auth?.department_id);
      await fillUnitSelect(SUPER?selDept.value:auth?.department_id, SUPER?'':auth?.unit_id);

      if (selOwner){
        if (SUPER){
          selOwner.innerHTML=`<option value="">— ជ្រើសម្ចាស់ —</option>`+
            CACHE.usersAll.map(u=>`<option value="${u.user_id}">${MAPS.userName[String(u.user_id)]}</option>`).join('');
          selOwner.disabled=false;
        } else {
          selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`;
          selOwner.disabled=true;
        }
      }

      const usersById=Object.fromEntries((CACHE.usersAll||[]).map(u=>[String(u.user_id),u]));
      selOwner?.addEventListener('change',async()=>{
        if(!SUPER) return;
        const u=usersById[String(selOwner.value||'')];
        if(!u) return;
        selDept.value=u.department_id||'';
        selDept.disabled=false;
        await fillUnitSelect(u.department_id,u.unit_id||'');
        selUnit.disabled=false;
        setStatus(`Aligned to ${u.full_name||u.user_name}`);
      });

      renderTable();
      setStatus(`បានផ្ទុក ${CACHE.indicators.length} សូចនាករ`);
    }catch(e){
      console.error(e);
      tbody.innerHTML=`<tr><td colspan="6" class="text-center text-danger py-4">បរាជ័យផ្ទុកទិន្នន័យ</td></tr>`;
      setStatus('បរាជ័យផ្ទុកទិន្នន័យ');
    }

    async function fillDeptSelect(selected){
      selDept.innerHTML=`<option value="">— ជ្រើសការិយាល័យ —</option>`+
        CACHE.departments.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
      if(selected) selDept.value=selected;
      selDept.disabled=!SUPER;
    }
    async function fillUnitSelect(depId,selected){
      selUnit.innerHTML=`<option value="">— ជ្រើសផ្នែក —</option>`;
      if(!depId){ selUnit.disabled=true; return; }
      let units=CACHE.unitsByDep.get(String(depId));
      if(!units){
        const fromAll=CACHE.unitsAll.filter(u=>String(u.department_id)===String(depId));
        units=fromAll.length?fromAll:await gasList('units',{department_id:depId});
        CACHE.unitsByDep.set(String(depId),units);
        for(const u of units) MAPS.unitName[String(u.unit_id)]=u.unit_name;
      }
      selUnit.innerHTML=`<option value="">— ជ្រើសផ្នែក —</option>`+(units||[]).map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
      if(selected) selUnit.value=selected;
      selUnit.disabled=!SUPER;
    }

    function canEditRow(ind){
      if(SUPER) return true;
      return String(ind.department_id)===String(auth?.department_id||'')
          && String(ind.unit_id||'')===String(auth?.unit_id||'')
          && String(ind.owner_id||'')===String(auth?.user_id||'');
    }

    function renderTable(){
      if(!CACHE.indicators.length){
        tbody.innerHTML=`<tr><td colspan="7" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
        return;
      }
      const frag=document.createDocumentFragment();
      for(const ind of CACHE.indicators){
        const depN   = MAPS.deptName[String(ind.department_id)]||'';
        const unitN  = MAPS.unitName[String(ind.unit_id)]||'';
        const ownerN = MAPS.userName[String(ind.owner_id)]||'';
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${ind.indicator_id}</td>
          <td>${ind.indicator_name||''}</td>
          <td>${ind.indicator_type||''}</td>
          <td>${depN}</td>
          <td>${unitN}</td>
          <td>${ownerN||''}</td>
          <td class="text-end">
            ${canEditRow(ind)
              ? `<button class="btn btn-sm btn-warning me-1" data-act="edit" data-id="${ind.indicator_id}">កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${ind.indicator_id}">លុប</button>`
              : `<span class="text-muted">—</span>`}
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML='';
      tbody.appendChild(frag);
    }

    selDept.addEventListener('change',e=>fillUnitSelect(e.target.value,''));
    btnAdd.addEventListener('click',async()=>{
      frm.reset(); document.getElementById('indicator_id').value='';
      if(SUPER){
        selDept.disabled=false; await fillUnitSelect(selDept.value,'');
        if(selOwner){ selOwner.disabled=false; selOwner.value=''; }
      }else{
        selDept.value=auth?.department_id||''; selDept.disabled=true;
        await fillUnitSelect(auth?.department_id,auth?.unit_id); selUnit.disabled=true;
        if(selOwner){
          selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`;
          selOwner.disabled=true;
        }
      }
      modal?.show();
    });

    tbody.addEventListener('click',async e=>{
      const btn=e.target.closest('button[data-act]'); if(!btn) return;
      const id=btn.getAttribute('data-id');
      const row=CACHE.indicators.find(x=>String(x.indicator_id)===String(id));
      if(!row) return;

      if(btn.dataset.act==='edit'){
        if(!canEditRow(row) && !SUPER) return alert('Permission denied');
        frm.reset();
        document.getElementById('indicator_id').value=row.indicator_id;
        document.getElementById('indicator_name').value=row.indicator_name||'';
        document.getElementById('indicator_type').value=row.indicator_type||'';
        selDept.value=row.department_id||''; if(!SUPER) selDept.disabled=true;
        await fillUnitSelect(row.department_id,row.unit_id||''); if(!SUPER) selUnit.disabled=true;
        if(selOwner){
          if(SUPER){ selOwner.value=row.owner_id||''; selOwner.disabled=false; }
          else{ selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`; selOwner.disabled=true; }
        }
        modal?.show();
      }

      if(btn.dataset.act==='del'){
        if(!canEditRow(row) && !SUPER) return alert('Permission denied');
        if(!confirm('លុបមែនទេ?')) return;
        try{
          await gasDelete('indicators',ID_FIELDS.indicators,row.indicator_id);
          CACHE.indicators=CACHE.indicators.filter(x=>String(x.indicator_id)!==String(id));
          renderTable();
        }catch(err){ alert('បរាជ័យលុប: '+(err?.message||err)); }
      }
    });

    frm.addEventListener('submit',async e=>{
      e.preventDefault();
      const payload={
        indicator_id  : document.getElementById('indicator_id').value||null,
        indicator_name: document.getElementById('indicator_name').value.trim(),
        indicator_type: document.getElementById('indicator_type').value.trim(),
        department_id : SUPER?selDept.value:(auth?.department_id||''),
        unit_id       : SUPER?selUnit.value:(auth?.unit_id||'')
      };
      if(selOwner) payload.owner_id=SUPER?(selOwner.value||''):(auth?.user_id||'');

      const nameEl=document.getElementById('indicator_name');
      nameEl.classList.toggle('is-invalid',!payload.indicator_name);
      if(!payload.indicator_name) return;

      const old=btnSave.innerHTML; btnSave.disabled=true; btnSave.innerHTML='កំពុងរក្សាទុក…';
      try{
        const saved=await gasSave('indicators',payload);
        const row=saved.row||saved;
        const i=CACHE.indicators.findIndex(x=>String(x.indicator_id)===String(row.indicator_id));
        if(i>=0) CACHE.indicators[i]=row; else CACHE.indicators.push(row);
        renderTable(); modal?.hide();
        setStatus('រក្សាទុករួចរាល់');
      }catch(err){ alert('បរាជ័យរក្សាទុក: '+(err?.message||err)); }
      finally{ btnSave.disabled=true; btnSave.innerHTML=old; btnSave.disabled=false; }
    });
  }

  /* ======================= Users ======================= */
  async function initUsers(){
    const auth  = getAuth();
    const SUPER = isSuper(auth);

    const tbl      = document.getElementById('tblUsers');
    const tbody    = tbl?.querySelector('tbody');
    const btnAdd   = document.getElementById('btnAddUser');
    const frm      = document.getElementById('frmUser');
    const modal    = makeModal('mdlUser');

    const idEl     = document.getElementById('user_id');
    const nameEl   = document.getElementById('user_name');
    const fullEl   = document.getElementById('full_name');
    const roleEl   = document.getElementById('user_type');
    const passEl   = document.getElementById('user_pass');
    const selDept  = document.getElementById('department_id');
    const selUnit  = document.getElementById('unit_id');
    const btnSave  = document.getElementById('btnSaveUser');
    const txtQ     = document.getElementById('txtSearchUsers');
    const $status  = (m)=>{ const el=document.getElementById('statusUsers'); if(el) el.textContent=m||''; };

    if (!tbl || !tbody || !btnAdd || !frm || !idEl || !nameEl || !roleEl || !selDept || !selUnit || !btnSave) return;

    (function skel(){ tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="6" class="skel"></td>`; tbody.appendChild(tr);} })();

    let ROWS = []; let DEPTS = []; let UNITS = [];
    let FILTER_Q = '';  let SORT = { key:'user_id', dir:1 };

    const deptName=(id)=> DEPTS.find(d=>String(d.department_id)===String(id))?.department_name || '';
    const unitName=(id)=> UNITS.find(u=>String(u.unit_id)===String(id))?.unit_name || '';
    const badgeRole = (r)=>{
      const v = String(r||'').toLowerCase();
      const cls = v==='super' || v==='superuser' ? 'bg-primary'
                : v==='admin'                    ? 'bg-warning text-dark'
                : v.includes('data')             ? 'bg-success'
                : 'bg-secondary';
      const txt = v==='superuser' ? 'super' : v;
      return `<span class="badge ${cls} text-uppercase">${txt||'viewer'}</span>`;
    };

    try{
      [ROWS, DEPTS, UNITS] = await Promise.all([
        gasList('users'),
        gasList('departments'),
        gasList('units'),
      ]);
      render(); $status(`បានផ្ទុក ${ROWS.length} អ្នកប្រើប្រាស់`);
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
      $status('បរាជ័យទាញទិន្នន័យ');
    }

    function fillDeptSelect(selected){
      selDept.innerHTML = `<option value="">— ជ្រើសការិយាល័យ —</option>`+
        DEPTS.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
      if (selected) selDept.value = selected;
      selDept.disabled = !SUPER;
    }
    function fillUnitSelect(depId, selected){
      selUnit.innerHTML = `<option value="">— ជ្រើសផ្នែក —</option>`;
      if (!depId){ selUnit.disabled = true; return; }
      const list = UNITS.filter(u=>String(u.department_id)===String(depId));
      selUnit.innerHTML = `<option value="">— ជ្រើសផ្នែក —</option>`+
        list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
      if (selected) selUnit.value = selected;
      selUnit.disabled = !SUPER;
    }

    function render(){
      let list = ROWS.slice();
      if (FILTER_Q){
        const q = FILTER_Q;
        list = list.filter(r=>{
          const hay = `${r.user_id} ${r.user_name||''} ${r.full_name||''} ${r.user_type||''} ${deptName(r.department_id)} ${unitName(r.unit_id)}`.toLowerCase();
          return hay.includes(q);
        });
      }
      list.sort((a,b)=>{
        const key = SORT.key;
        const av = (a[key] ?? '').toString();
        const bv = (b[key] ?? '').toString();
        return av.localeCompare(bv, undefined, { numeric:true, sensitivity:'base' }) * SORT.dir;
      });

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const r of list){
        const tr = document.createElement('tr');
        tr.dataset.id = r.user_id;
        tr.innerHTML = `
          <td style="width:80px"><span class="badge text-bg-light border">#${r.user_id}</span></td>
          <td>${r.user_name || ''}</td>
          <td>${r.full_name || ''}</td>
          <td style="width:140px">${badgeRole(r.user_type)}</td>
          <td>${deptName(r.department_id)}${r.unit_id?` / ${unitName(r.unit_id)}`:''}</td>
          <td class="text-end" style="width:160px">
            ${SUPER
              ? `<button class="btn btn-sm btn-warning me-1" data-act="edit"><i class="bi bi-pencil-square"></i> កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del"><i class="bi bi-trash"></i> លុប</button>`
              : `<span class="text-muted">—</span>`}
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);

      tbl.querySelectorAll('th.th-sort').forEach(th=>{
        th.classList.remove('asc','desc');
        if (th.dataset.sort === SORT.key) th.classList.add(SORT.dir===1?'asc':'desc');
      });
    }

    txtQ?.addEventListener('input', e=>{
      FILTER_Q = String(e.target.value||'').trim().toLowerCase();
      render();
    });

    tbl.querySelectorAll('th.th-sort').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort;
        if (!key) return;
        if (SORT.key === key) SORT.dir *= -1; else { SORT.key=key; SORT.dir=1; }
        render();
      });
    });

    btnAdd.addEventListener('click', ()=>{
      if (!SUPER) return alert('ត្រូវការ SUPER');
      frm.reset();
      idEl.value = '';
      roleEl.value = 'viewer';
      fillDeptSelect('');
      fillUnitSelect('', '');
      nameEl.classList.remove('is-invalid');
      roleEl.classList.remove('is-invalid');
      modal?.show();
    });

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if (!btn) return;
      if (!SUPER) return alert('ត្រូវការ SUPER');

      const id  = btn.closest('tr')?.dataset?.id;
      const row = ROWS.find(x=>String(x.user_id)===String(id));
      if (!row) return;

      if (btn.dataset.act==='edit'){
        frm.reset();
        idEl.value   = row.user_id;
        nameEl.value = row.user_name || '';
        fullEl.value = row.full_name || '';
        roleEl.value = (row.user_type || 'viewer').toLowerCase();
        passEl.value = '';
        fillDeptSelect(row.department_id || '');
        fillUnitSelect(row.department_id || '', row.unit_id || '');
        nameEl.classList.remove('is-invalid');
        roleEl.classList.remove('is-invalid');
        modal?.show();
      }

      if (btn.dataset.act==='del'){
        if (!confirm('លុបអ្នកប្រើប្រាស់នេះមែនទេ?')) return;
        try{
          await gasDelete('users', ID_FIELDS.users, row.user_id);
          ROWS = ROWS.filter(x=>String(x.user_id)!==String(id));
          render(); $status('លុបរួចរាល់');
        }catch(err){ alert('បរាជ័យលុប: '+(err?.message||err)); }
      }
    });

    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!SUPER) return alert('ត្រូវការ SUPER');

      const payload = {
        user_id      : idEl.value || null,
        user_name    : (nameEl.value||'').trim(),
        full_name    : (fullEl.value||'').trim(),
        user_type    : (roleEl.value||'viewer'),
        department_id: selDept.value || '',
        unit_id      : selUnit.value || '',
      };
      const pw = (passEl.value||'').trim();
      if (pw) payload.user_pass = pw;

      nameEl.classList.toggle('is-invalid', !payload.user_name);
      roleEl.classList.toggle('is-invalid', !payload.user_type);
      if (!payload.user_name || !payload.user_type) return;

      const old = btnSave.innerHTML; btnSave.disabled = true; btnSave.innerHTML = 'កំពុងរក្សាទុក…';
      try{
        const saved = await gasSave('users', payload);
        const row   = saved.row || saved;
        const i     = ROWS.findIndex(x=>String(x.user_id)===String(row.user_id));
        if (i>=0) ROWS[i] = row; else ROWS.push(row);
        render(); modal?.hide(); $status('រក្សាទុករួចរាល់');
      }catch(err){
        alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
      }finally{
        btnSave.disabled = false; btnSave.innerHTML = old;
      }
    });

    selDept.addEventListener('change', ()=> fillUnitSelect(selDept.value,''));
  }

  /* ======================= Departments ======================= */
  async function initDepartments(){
    const auth  = getAuth();
    const SUPER = isSuper(auth);

    const tbl     = document.getElementById('tblDepts');
    const tbody   = tbl?.querySelector('tbody');
    const btnAdd  = document.getElementById('btnAddDept');
    const frm     = document.getElementById('frmDept');
    const modal   = makeModal('mdlDept');
    const idEl    = document.getElementById('department_id');
    const nameEl  = document.getElementById('department_name');
    const txtQ    = document.getElementById('txtSearchDept');
    const $status = (m)=>{ const el=document.getElementById('statusDept'); if(el) el.textContent=m||''; };

    if (!tbl || !tbody || !btnAdd || !frm || !idEl || !nameEl) return;

    (function skel(){ tbody.innerHTML=''; for(let i=0;i<3;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="3" class="skel"></td>`; tbody.appendChild(tr);} })();

    let ROWS = [];
    let FILTER_Q = '';
    let SORT = { key:'department_id', dir:1 };

    try{
      ROWS = await gasList('departments');
      render();
      $status(`បានផ្ទុក ${ROWS.length} នាយកដ្ឋាន`);
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
      $status('បរាជ័យទាញទិន្នន័យ');
    }

    function render(){
      let list = ROWS.slice();
      if (FILTER_Q){
        const q = FILTER_Q;
        list = list.filter(r =>
          String(r.department_id).toLowerCase().includes(q) ||
          String(r.department_name||'').toLowerCase().includes(q)
        );
      }
      const k = SORT.key;
      list.sort((a,b)=>{
        const av = (a[k] ?? '').toString();
        const bv = (b[k] ?? '').toString();
        return av.localeCompare(bv, undefined, {numeric:true, sensitivity:'base'}) * SORT.dir;
      });

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const r of list){
        const tr = document.createElement('tr');
        tr.dataset.id = r.department_id;
        tr.innerHTML = `
          <td style="width:110px"><span class="badge text-bg-light border">#${r.department_id}</span></td>
          <td>${r.department_name || ''}</td>
          <td class="td-actions text-end" style="width:160px">
            <div class="actions-right">
              ${SUPER
                ? `<button class="btn btn-sm btn-warning" data-act="edit">កែ</button>
                   <button class="btn btn-sm btn-danger"  data-act="del">លុប</button>`
                : `<span class="text-muted">—</span>`}
            </div>
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);

      tbl.querySelectorAll('th.th-sort').forEach(th=>{
        th.classList.remove('asc','desc');
        if (th.dataset.sort === SORT.key) th.classList.add(SORT.dir===1?'asc':'desc');
      });
    }

    txtQ?.addEventListener('input', e=>{
      FILTER_Q = String(e.target.value||'').trim().toLowerCase();
      render();
    });

    tbl.querySelectorAll('th.th-sort').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort;
        if (!key) return;
        if (SORT.key === key) SORT.dir *= -1; else { SORT.key = key; SORT.dir = 1; }
        render();
      });
    });

    btnAdd.addEventListener('click', ()=>{
      if (!SUPER) return alert('ត្រូវការ SUPER');
      frm.reset();
      idEl.value   = '';
      nameEl.value = '';
      nameEl.classList.remove('is-invalid');
      modal?.show();
    });

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      if (!SUPER) return alert('ត្រូវការ SUPER');

      const id  = btn.closest('tr')?.dataset?.id;
      const row = ROWS.find(x=>String(x.department_id)===String(id));
      if (!row) return;

      if (btn.dataset.act === 'edit'){
        idEl.value   = row.department_id;
        nameEl.value = row.department_name || '';
        nameEl.classList.remove('is-invalid');
        modal?.show();
      }

      if (btn.dataset.act === 'del'){
        if (!confirm('តើចង់លុបធាតុនេះមែនទេ?')) return;
        try{
          await gasDelete('departments', ID_FIELDS.departments, row.department_id);
          ROWS = ROWS.filter(x=>String(x.department_id)!==String(id));
          render(); $status('លុបរួចរាល់');
        }catch(err){
          console.error(err);
          alert('បរាជ័យលុប: ' + (err?.message || err));
        }
      }
    });

    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!SUPER) return alert('ត្រូវការ SUPER');

      const name = (nameEl.value||'').trim();
      nameEl.classList.toggle('is-invalid', !name);
      if (!name) return;

      const payload = idEl.value
        ? { department_id: Number(idEl.value), department_name: name }
        : { department_name: name };

      const btn = document.getElementById('btnSaveDept');
      const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'កំពុងរក្សាទុក…';
      try{
        const res = await gasSave('departments', payload);
        const row = res.row || res;
        const i = ROWS.findIndex(x=>String(x.department_id)===String(row.department_id));
        if (i>=0) ROWS[i]=row; else ROWS.push(row);
        render(); modal?.hide(); $status('រក្សាទុករួចរាល់');
      }catch(err){
        console.error(err);
        alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
      }finally{
        btn.disabled = false; btn.innerHTML = old;
      }
    });
  }

  /* ======================= Units ======================= */
  async function initUnits(){
    const auth = getAuth(); const SUPER = isSuper(auth);
    const tbody = document.querySelector('#tblUnits tbody');
    const btnAdd= document.getElementById('btnAddUnit');
    const frm   = document.getElementById('frmUnit');
    const modal = makeModal('mdlUnit');
    const idEl  = document.getElementById('unit_id');
    const nameEl= document.getElementById('unit_name');
    const selDept = document.getElementById('department_id');
    const status= (m)=>{ const el=document.getElementById('statusUnit'); if(el) el.textContent=m||''; };

    if (!tbody || !btnAdd || !frm || !idEl || !nameEl || !selDept) return;

    let depts = [], rows = [];
    const skel=()=>{ tbody.innerHTML=''; for(let i=0;i<3;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="4" class="skel"></td>`; tbody.appendChild(tr);} };
    skel();

    try{
      depts = await gasList('departments');
      if (!SUPER && auth?.department_id){ depts = depts.filter(d=>String(d.department_id)===String(auth.department_id)); }
      rows = await gasList('units', SUPER?{}:{ department_id: auth?.department_id });
      fillDeptSelect(); render(rows);
      status(`បានផ្ទុក ${rows.length} ផ្នែក`);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="4" class="text-danger text-center py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
      status('បរាជ័យទាញទិន្នន័យ');
    }

    function fillDeptSelect(selected){
      selDept.innerHTML = `<option value="">— ជ្រើសការិយាល័យ —</option>`+
        depts.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
      selDept.disabled = !SUPER;
      if (selected) selDept.value = selected; else if(!SUPER) selDept.value = auth?.department_id || '';
    }
    function deptName(id){ return (depts.find(d=>String(d.department_id)===String(id))?.department_name)||''; }
    function render(list){
      if(!list.length){ tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
      const frag = document.createDocumentFragment();
      for (const r of list){
        const tr = document.createElement('tr');
        tr.dataset.id = r.unit_id;
        tr.innerHTML = `
          <td style="width:90px">${r.unit_id}</td>
          <td>${r.unit_name||''}</td>
          <td style="width:220px">${deptName(r.department_id)}</td>
          <td class="text-end" style="width:160px">
            ${SUPER
              ? `<button class="btn btn-sm btn-warning me-1" data-act="edit">កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del">លុប</button>`
              : `<span class="text-muted">—</span>`}
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML=''; tbody.appendChild(frag);
    }

    btnAdd.addEventListener('click', ()=>{ frm.reset(); idEl.value=''; fillDeptSelect(); modal?.show(); });
    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      const id  = btn.closest('tr')?.dataset?.id;
      const row = rows.find(x=>String(x.unit_id)===String(id));
      if (btn.dataset.act==='edit'){
        idEl.value = row.unit_id; nameEl.value = row.unit_name||''; fillDeptSelect(row.department_id); modal?.show();
      }
      if (btn.dataset.act==='del'){
        if (!confirm('លុបមែនទេ?')) return;
        try{ await gasDelete('units', ID_FIELDS.units, row.unit_id);
             rows = rows.filter(x=>String(x.unit_id)!==String(id)); render(rows); }
        catch(err){ alert(err?.message||err); }
      }
    });
    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=nameEl.value.trim(); nameEl.classList.toggle('is-invalid', !name); if(!name) return;
      const dep = SUPER ? selDept.value : (auth?.department_id || '');
      if (!dep){ alert('សូមជ្រើសការិយាល័យ'); return; }
      const payload = idEl.value ? { unit_id:Number(idEl.value), unit_name:name, department_id:dep }
                                 : { unit_name:name, department_id:dep };
      const btn = document.getElementById('btnSaveUnit'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='កំពុងរក្សាទុក…';
      try{
        const res = await gasSave('units', payload);
        const row = res.row || res;
        const i = rows.findIndex(x=>String(x.unit_id)===String(row.unit_id));
        if (i>=0) rows[i]=row; else rows.push(row);
        render(rows); modal?.hide();
      }catch(err){ alert(err?.message||err); }
      finally{ btn.disabled=false; btn.innerHTML=old; }
    });
  }

  /* ======================= Periods ======================= */
  async function initPeriods(){
    const SUPER = isSuper(getAuth());

    const table    = document.getElementById('tblPeriods');
    const tbody    = table?.querySelector('tbody');
    const ths      = Array.from(table?.querySelectorAll('thead th.th-sort') || []);
    const selYear  = document.getElementById('selYear');
    const txtSearch= document.getElementById('txtSearch');
    const btnGen   = document.getElementById('btnGenYear');

    const mdl      = makeModal('mdlPeriod');
    const frm      = document.getElementById('frmPeriod');
    const idEl     = document.getElementById('period_id');
    const nameEl   = document.getElementById('period_name');

    const PERIOD_ID_FIELD = (window.ID_FIELDS && ID_FIELDS.periods) || 'period_id';
    const $status = m => { const el=document.getElementById('statusPeriods'); if(el) el.textContent=m||''; };

    if (!table || !tbody || !selYear || !btnGen || !frm) return;
    if (!SUPER) btnGen.style.display = 'none';

    const mNames = ['មករា','កុម្ភះ','មីនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
    const getYear  = pid => ( /^(\d{4})/.exec(String(pid||'')) || [] )[1] || '';
    const getTag   = pid => ( String(pid||'').match(/(M\d{2}|Q[1-4]|H[12]|N9|Y12)$/) || [] )[1] || '';
    const pretty   = (pid, fallback='')=>{
      const y = getYear(pid), tag = getTag(pid);
      if (/^M\d{2}$/.test(tag)) return `${mNames[+tag.slice(1)-1]} ${y}`;
      if (/^(Q[1-4]|H[12])$/.test(tag)) return `${tag} ${y}`;
      if (tag==='N9')  return `៩ខែ ${y}`;
      if (tag==='Y12') return `១២ខែ ${y}`;
      return fallback || y;
    };
    const seqOf = pid=>{
      const tag=getTag(pid);
      if (/^M\d{2}$/.test(tag)) return 100+(+tag.slice(1));
      if (/^Q[1-4]$/.test(tag)) return 200+(+tag.slice(1));
      if (tag==='H1') return 301;
      if (tag==='H2') return 302;
      if (tag==='N9') return 400;
      if (tag==='Y12')return 500;
      return 9999;
    };
    const norm = r=>{
      if (Array.isArray(r)) {
        const [period_id, period_name, year, month] = r;
        return { period_id, period_name, year, month };
      }
      const period_id   = r.period_id ?? r['Period ID'] ?? r.ID ?? r.id;
      const period_name = r.period_name ?? r['ឈ្មោះ'] ?? r.name ?? r['Name'];
      const year        = r.year ?? r['Year'];
      const month       = r.month ?? r['Month'];
      return { period_id, period_name, year, month };
    };

    let ALL = [];
    const nowY = new Date().getFullYear();
    if (!selYear.options.length){
      for (let y=nowY-3;y<=nowY+3;y++){
        const o=document.createElement('option'); o.value=y; o.textContent=y; selYear.appendChild(o);
      }
    }
    selYear.value = selYear.value || String(nowY);
    let CUR_YEAR  = +selYear.value;
    let FILTER_Q  = '';
    let SORT      = { key:'id', dir:'asc' };

    const applySortClasses = ()=>{
      ths.forEach(th=>{
        th.classList.remove('active','desc');
        if (th.dataset.sort===SORT.key){ th.classList.add('active'); if (SORT.dir==='desc') th.classList.add('desc'); }
      });
    };

    tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="5" class="skel"></td>'; tbody.appendChild(tr); }

    async function load(){
      try{
        $status('កំពុងផ្ទុកទិន្នន័យ…');
        const raw = await gasList('periods').catch(()=>[]);
        ALL = raw.map(norm).filter(x=>x.period_id);
        render();
        $status(`បានផ្ទុក ${ALL.length} រយៈពេល`);
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
        $status('បរាជ័យទាញទិន្នន័យ');
      }
    }
    await load(); applySortClasses();

    function render(){
      const rows = ALL
        .filter(r => String(r.year || getYear(r.period_id)) === String(CUR_YEAR))
        .filter(r => FILTER_Q ? ( (r.period_id+' '+(r.period_name||'')+' '+pretty(r.period_id)).toLowerCase().includes(FILTER_Q) ) : true)
        .sort((a,b)=>{
          if (SORT.key==='id')   return (SORT.dir==='asc'?1:-1) * a.period_id.localeCompare(b.period_id);
          if (SORT.key==='name') return (SORT.dir==='asc'?1:-1) * ( (a.period_name||pretty(a.period_id)).toLowerCase().localeCompare((b.period_name||pretty(b.period_id)).toLowerCase()) );
          if (SORT.key==='year') return (SORT.dir==='asc'?1:-1) * ((+a.year||+getYear(a.period_id)) - (+b.year||+getYear(b.period_id)));
          if (SORT.key==='seq')  return (SORT.dir==='asc'?1:-1) * (seqOf(a.period_id) - seqOf(b.period_id));
          return 0;
        });

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
        return;
      }
      const frag = document.createDocumentFragment();
      for (const r of rows){
        const yy  = r.year || getYear(r.period_id);
        const tag = getTag(r.period_id);
        const mon = /^M\d{2}$/.test(tag) ? tag.slice(1) : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.period_id}</td>
          <td>${r.period_name || pretty(r.period_id)}</td>
          <td style="width:120px">${yy}</td>
          <td style="width:120px">${mon}</td>
          <td class="td-actions" style="width:180px">
            <div class="actions-right">
              ${SUPER
                ? `<button class="btn btn-sm btn-warning" data-act="edit" data-id="${r.period_id}">កែ</button>
                   <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${r.period_id}">លុប</button>`
                : `<span class="text-muted">—</span>`}
            </div>
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML=''; tbody.appendChild(frag);
    }

    ths.forEach(th=>{
      th.addEventListener('click', ()=>{
        const k = th.dataset.sort;
        if (SORT.key===k) SORT.dir = (SORT.dir==='asc' ? 'desc' : 'asc');
        else { SORT.key=k; SORT.dir='asc'; }
        applySortClasses(); render();
      });
    });
    txtSearch?.addEventListener('input', e=>{ FILTER_Q = String(e.target.value||'').trim().toLowerCase(); render(); });
    const onYear = ()=>{ CUR_YEAR = +selYear.value || nowY; render(); };
    selYear.addEventListener('change', onYear);
    selYear.addEventListener('input',  onYear);

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      const id  = btn.dataset.id;
      const row = ALL.find(x=>String(x.period_id)===String(id)); if(!row) return;

      if (btn.dataset.act==='edit'){
        idEl.value = row.period_id;
        nameEl.value = row.period_name || pretty(row.period_id);
        nameEl.classList.remove('is-invalid');
        mdl?.show();
      }

      if (btn.dataset.act==='del'){
        if (!confirm(`លុប Period: ${id} ?`)) return;
        try{
          await gasDelete('periods', PERIOD_ID_FIELD, id);
          ALL = ALL.filter(x=>String(x.period_id)!==String(id));
          render(); $status('លុបរួចរាល់');
        }catch(err){ alert('បរាជ័យលុប: ' + (err?.message || err)); }
      }
    });

    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pid  = idEl.value;
      const name = (nameEl.value||'').trim();
      nameEl.classList.toggle('is-invalid', !name);
      if (!name) return;

      const btn = document.getElementById('btnSavePeriod');
      const old = btn.innerHTML; btn.disabled=true; btn.innerHTML='កំពុងរក្សាទុក…';
      try{
        const saved = await gasSave('periods', { period_id: pid, period_name: name });
        const i = ALL.findIndex(x=>String(x.period_id)===String(pid));
        if (i>=0) ALL[i] = { ...ALL[i], ...(saved.row||saved) };
        render(); mdl?.hide(); $status('រក្សាទុករួចរាល់');
      }catch(err){ alert('បរាជ័យរក្សាទុក: ' + (err?.message || err)); }
      finally{ btn.disabled=false; btn.innerHTML=old; }
    });

    btnGen.addEventListener('click', async ()=>{
      if (!SUPER) return alert('ត្រូវការ SUPER');

      const y = Number(selYear.value || new Date().getFullYear());
      if (!confirm(`បង្កើតរយៈពេលសម្រាប់ឆ្នាំ ${y} ?`)) return;

      const old = btnGen.innerHTML;
      btnGen.disabled = true;
      btnGen.innerHTML = 'កំពុងបង្កើត…';

      try {
        // Try bulk API (if your GAS supports it)
        const u = new URL(GAS_BASE);
        u.searchParams.set('api','1');
        u.searchParams.set('route','period');
        u.searchParams.set('op','generate');
        u.searchParams.set('year', String(y));
        const r = await fetch(u.toString(), { cache:'no-store' });
        const j = await r.json().catch(()=> ({}));
        if (!j || j.ok === false) throw new Error(j?.error || 'bulk not supported');

      } catch (_) {
        // Fallback: client-side generate & save
        const KH_MONTHS = ['មករា','កុម្ភះ','មីនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
        const want = [];
        for (let m=1; m<=12; m++){
          const mm = String(m).padStart(2,'0');
          want.push({ period_id:`${y}M${mm}`, period_name:`${KH_MONTHS[m-1]} ${y}`, year:y, month:mm });
        }
        for (let q=1; q<=4; q++) want.push({ period_id:`${y}Q${q}`, period_name:`Q${q} ${y}`, year:y, month:`Q${q}` });
        want.push({ period_id:`${y}H1`,  period_name:`H1 ${y}`,  year:y, month:'H1' });
        want.push({ period_id:`${y}H2`,  period_name:`H2 ${y}`,  year:y, month:'H2' });
        want.push({ period_id:`${y}N9`,  period_name:`៩ខែ ${y}`,  year:y, month:'N9' });
        want.push({ period_id:`${y}Y12`, period_name:`១២ខែ ${y}`, year:y, month:'Y12' });

        const have = new Set((await gasList('periods').catch(()=>[])).map(r => String(r.period_id)));
        const todo = want.filter(r => !have.has(String(r.period_id)));
        const CHUNK = 5;
        for (let i = 0; i < todo.length; i += CHUNK) {
          await Promise.allSettled(todo.slice(i, i+CHUNK).map(row => gasSave('periods', row)));
        }
      }

      // reload table & keep year
      const rows = await gasList('periods').catch(()=>[]);
      ALL = rows.map(norm);
      selYear.value = String(y);
      CUR_YEAR = y;
      render();
      $status('បង្កើតរួចរាល់');
      btnGen.disabled = false; btnGen.innerHTML = old;
    });
  }

  /* ---------- Modal helper (BS5/BS4/fallback) ---------- */
  function makeModal(id){
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (!el) return null;
    if (window.bootstrap?.Modal){
      let inst = bootstrap.Modal.getInstance ? bootstrap.Modal.getInstance(el) : null;
      if (!inst) inst = new bootstrap.Modal(el, {backdrop:true, keyboard:true, focus:true});
      return { show:()=>inst.show(), hide:()=>inst.hide() };
    }
    if (window.jQuery?.fn?.modal){
      const $el = jQuery(el);
      return { show:()=>$el.modal('show'), hide:()=>$el.modal('hide') };
    }
    return { show(){ el.style.display='block'; }, hide(){ el.style.display='none'; } };
  }

  /* ---------- Footer Khmer clock ---------- */
  (function startKhClock(){
    const el = document.getElementById('clockKh'); if (!el) return;
    const months = ['មករា','កុម្ភៈ','មិនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
    const dow    = ['អាទិត្យ','ចន្ទ','អង្គារ','ពុធ','ព្រហស្បតិ៍','សុក្រ','សៅរ៍'];
    const pad=n=>String(n).padStart(2,'0');
    function fmt(){ const d=new Date();
      el.textContent = `${dow[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} • ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.title = `(${pad(d.getHours())}:${pad(d.getMinutes())}) PHD Report`;
    }
    fmt(); setInterval(fmt,1000);
  })();
</script>

</body>
</html>
