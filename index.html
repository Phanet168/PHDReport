<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>PHD Report | Dashboard</title>

  <!-- Fonts Khmer -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@300;400;500;700&display=swap" rel="stylesheet"/>

  <!-- Gull CSS & Plugins -->
  <link href="dist-assets/css/themes/lite-purple.min.css" rel="stylesheet"/>
  <link href="dist-assets/css/plugins/perfect-scrollbar.min.css" rel="stylesheet"/>
  <link href="dist-assets/css/plugins/datatables.min.css" rel="stylesheet"/>

  <style>
    /* ========= Typography & Base ========= */
    :root{
      --kh-font: "Noto Sans Khmer","Khmer OS Siemreap","Battambang",
                 system-ui,-apple-system,"Segoe UI",Arial,Helvetica,sans-serif;
      --kh-head: "Khmer Moul","Noto Sans Khmer",sans-serif;
    }
    html,body{ font-family:var(--kh-font)!important; background:#fafbfc; height:100%; }
    html,body{
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    .kh-head{ font-family:var(--kh-head)!important }

    /* ========= Layout: make footer stick to bottom ========= */
    .app-admin-wrap{ height:100%; }
    .main-content-wrap{
      min-height:100dvh;          /* full viewport height */
      display:flex;
      flex-direction:column;
    }
    .app-footer{ margin-top:auto; } /* push footer down */

    /* ========= Header ========= */
    .main-header{
      position:sticky; top:0; z-index:100;
      backdrop-filter:none;                 /* clearer text */
      background:#ffffffCC;                 /* subtle translucency */
      border-bottom:1px solid #eef0f4;
    }

    .container-page{ max-width:1200px; margin:0 auto; padding:8px }
    .g-kpi .card{ border:0; box-shadow:0 8px 20px rgba(0,0,0,.06) }

    /* ---------- Full-page Loading Overlay ---------- */
    .app-loading{
      position:fixed; inset:0; z-index:2000;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:14px; background:#fff; transition:opacity .2s ease;
    }
    .app-loading.hidden{ opacity:0; pointer-events:none }
    .loader-spin{
      width:52px; height:52px; border-radius:50%;
      border:4px solid #e9ecef; border-top-color:#6f42c1;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* ---------- Skeleton for menus ---------- */
    .skeleton{ position:relative; overflow:hidden; background:#e9ecef; border-radius:6px; }
    .skeleton::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
      animation:shimmer 1.1s infinite;
    }
    .skeleton-text{ display:block; height:14px; width:70%; margin:10px 16px; }
    @keyframes shimmer{ 100% { transform: translateX(100%); } }

    /* ---------- Header right: user box ---------- */
    .userbox{
      display:flex; align-items:center; gap:10px; padding:6px 10px;
      background:#fff; border-radius:999px; box-shadow:0 4px 16px rgba(0,0,0,.08);
      border:1px solid #eee;
    }
    .userbox .avatar{
      width:30px; height:30px; border-radius:50%; background:#6f42c1; color:#fff;
      display:grid; place-items:center; font-weight:700;
    }
    .userbox .meta{ line-height:1.1 }
    .badge-role{ padding:.15rem .45rem; font-size:.7rem; border-radius:6px }

    /* ---------- Footer clock ---------- */
    .footer-clock{ display:flex; align-items:center; gap:10px; font-weight:600; }
    .dot{
      width:8px; height:8px; border-radius:50%; background:#28a745; box-shadow:0 0 0 0 rgba(40,167,69,.7);
      animation:pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform:scale(.9); box-shadow:0 0 0 0 rgba(40,167,69,.7); }
      70% { transform:scale(1); box-shadow:0 0 0 8px rgba(40,167,69,0); }
      100% { transform:scale(.9); box-shadow:0 0 0 0 rgba(40,167,69,0); }
    }
  </style>
</head>

<body class="text-start">
<!-- Full-page loading -->
<div id="appLoading" class="app-loading">
  <div class="loader-spin" aria-hidden="true"></div>
  <div id="appLoadingText" class="text-muted">កំពុងផ្ទុកទិន្នន័យ…</div>
</div>

<div class="app-admin-wrap layout-sidebar-compact sidebar-dark-purple sidenav-open clearfix">

  <!-- ======= LEFT: primary ======= -->
  <div class="side-content-wrap">
    <div class="sidebar-left open rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
      <ul class="navigation-left">
        <li class="nav-item active" data-item="dashboard">
          <a class="nav-item-hold" href="#/"><i class="nav-icon i-Bar-Chart"></i><span class="nav-text">ផ្ទាំងគ្រប់គ្រង</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item" data-item="depts">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-Library"></i><span class="nav-text">ការិយាល័យ</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item" data-item="reports">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-File-Clipboard-File--Text"></i><span class="nav-text">របាយការណ៍</span></a><div class="triangle"></div>
        </li>
        <!-- មុខឃើញតែ super -->
        <li class="nav-item menu-super-only" data-item="users">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-Administrator"></i><span class="nav-text">អ្នកប្រើប្រាស់</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item" data-item="settings">
          <a class="nav-item-hold" href="#"><i class="nav-icon i-Gear-2"></i><span class="nav-text">កំណត់</span></a><div class="triangle"></div>
        </li>
      </ul>
    </div>

    <!-- ======= LEFT: secondary (submenus) ======= -->
    <div class="sidebar-left-secondary rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
      <i class="sidebar-close i-Close"></i>

      <header class="px-3 pt-3">
        <div class="logo d-flex align-items-center gap-2">
          <img src="dist-assets/images/logo-text.png" alt=""/> <span class="kh-head">PHD Report</span>
        </div>
      </header>

      <!-- Dashboard submenu -->
      <div class="submenu-area" data-parent="dashboard">
        <header><h6>Dashboard</h6><p>ស្ថានភាពសរុប</p></header>
        <ul class="childNav">
          <li class="nav-item"><a href="#/"><i class="nav-icon i-Clock-3"></i><span class="item-name">Overview</span></a></li>
        </ul>
      </div>

      <!-- Depts submenu (dynamic) -->
      <div class="submenu-area" data-parent="depts">
        <header><h6>ការិយាល័យ</h6><p>ជ្រើសការិយាល័យ/ផ្នែក</p></header>
        <ul id="deptMenu" class="childNav">
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
        </ul>
      </div>

      <!-- Reports submenu -->
      <div class="submenu-area" data-parent="reports">
        <header><h6>របាយការណ៍</h6><p>សង្ខេប និងនាំចេញ</p></header>
        <ul class="childNav">
          <li class="nav-item"><a href="#/"><i class="nav-icon i-Bar-Chart"></i><span class="item-name">សង្ខេបឆ្នាំ</span></a></li>
        </ul>
      </div>

      <!-- Settings submenu (role-aware) -->
      <div class="submenu-area" data-parent="settings">
        <header><h6>ការកំណត់</h6><p>ទិន្នន័យមេ</p></header>
        <ul id="settingsMenu" class="childNav">
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ======= RIGHT: main ======= -->
  <div class="main-content-wrap d-flex flex-column">
    <div class="main-header px-3 py-2 d-flex align-items-center">
      <div class="logo"><img src="dist-assets/images/logo.png" alt=""/></div>
      <div class="menu-toggle ms-2"><div></div><div></div><div></div></div>
      <div class="flex-grow-1"></div>

      <!-- User box -->
      <div id="userBox" class="userbox">
        <div class="avatar" id="userAvatar">U</div>
        <div class="meta">
          <div id="userName" class="small">អ្នកប្រើប្រាស់</div>
          <div id="userRole" class="badge-role bg-light text-secondary">viewer</div>
        </div>
        <a id="btnLogin" class="btn btn-sm btn-outline-primary ms-2" href="login.html">ចូលប្រើប្រាស់</a>
      </div>
    </div>

    <!-- Router outlet -->
    <div id="route-outlet"></div>

    <!-- Footer always at bottom -->
    <div class="app-footer">
      <div class="footer-bottom border-top pt-3 d-flex flex-column flex-sm-row align-items-center">
        <span class="flex-grow-1"></span>
        <div class="d-flex align-items-center gap-3">
          <div class="footer-clock">
            <span class="dot" aria-hidden="true"></span>
            <span id="clockKh">-- -- ---- --:--:--</span>
          </div>
          <div class="d-flex align-items-center">
            <img class="logo me-2" src="dist-assets/images/logo.png" alt=""/>
            <div><p class="m-0">&copy; PHD Report</p><p class="m-0">All rights reserved</p></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Vendor JS -->
<script src="dist-assets/js/plugins/jquery-3.3.1.min.js"></script>
<script src="dist-assets/js/plugins/bootstrap.bundle.min.js"></script>
<script src="dist-assets/js/plugins/perfect-scrollbar.min.js"></script>
<script src="dist-assets/js/plugins/datatables.min.js"></script>
<script src="dist-assets/js/plugins/echarts.min.js"></script>
<script src="dist-assets/js/scripts/script.min.js"></script>
<script src="dist-assets/js/scripts/sidebar.compact.script.min.js"></script>
<script src="dist-assets/js/scripts/customizer.script.min.js"></script>

<!-- App JS -->
<script type="module">
  import { ensureLoggedIn, applyLoginButton, getAuth, isSuper } from './assets/js/app.auth.js';
  import { buildDeptMenu, buildSettingsMenu, gasList, gasSave, gasDelete, ID_FIELDS } from './assets/js/app.menu.js';

  applyLoginButton();
  ensureLoggedIn('login.html');

  /* ---------- Simple loader ---------- */
  const AppLoader = (() => {
    let n = 0;
    const el = document.getElementById('appLoading');
    const textEl = document.getElementById('appLoadingText');
    const show = (m) => { n++; if (m && textEl) textEl.textContent = m; el?.classList.remove('hidden'); };
    const hide = () => { n = Math.max(0, n-1); if (!n) el?.classList.add('hidden'); };
    const wrap = async (p, m) => { show(m); try { return await p; } finally { hide(); } };
    return { show, hide, wrap };
  })();

  /* ---------- Require login ---------- */
  ensureLoggedIn('login.html');

  /* ---------- Menus (left sidebar) ---------- */
  await AppLoader.wrap(Promise.all([
    buildDeptMenu('deptMenu'),
    buildSettingsMenu('settingsMenu'),
  ]), 'កំពុងផ្ទុកទិន្នន័យ…');

  /* ---------- Header user UI ---------- */
  (function updateUserUI(){
    const auth = getAuth();
    const btn   = document.getElementById('btnLogin');
    const nameEl= document.getElementById('userName');
    const roleEl= document.getElementById('userRole');
    const avatar= document.getElementById('userAvatar');

    const displayName = (a)=> a?.full_name || a?.display_name || a?.user_fullname || a?.user_name || a?.username || 'អ្នកប្រើប្រាស់';
    const role = String(auth?.role || 'viewer').toLowerCase();

    nameEl && (nameEl.textContent = displayName(auth));
    if (roleEl){
      roleEl.textContent = role;
      roleEl.className   = 'badge-role ' + (role==='super' ? 'bg-primary text-white'
                                     : role.includes('data') ? 'bg-success text-white'
                                     : 'bg-light text-secondary');
    }
    if (avatar){
      const letter = (displayName(auth).match(/[A-Za-zក-ហ]/) || ['U'])[0].toUpperCase();
      avatar.textContent = letter;
    }
    btn && applyLoginButton(btn);
    document.querySelectorAll('.menu-super-only').forEach(el=>{
      el.style.display = isSuper(auth) ? '' : 'none';
    });
  })();

  /* ======================= Tiny Router (hash) ======================= */
  const outlet = document.getElementById('route-outlet');
  const baseDir = location.pathname.replace(/\/[^\/]*$/, '/');
  const viewUrl = (p) => baseDir + p.replace(/^\/+/,'');

  const routes = {
    '':                     { view:'pages/home.html',                       init:initDashboard },
    'settings/indicators':  { view:'pages/settings/indicators/index.html',  init:initIndicators },
    'settings/departments': { view:'pages/settings/departments/index.html',  init:initDepartments },
    'settings/units':       { view:'pages/settings/units/index.html',        init:initUnits },
    'settings/periods':     { view:'pages/settings/periods/index.html',      init:initPeriods },
    'settings/users':       { view:'pages/settings/users/index.html',         init:initUsers },
    'data-entry':           { view:'pages/data-entry/index.html',             init:initDataEntry },

  };

  async function render(path){
    const conf = routes[path] || routes[''];
    try{
      const res = await fetch(viewUrl(conf.view), { cache:'no-store' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const html = await res.text();
      outlet && (outlet.innerHTML = html);
      if (typeof conf.init === 'function') {
        await AppLoader.wrap(conf.init(), 'កំពុងរៀបចំទំព័រ…');
      }
      setActiveByHash(path);
    }catch(e){
      outlet && (outlet.innerHTML = `
        <div class="container-page">
          <div class="alert alert-danger mt-3">
            មិនអាចផ្ទុកទំព័រ: ${conf.view}<br/>
            <small class="text-muted">${e.message || e}</small>
          </div>
        </div>`);
    }
  }
  const parseHash = () => (location.hash || '#/').replace(/^#\//,'');
  window.addEventListener('hashchange', () => AppLoader.wrap(render(parseHash()), 'កំពុងផ្ទុកទំព័រ…'));
  await AppLoader.wrap(render(parseHash()), 'កំពុងផ្ទុកទំព័រ…');

  function setActiveByHash(h){
    const top = h.startsWith('settings/') ? 'settings'
             : h.startsWith('depts')      ? 'depts'
             : h.startsWith('reports')    ? 'reports'
             : 'dashboard';
    document.querySelectorAll('.navigation-left .nav-item').forEach(li=>{
      li.classList.toggle('active', li.getAttribute('data-item')===top);
    });
  }

  /* ======================= Dashboard ======================= */
  async function initDashboard(){
    const $ = s => document.querySelector(s);

    const [indicators, departments, units, reports] = await AppLoader.wrap(Promise.all([
      gasList('indicators').catch(()=>[]),
      gasList('departments').catch(()=>[]),
      gasList('units').catch(()=>[]),
      gasList('reports').catch(()=>[]),
    ]), 'កំពុងទាញទិន្នន័យ Dashboard…');

    $('#kpiIndicators') && ( $('#kpiIndicators').textContent = indicators.length );
    $('#kpiDepts')      && ( $('#kpiDepts').textContent      = departments.length );
    $('#kpiUnits')      && ( $('#kpiUnits').textContent      = units.length );
    $('#kpiReports')    && ( $('#kpiReports').textContent    = reports.length );

    if (window.echarts){
      const ec = window.echarts;

      // Monthly bar
      const aggMonth = {};
      for(const r of reports){
        const d = new Date(r.date || r._createdAt || Date.now());
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        aggMonth[key] = (aggMonth[key]||0)+1;
      }
      const months = Object.keys(aggMonth).sort();
      const series = months.map(m=>aggMonth[m]);
      const c1El = document.getElementById('chartMonthly');
      if (c1El){
        const c1 = ec.init(c1El, null, { devicePixelRatio: window.devicePixelRatio || 1 });
        c1.setOption({ tooltip:{}, xAxis:{type:'category',data:months}, yAxis:{type:'value'}, series:[{type:'bar',data:series}] });
      }

      // By department pie
      const nameByDept = Object.fromEntries(departments.map(d=>[d.department_id,d.department_name]));
      const aggDept = {};
      for(const r of reports){
        const name = nameByDept[r.department_id] || 'មិនបានកំណត់';
        aggDept[name] = (aggDept[name]||0)+1;
      }
      const data = Object.entries(aggDept).map(([name,value])=>({name,value}));
      const c2El = document.getElementById('chartDept');
      if (c2El){
        const c2 = ec.init(c2El, null, { devicePixelRatio: window.devicePixelRatio || 1 });
        c2.setOption({ tooltip:{trigger:'item'}, series:[{type:'pie',radius:'70%',data}] });
      }
    }
  }

 // ======================= Data Entry (Indicators + Issues) =======================
async function initDataEntry(){
  // ----- deps from your app -----
  const { getAuth, isSuper } = await import('./assets/js/app.auth.js');
  const { gasList, gasSave, gasDelete, ID_FIELDS } = await import('./assets/js/app.menu.js');
  // optional: API helper for report upsert (ប្រសិនបើមាន)
  let upsertReport = async (p)=> gasSave('reports', p);
  try {
    upsertReport = (await import('./assets/js/app.api.js')).upsertReport || upsertReport;
  } catch { /* fallback to gasSave */ }

  // ----- tiny utils -----
  const $  = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const setStatus = (id, msg)=>{ const el=document.getElementById(id); if(el) el.textContent=msg||''; };
  const prettyPeriod = pid=>{
    const mNames = ['មករា','កុម្ភះ','មីនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
    const y   = (String(pid||'').match(/^(\d{4})/)||[])[1]||'';
    const tag = (String(pid||'').match(/(M\d{2}|Q[1-4]|H[12]|N9|Y12)$/)||[])[1]||'';
    if(/^M\d{2}$/.test(tag)) return `${mNames[+tag.slice(1)-1]} ${y}`;
    if(/^Q[1-4]$/.test(tag)) return `${tag} ${y}`;
    if(/^H[12]$/.test(tag))  return `${tag} ${y}`;
    if(tag==='N9')  return `៩ខែ ${y}`;
    if(tag==='Y12') return `១២ខែ ${y}`;
    return pid||'';
  };

  // ----- auth/role -----
  const auth  = getAuth();
  const SUPER = isSuper(auth);

  // ================= INDICATORS (Reports) =================
  const elPeriodI = $('#ind_period');
  const elDeptI   = $('#ind_department');
  const elUnitI   = $('#ind_unit');
  const elInd     = $('#ind_indicator');
  const elVal     = $('#ind_value');
  const elNote    = $('#ind_note');
  const repIdEl   = $('#report_id');
  const tblRep    = $('#tblReports tbody');
  const qReports  = $('#qReports');
  const btnSaveReport = $('#btnSaveReport');

  // ================= ISSUES =================
  const elPeriodS = $('#iss_period');
  const elDeptS   = $('#iss_department');
  const elUnitS   = $('#iss_unit');
  const elIndS    = $('#iss_indicator');
  const issIdEl   = $('#issue_id');
  const issTitle  = $('#iss_title');
  const issSeverity = $('#iss_severity');
  const issDesc   = $('#iss_desc');
  const tblIss    = $('#tblIssues tbody');
  const qIssues   = $('#qIssues');
  const btnSaveIssue = $('#btnSaveIssue');

  // guard (when user opens another tab)
  if (!elPeriodI || !elDeptI || !elUnitI || !elInd || !tblRep || !elPeriodS || !elDeptS || !elUnitS || !tblIss) {
    setStatus('statusEntry','components not found'); return;
  }

  // ----- state -----
  let PERIODS=[], DEPTS=[], UNITS=[], INDS=[];
  let REPORTS=[], ISSUES=[];

  const deptName=id=>DEPTS.find(d=>String(d.department_id)===String(id))?.department_name||'';
  const unitName=id=>UNITS.find(u=>String(u.unit_id)===String(id))?.unit_name||'';
  const indName =id=>INDS.find(i=>String(i.indicator_id)===String(id))?.indicator_name||'';

  // skeletons
  tblRep.innerHTML = '<tr><td colspan="6" class="skel"></td></tr><tr><td colspan="6" class="skel"></td></tr>';
  tblIss.innerHTML = '<tr><td colspan="6" class="skel"></td></tr><tr><td colspan="6" class="skel"></td></tr>';

  // ----- load masters -----
  try{
    const [periods, depts, units, inds] = await Promise.all([
      gasList('periods').catch(()=>[]),
      gasList('departments').catch(()=>[]),
      gasList('units').catch(()=>[]),
      gasList('indicators').catch(()=>[]),
    ]);

    PERIODS = periods.sort((a,b)=>String(a.period_id).localeCompare(String(b.period_id)));
    DEPTS   = SUPER? depts  : depts.filter(d=>String(d.department_id)===String(auth?.department_id));
    UNITS   = SUPER? units  : units.filter(u=>String(u.department_id)===String(auth?.department_id));
    INDS    = SUPER? inds   : inds.filter(i=>{
      if (String(i.department_id)!==String(auth?.department_id)) return false;
      return auth?.unit_id ? String(i.unit_id)===String(auth.unit_id) : true;
    });

    // fill periods
    const optPeriods = PERIODS.map(p=>`<option value="${p.period_id}">${prettyPeriod(p.period_id)}</option>`).join('');
    elPeriodI.innerHTML = optPeriods; elPeriodS.innerHTML = optPeriods;

    // fill departments
    const optDepts = `<option value="">— ការិយាល័យ —</option>` + DEPTS.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
    elDeptI.innerHTML = optDepts; elDeptS.innerHTML = optDepts;
    if (!SUPER){
      elDeptI.value = elDeptS.value = auth?.department_id||'';
      elDeptI.disabled = elDeptS.disabled = true;
    }

    // fill units based on dep
    const fillUnits = (sel, depId)=>{
      const list = UNITS.filter(u=>String(u.department_id)===String(depId));
      sel.innerHTML = `<option value="">— ផ្នែក —</option>` + list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
      if (!SUPER){ sel.value = auth?.unit_id||''; sel.disabled = true; }
    };
    const dep0 = SUPER ? (elDeptI.value || DEPTS[0]?.department_id) : (auth?.department_id || '');
    if (dep0){ fillUnits(elUnitI, dep0); fillUnits(elUnitS, dep0); }

    // indicators (depends on dep/unit)
    const refillIndicators = ()=>{
      const dep = elDeptI.value || (SUPER? '' : auth?.department_id);
      const uni = elUnitI.value || (SUPER? '' : auth?.unit_id);
      const list = INDS.filter(i => (!dep || String(i.department_id)===String(dep)) && (!uni || String(i.unit_id)===String(uni)));
      elInd.innerHTML  = list.length ? list.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('')
                                     : `<option value="">— គ្មានសូចនាករ —</option>`;
      elIndS.innerHTML = `<option value="">— (ស្រេចចិត្ត) —</option>` + list.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
    };
    refillIndicators();

    // load latest rows
    REPORTS = (await gasList('reports').catch(()=>[])).slice(-50).reverse();
    ISSUES  = (await gasList('issues').catch(()=>[])).slice(-50).reverse();

    renderReports(); renderIssues();
    setStatus('statusEntry','បានផ្ទុកទិន្នន័យ');
  }catch(e){
    console.error('[data-entry] load', e);
    setStatus('statusEntry','បរាជ័យផ្ទុកទិន្នន័យ');
  }

  // ----- linkage -----
  elDeptI.addEventListener('change', ()=>{
    const dep = elDeptI.value;
    const list = UNITS.filter(u=>String(u.department_id)===String(dep));
    elUnitI.innerHTML = `<option value="">— ផ្នែក —</option>` + list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
    if (!SUPER){ elUnitI.value = auth?.unit_id||''; elUnitI.disabled = true; }
    // indicators
    const inds = INDS.filter(i => !dep || String(i.department_id)===String(dep));
    elInd.innerHTML  = inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
    elIndS.innerHTML = `<option value="">— (ស្រេចចិត្ត) —</option>` + inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
  });
  elUnitI.addEventListener('change', ()=>{
    const dep = elDeptI.value, uni = elUnitI.value;
    const inds = INDS.filter(i => (!dep || String(i.department_id)===String(dep)) && (!uni || String(i.unit_id)===String(uni)));
    elInd.innerHTML  = inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
    elIndS.innerHTML = `<option value="">— (ស្រេចចិត្ត) —</option>` + inds.map(i=>`<option value="${i.indicator_id}">${i.indicator_name}</option>`).join('');
  });
  elDeptS.addEventListener('change', ()=>{
    const dep = elDeptS.value;
    const list = UNITS.filter(u=>String(u.department_id)===String(dep));
    elUnitS.innerHTML = `<option value="">— ផ្នែក —</option>` + list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
    if (!SUPER){ elUnitS.value = auth?.unit_id||''; elUnitS.disabled = true; }
  });

  // =================== Reports form ===================
  $('#btnResetReport')?.addEventListener('click', ()=>{ repIdEl.value=''; elVal.value=''; elNote.value=''; });

  $('#frmReport')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const value = (elVal.value||'').trim();
    elVal.classList.toggle('is-invalid', !value);
    if (!value) return;

    const payload = {
      report_id    : repIdEl.value || null,
      period_id    : elPeriodI.value,
      indicator_id : elInd.value,
      department_id: SUPER ? elDeptI.value : (auth?.department_id||''),
      unit_id      : SUPER ? elUnitI.value : (auth?.unit_id||''),
      value        : Number(value),
      note         : elNote.value||'',
    };

    const old=btnSaveReport.innerHTML; btnSaveReport.disabled=true; btnSaveReport.innerHTML='កំពុងរក្សាទុក…';
    try{
      const res = await upsertReport(payload);
      const row = res.row || res;
      const i = REPORTS.findIndex(r=>String(r.report_id)===String(row.report_id));
      if (i>=0) REPORTS[i]=row; else REPORTS.unshift(row);
      renderReports();
      repIdEl.value=''; elVal.value=''; elNote.value='';
      setStatus('statusReports','រក្សាទុករួចរាល់');
    }catch(err){
      alert('បរាជ័យរក្សាទុក: ' + (err?.message||err));
    }finally{
      btnSaveReport.disabled=false; btnSaveReport.innerHTML=old;
    }
  });

  function renderReports(){
    const q = String(qReports?.value||'').trim().toLowerCase();
    const rows = REPORTS.filter(r=>{
      const hay = `${r.report_id} ${r.period_id} ${prettyPeriod(r.period_id)} ${indName(r.indicator_id)||''} ${r.value||''} ${r.note||''}`.toLowerCase();
      return !q || hay.includes(q);
    });
    if (!rows.length){ tblRep.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
    const frag = document.createDocumentFragment();
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge text-bg-light border">#${r.report_id||''}</span></td>
        <td>${prettyPeriod(r.period_id)}</td>
        <td>${indName(r.indicator_id)||r.indicator_id}</td>
        <td>${r.value ?? ''}</td>
        <td>${r.note||''}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-warning me-1" data-act="edit" data-id="${r.report_id}">កែ</button>
          <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${r.report_id}">លុប</button>
        </td>`;
      frag.appendChild(tr);
    }
    tblRep.innerHTML=''; tblRep.appendChild(frag);
  }
  qReports?.addEventListener('input', renderReports);

  tblRep.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]'); if (!btn) return;
    const id  = btn.dataset.id;
    const row = REPORTS.find(r=>String(r.report_id)===String(id));
    if (!row) return;

    if (btn.dataset.act==='edit'){
      repIdEl.value = row.report_id||'';
      elPeriodI.value = row.period_id || elPeriodI.value;
      elDeptI.value   = row.department_id || elDeptI.value; elDeptI.dispatchEvent(new Event('change'));
      elUnitI.value   = row.unit_id || elUnitI.value;       elUnitI.dispatchEvent(new Event('change'));
      elInd.value     = row.indicator_id || elInd.value;
      elVal.value     = row.value || '';
      elNote.value    = row.note  || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    if (btn.dataset.act==='del'){
      if (!confirm('លុបរបាយការណ៍នេះមែនទេ?')) return;
      try{
        if (ID_FIELDS?.reports) await gasDelete('reports', ID_FIELDS.reports, row.report_id);
        else await gasSave('reports', { report_id: row.report_id, _delete: true }); // fallback
        REPORTS = REPORTS.filter(x=>String(x.report_id)!==String(id));
        renderReports(); setStatus('statusReports','លុបរួចរាល់');
      }catch(err){ alert(err?.message||err); }
    }
  });

  // =================== Issues form ===================
  $('#btnResetIssue')?.addEventListener('click', ()=>{ issIdEl.value=''; issTitle.value=''; issSeverity.value=''; issDesc.value=''; });

  $('#frmIssue')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const title=(issTitle.value||'').trim();
    issTitle.classList.toggle('is-invalid', !title);
    if (!title) return;

    const payload = {
      issue_id     : issIdEl.value || null,
      title        : title,
      description  : issDesc.value || '',
      severity     : issSeverity.value || '',
      period_id    : elPeriodS.value,
      indicator_id : elIndS.value || '',
      department_id: SUPER ? elDeptS.value : (auth?.department_id||''),
      unit_id      : SUPER ? elUnitS.value : (auth?.unit_id||''),
      status       : 'open'
    };

    const old = btnSaveIssue.innerHTML; btnSaveIssue.disabled=true; btnSaveIssue.innerHTML='កំពុងរក្សាទុក…';
    try{
      const res = await gasSave('issues', payload);
      const row = res.row || res;
      const i = ISSUES.findIndex(x=>String(x.issue_id)===String(row.issue_id));
      if (i>=0) ISSUES[i]=row; else ISSUES.unshift(row);
      renderIssues(); $('#btnResetIssue')?.click();
      setStatus('statusIssues','រក្សាទុករួចរាល់');
    }catch(err){
      alert('បរាជ័យរក្សាទុក: ' + (err?.message||err));
    }finally{
      btnSaveIssue.disabled=false; btnSaveIssue.innerHTML=old;
    }
  });

  function renderIssues(){
    const q = String(qIssues?.value||'').trim().toLowerCase();
    const rows = ISSUES.filter(r=>{
      const hay = `${r.issue_id} ${r.title||''} ${r.severity||''} ${r.period_id||''} ${indName(r.indicator_id)||''}`.toLowerCase();
      return !q || hay.includes(q);
    });
    if (!rows.length){ tblIss.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
    const frag = document.createDocumentFragment();
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge text-bg-light border">#${r.issue_id||''}</span></td>
        <td>${r.title || ''}</td>
        <td>${(r.severity||'').toUpperCase()}</td>
        <td>${prettyPeriod(r.period_id)}</td>
        <td>${indName(r.indicator_id)||''}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-warning me-1" data-act="edit" data-id="${r.issue_id}">កែ</button>
          <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${r.issue_id}">លុប</button>
        </td>`;
      frag.appendChild(tr);
    }
    tblIss.innerHTML=''; tblIss.appendChild(frag);
  }
  qIssues?.addEventListener('input', renderIssues);

  tblIss.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const id  = btn.dataset.id;
    const row = ISSUES.find(r=>String(r.issue_id)===String(id));
    if (!row) return;

    if (btn.dataset.act==='edit'){
      issIdEl.value = row.issue_id || '';
      elPeriodS.value = row.period_id || elPeriodS.value;
      elDeptS.value   = row.department_id || elDeptS.value; elDeptS.dispatchEvent(new Event('change'));
      elUnitS.value   = row.unit_id || elUnitS.value;
      elIndS.value    = row.indicator_id || '';
      issTitle.value  = row.title || '';
      issSeverity.value = row.severity || '';
      issDesc.value   = row.description || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    if (btn.dataset.act==='del'){
      if (!confirm('លុបបញ្ហានេះមែនទេ?')) return;
      try{
        if (ID_FIELDS?.issues) await gasDelete('issues', ID_FIELDS.issues, row.issue_id);
        else await gasSave('issues', { issue_id: row.issue_id, _delete: true });
        ISSUES = ISSUES.filter(x=>String(x.issue_id)!==String(id));
        renderIssues(); setStatus('statusIssues','លុបរួចរាល់');
      }catch(err){ alert(err?.message||err); }
    }
  });
}


 /* ======================= Indicators ======================= */
async function initIndicators(){
  const auth   = getAuth();
  const SUPER  = isSuper(auth);

  const table   = document.getElementById('tblIndicators');
  const tbody   = table?.querySelector('tbody');
  const btnAdd  = document.getElementById('btnAdd');
  const frm     = document.getElementById('frmIndicator');
  const selDept = document.getElementById('department_id');
  const selUnit = document.getElementById('unit_id');
  const selOwner= document.getElementById('owner_id'); // optional owner select
  const btnSave = document.getElementById('btnSave');
  const modal   = makeModal('mdlIndicator');

  if (!table || !tbody || !btnAdd || !frm || !selDept || !selUnit || !btnSave) return;

  let CACHE = { departments:[], unitsAll:[], usersAll:[], indicators:[], unitsByDep:new Map() };
  let MAPS  = { deptName:{}, unitName:{}, userName:{} };

  const setStatus = m=>{ const el=document.getElementById('statusLine'); if(el) el.textContent=m||''; };
  const skel=()=>{ tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="6" class="skel"></td>`; tbody.appendChild(tr);} };
  skel();

  try{
    let [depts, inds] = await Promise.all([
      gasList('departments'),
      gasList('indicators')
    ]);

    if (!SUPER && auth?.department_id){
      const depId=String(auth.department_id);
      depts = depts.filter(d=>String(d.department_id)===depId);
      inds  = inds.filter(r=>String(r.department_id)===depId);
    }

    let unitsAll = SUPER ? await gasList('units')
                         : await gasList('units',{department_id:auth?.department_id||''});

    let usersAll=[];
    if (selOwner){
      if (SUPER) usersAll = await gasList('users');
      else usersAll=[{user_id:auth?.user_id,user_name:auth?.user_name,full_name:auth?.full_name}];
    }

    CACHE.departments=depts;
    CACHE.unitsAll=unitsAll||[];
    CACHE.usersAll=usersAll||[];
    CACHE.indicators=inds;

    MAPS.deptName = Object.fromEntries(CACHE.departments.map(d=>[String(d.department_id),d.department_name]));
    MAPS.unitName = Object.fromEntries(CACHE.unitsAll.map(u=>[String(u.unit_id),u.unit_name]));
    MAPS.userName = Object.fromEntries(CACHE.usersAll.map(u=>[String(u.user_id),(u.full_name||u.user_name||('User#'+u.user_id))]));

    await fillDeptSelect(SUPER?'':auth?.department_id);
    await fillUnitSelect(SUPER?selDept.value:auth?.department_id, SUPER?'':auth?.unit_id);

    if (selOwner){
      if (SUPER){
        selOwner.innerHTML=`<option value="">— ជ្រើសម្ចាស់ —</option>`+
          CACHE.usersAll.map(u=>`<option value="${u.user_id}">${MAPS.userName[String(u.user_id)]}</option>`).join('');
        selOwner.disabled=false;
      } else {
        selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`;
        selOwner.disabled=true;
      }
    }

    // SUPER auto-align dep/unit when owner changes
    const usersById=Object.fromEntries((CACHE.usersAll||[]).map(u=>[String(u.user_id),u]));
    selOwner?.addEventListener('change',async()=>{
      if(!SUPER) return;
      const u=usersById[String(selOwner.value||'')];
      if(!u) return;
      selDept.value=u.department_id||'';
      selDept.disabled=false;
      await fillUnitSelect(u.department_id,u.unit_id||'');
      selUnit.disabled=false;
      setStatus(`Aligned to ${u.full_name||u.user_name}`);
    });

    renderTable();
    setStatus(`បានផ្ទុក ${inds.length} សូចនាករ`);
  }catch(e){
    console.error(e);
    tbody.innerHTML=`<tr><td colspan="6" class="text-center text-danger py-4">បរាជ័យផ្ទុកទិន្នន័យ</td></tr>`;
    setStatus('បរាជ័យផ្ទុកទិន្នន័យ');
  }

  async function fillDeptSelect(selected){
    selDept.innerHTML=`<option value="">— ជ្រើសការិយាល័យ —</option>`+
      CACHE.departments.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
    if(selected) selDept.value=selected;
    selDept.disabled=!SUPER;
  }
  async function fillUnitSelect(depId,selected){
    selUnit.innerHTML=`<option value="">— ជ្រើសផ្នែក —</option>`;
    if(!depId){ selUnit.disabled=true; return; }
    let units=CACHE.unitsByDep.get(String(depId));
    if(!units){
      const fromAll=CACHE.unitsAll.filter(u=>String(u.department_id)===String(depId));
      units=fromAll.length?fromAll:await gasList('units',{department_id:depId});
      CACHE.unitsByDep.set(String(depId),units);
      for(const u of units) MAPS.unitName[String(u.unit_id)]=u.unit_name;
    }
    selUnit.innerHTML=`<option value="">— ជ្រើសផ្នែក —</option>`+(units||[]).map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
    if(selected) selUnit.value=selected;
    selUnit.disabled=!SUPER;
  }

  function canEditRow(ind){
    if(SUPER) return true;
    return String(ind.department_id)===String(auth?.department_id||'')
        && String(ind.unit_id||'')===String(auth?.unit_id||'')
        && String(ind.owner_id||'')===String(auth?.user_id||'');
  }

 function renderTable(){
  if(!CACHE.indicators.length){
    tbody.innerHTML=`<tr><td colspan="7" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
    return;
  }
  const frag=document.createDocumentFragment();
  for(const ind of CACHE.indicators){
    const depN   = MAPS.deptName[String(ind.department_id)]||'';
    const unitN  = MAPS.unitName[String(ind.unit_id)]||'';
    const ownerN = MAPS.userName[String(ind.owner_id)]||'';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${ind.indicator_id}</td>
      <td>${ind.indicator_name||''}</td>
      <td>${ind.indicator_type||''}</td>
      <td>${depN}</td>
      <td>${unitN}</td>
      <td>${ownerN||''}</td>
      <td class="text-end">
        ${canEditRow(ind)
          ? `<button class="btn btn-sm btn-warning me-1" data-act="edit" data-id="${ind.indicator_id}">កែ</button>
             <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${ind.indicator_id}">លុប</button>`
          : `<span class="text-muted">—</span>`}
      </td>`;
    frag.appendChild(tr);
  }
  tbody.innerHTML='';
  tbody.appendChild(frag);
}


  selDept.addEventListener('change',e=>fillUnitSelect(e.target.value,''));
  btnAdd.addEventListener('click',async()=>{
    frm.reset(); document.getElementById('indicator_id').value='';
    if(SUPER){
      selDept.disabled=false; await fillUnitSelect(selDept.value,'');
      if(selOwner){ selOwner.disabled=false; selOwner.value=''; }
    }else{
      selDept.value=auth?.department_id||''; selDept.disabled=true;
      await fillUnitSelect(auth?.department_id,auth?.unit_id); selUnit.disabled=true;
      if(selOwner){
        selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`;
        selOwner.disabled=true;
      }
    }
    modal?.show();
  });

  tbody.addEventListener('click',async e=>{
    const btn=e.target.closest('button[data-act]'); if(!btn) return;
    const id=btn.getAttribute('data-id');
    const row=CACHE.indicators.find(x=>String(x.indicator_id)===String(id));
    if(!row) return;

    if(btn.dataset.act==='edit'){
      if(!canEditRow(row) && !SUPER) return alert('Permission denied');
      frm.reset();
      document.getElementById('indicator_id').value=row.indicator_id;
      document.getElementById('indicator_name').value=row.indicator_name||'';
      document.getElementById('indicator_type').value=row.indicator_type||'';
      selDept.value=row.department_id||''; if(!SUPER) selDept.disabled=true;
      await fillUnitSelect(row.department_id,row.unit_id||''); if(!SUPER) selUnit.disabled=true;
      if(selOwner){
        if(SUPER){ selOwner.value=row.owner_id||''; selOwner.disabled=false; }
        else{ selOwner.innerHTML=`<option value="${auth?.user_id||''}">${auth?.full_name||auth?.user_name||'ខ្លួនឯង'}</option>`; selOwner.disabled=true; }
      }
      modal?.show();
    }

    if(btn.dataset.act==='del'){
      if(!canEditRow(row) && !SUPER) return alert('Permission denied');
      if(!confirm('លុបមែនទេ?')) return;
      try{
        await gasDelete('indicators',ID_FIELDS.indicators,row.indicator_id);
        CACHE.indicators=CACHE.indicators.filter(x=>String(x.indicator_id)!==String(id));
        renderTable();
      }catch(err){ alert('បរាជ័យលុប: '+(err?.message||err)); }
    }
  });

  frm.addEventListener('submit',async e=>{
    e.preventDefault();
    const payload={
      indicator_id  : document.getElementById('indicator_id').value||null,
      indicator_name: document.getElementById('indicator_name').value.trim(),
      indicator_type: document.getElementById('indicator_type').value.trim(),
      department_id : SUPER?selDept.value:(auth?.department_id||''),
      unit_id       : SUPER?selUnit.value:(auth?.unit_id||'')
    };
    if(selOwner) payload.owner_id=SUPER?(selOwner.value||''):(auth?.user_id||'');

    const nameEl=document.getElementById('indicator_name');
    nameEl.classList.toggle('is-invalid',!payload.indicator_name);
    if(!payload.indicator_name) return;

    const old=btnSave.innerHTML; btnSave.disabled=true; btnSave.innerHTML='កំពុងរក្សាទុក…';
    try{
      const saved=await gasSave('indicators',payload);
      const row=saved.row||saved;
      const i=CACHE.indicators.findIndex(x=>String(x.indicator_id)===String(row.indicator_id));
      if(i>=0) CACHE.indicators[i]=row; else CACHE.indicators.push(row);
      renderTable(); modal?.hide();
      setStatus('រក្សាទុករួចរាល់');
    }catch(err){ alert('បរាជ័យរក្សាទុក: '+(err?.message||err)); }
    finally{ btnSave.disabled=false; btnSave.innerHTML=old; }
  });
}



/* ======================= Users ======================= */
async function initUsers(){
  const auth  = getAuth();
  const SUPER = isSuper(auth);

  // ---- DOM ----
  const tbl      = document.getElementById('tblUsers');
  const tbody    = tbl?.querySelector('tbody');
  const btnAdd   = document.getElementById('btnAddUser');
  const frm      = document.getElementById('frmUser');
  const modal    = makeModal('mdlUser');

  const idEl     = document.getElementById('user_id');
  const nameEl   = document.getElementById('user_name');
  const fullEl   = document.getElementById('full_name');
  const roleEl   = document.getElementById('user_type');
  const passEl   = document.getElementById('user_pass');
  const selDept  = document.getElementById('department_id');
  const selUnit  = document.getElementById('unit_id');
  const btnSave  = document.getElementById('btnSaveUser');
  const txtQ     = document.getElementById('txtSearchUsers'); // (មាន/មិនមានក៏បាន)
  const $status  = (m)=>{ const el=document.getElementById('statusUsers'); if(el) el.textContent=m||''; };

  if (!tbl || !tbody || !btnAdd || !frm || !idEl || !nameEl || !roleEl || !selDept || !selUnit || !btnSave) return;

  // ---- Skeleton ----
  (function skel(){ tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="6" class="skel"></td>`; tbody.appendChild(tr);} })();

  // ---- State ----
  let ROWS = [];      // users
  let DEPTS = [];     // departments
  let UNITS = [];     // units
  let FILTER_Q = '';  // search
  let SORT = { key:'user_id', dir:1 }; // 1=asc, -1=desc

  const deptName=(id)=> DEPTS.find(d=>String(d.department_id)===String(id))?.department_name || '';
  const unitName=(id)=> UNITS.find(u=>String(u.unit_id)===String(id))?.unit_name || '';

  const badgeRole = (r)=>{
    const v = String(r||'').toLowerCase();
    const cls = v==='super' || v==='superuser' ? 'bg-primary'
              : v==='admin'                    ? 'bg-warning text-dark'
              : v.includes('data')             ? 'bg-success'
              : 'bg-secondary';
    const txt = v==='superuser' ? 'super' : v;
    return `<span class="badge ${cls} text-uppercase">${txt||'viewer'}</span>`;
  };

  // ---- Load ----
  try{
    [ROWS, DEPTS, UNITS] = await Promise.all([
      gasList('users'),
      gasList('departments'),
      gasList('units'),
    ]);
    render(); $status(`បានផ្ទុក ${ROWS.length} អ្នកប្រើប្រាស់`);
  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
    $status('បរាជ័យទាញទិន្នន័យ');
  }

  // ---- Select fill ----
  function fillDeptSelect(selected){
    selDept.innerHTML = `<option value="">— ជ្រើសការិយាល័យ —</option>`+
      DEPTS.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
    if (selected) selDept.value = selected;
    selDept.disabled = !SUPER;
  }
  function fillUnitSelect(depId, selected){
    selUnit.innerHTML = `<option value="">— ជ្រើសផ្នែក —</option>`;
    if (!depId){ selUnit.disabled = true; return; }
    const list = UNITS.filter(u=>String(u.department_id)===String(depId));
    selUnit.innerHTML = `<option value="">— ជ្រើសផ្នែក —</option>`+
      list.map(u=>`<option value="${u.unit_id}">${u.unit_name}</option>`).join('');
    if (selected) selUnit.value = selected;
    selUnit.disabled = !SUPER;
  }

  // ---- Render table (filter + sort) ----
  function render(){
    let list = ROWS.slice();

    // filter
    if (FILTER_Q){
      const q = FILTER_Q;
      list = list.filter(r=>{
        const hay = `${r.user_id} ${r.user_name||''} ${r.full_name||''} ${r.user_type||''} ${deptName(r.department_id)} ${unitName(r.unit_id)}`.toLowerCase();
        return hay.includes(q);
      });
    }

    // sort (localeNumeric)
    list.sort((a,b)=>{
      const key = SORT.key;
      const av = (a[key] ?? '').toString();
      const bv = (b[key] ?? '').toString();
      return av.localeCompare(bv, undefined, { numeric:true, sensitivity:'base' }) * SORT.dir;
    });

    if (!list.length){
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
      return;
    }

    const frag = document.createDocumentFragment();
    for (const r of list){
      const tr = document.createElement('tr');
      tr.dataset.id = r.user_id;
      tr.innerHTML = `
        <td style="width:80px"><span class="badge text-bg-light border">#${r.user_id}</span></td>
        <td>${r.user_name || ''}</td>
        <td>${r.full_name || ''}</td>
        <td style="width:140px">${badgeRole(r.user_type)}</td>
        <td>${deptName(r.department_id)}${r.unit_id?` / ${unitName(r.unit_id)}`:''}</td>
        <td class="text-end" style="width:160px">
          ${SUPER
            ? `<button class="btn btn-sm btn-warning me-1" data-act="edit"><i class="bi bi-pencil-square"></i> កែ</button>
               <button class="btn btn-sm btn-danger"  data-act="del"><i class="bi bi-trash"></i> លុប</button>`
            : `<span class="text-muted">—</span>`}
        </td>`;
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    // update sort header classes (if you add th.th-sort with data-sort)
    tbl.querySelectorAll('th.th-sort').forEach(th=>{
      th.classList.remove('asc','desc');
      if (th.dataset.sort === SORT.key) th.classList.add(SORT.dir===1?'asc':'desc');
    });
  }

  // ---- Search (optional input id="txtSearchUsers") ----
  txtQ?.addEventListener('input', e=>{
    FILTER_Q = String(e.target.value||'').trim().toLowerCase();
    render();
  });

  // ---- Sort by header (add class="th-sort" data-sort="field") ----
  tbl.querySelectorAll('th.th-sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.sort;
      if (!key) return;
      if (SORT.key === key) SORT.dir *= -1; else { SORT.key=key; SORT.dir=1; }
      render();
    });
  });

  // ---- Add ----
  btnAdd.addEventListener('click', ()=>{
    if (!SUPER) return alert('ត្រូវការ SUPER');
    frm.reset();
    idEl.value = '';
    roleEl.value = 'viewer';
    fillDeptSelect('');
    fillUnitSelect('', '');
    nameEl.classList.remove('is-invalid');
    roleEl.classList.remove('is-invalid');
    modal?.show();
  });

  // ---- Row actions ----
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]'); if (!btn) return;
    if (!SUPER) return alert('ត្រូវការ SUPER');

    const id  = btn.closest('tr')?.dataset?.id;
    const row = ROWS.find(x=>String(x.user_id)===String(id));
    if (!row) return;

    if (btn.dataset.act==='edit'){
      frm.reset();
      idEl.value   = row.user_id;
      nameEl.value = row.user_name || '';
      fullEl.value = row.full_name || '';
      roleEl.value = (row.user_type || 'viewer').toLowerCase();
      passEl.value = '';
      fillDeptSelect(row.department_id || '');
      fillUnitSelect(row.department_id || '', row.unit_id || '');
      nameEl.classList.remove('is-invalid');
      roleEl.classList.remove('is-invalid');
      modal?.show();
    }

    if (btn.dataset.act==='del'){
      if (!confirm('លុបអ្នកប្រើប្រាស់នេះមែនទេ?')) return;
      try{
        await gasDelete('users', ID_FIELDS.users, row.user_id);
        ROWS = ROWS.filter(x=>String(x.user_id)!==String(id));
        render(); $status('លុបរួចរាល់');
      }catch(err){ alert('បរាជ័យលុប: '+(err?.message||err)); }
    }
  });

  // ---- Save ----
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!SUPER) return alert('ត្រូវការ SUPER');

    const payload = {
      user_id      : idEl.value || null,
      user_name    : (nameEl.value||'').trim(),
      full_name    : (fullEl.value||'').trim(),
      user_type    : (roleEl.value||'viewer'),
      department_id: selDept.value || '',
      unit_id      : selUnit.value || '',
    };
    const pw = (passEl.value||'').trim();
    if (pw) payload.user_pass = pw; // កែពាក្យសម្ងាត់តែក្នុងករណីបញ្ចូល

    nameEl.classList.toggle('is-invalid', !payload.user_name);
    roleEl.classList.toggle('is-invalid', !payload.user_type);
    if (!payload.user_name || !payload.user_type) return;

    const old = btnSave.innerHTML; btnSave.disabled = true; btnSave.innerHTML = 'កំពុងរក្សាទុក…';
    try{
      const saved = await gasSave('users', payload);
      const row   = saved.row || saved;
      const i     = ROWS.findIndex(x=>String(x.user_id)===String(row.user_id));
      if (i>=0) ROWS[i] = row; else ROWS.push(row);
      render(); modal?.hide(); $status('រក្សាទុករួចរាល់');
    }catch(err){
      alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
    }finally{
      btnSave.disabled = false; btnSave.innerHTML = old;
    }
  });

  // ---- Dep → Unit linkage ----
  selDept.addEventListener('change', ()=> fillUnitSelect(selDept.value,''));
}






  /* ======================= Departments ======================= */
async function initDepartments(){
  const auth  = getAuth();
  const SUPER = isSuper(auth);

  // DOM
  const tbl     = document.getElementById('tblDepts');
  const tbody   = tbl?.querySelector('tbody');
  const btnAdd  = document.getElementById('btnAddDept');
  const frm     = document.getElementById('frmDept');
  const modal   = makeModal('mdlDept');
  const idEl    = document.getElementById('department_id');
  const nameEl  = document.getElementById('department_name');
  const txtQ    = document.getElementById('txtSearchDept');
  const $status = (m)=>{ const el=document.getElementById('statusDept'); if(el) el.textContent=m||''; };

  if (!tbl || !tbody || !btnAdd || !frm || !idEl || !nameEl) return;

  // Skeleton
  (function skel(){ tbody.innerHTML=''; for(let i=0;i<3;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="3" class="skel"></td>`; tbody.appendChild(tr);} })();

  // State
  let ROWS = [];
  let FILTER_Q = '';
  let SORT = { key:'department_id', dir:1 }; // 1=asc, -1=desc

  // Load
  try{
    ROWS = await gasList('departments');
    render();
    $status(`បានផ្ទុក ${ROWS.length} នាយកដ្ឋាន`);
  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
    $status('បរាជ័យទាញទិន្នន័យ');
  }

  // Render
  function render(){
    let list = ROWS.slice();

    // filter
    if (FILTER_Q){
      const q = FILTER_Q;
      list = list.filter(r =>
        String(r.department_id).toLowerCase().includes(q) ||
        String(r.department_name||'').toLowerCase().includes(q)
      );
    }

    // sort (numeric aware)
    const k = SORT.key;
    list.sort((a,b)=>{
      const av = (a[k] ?? '').toString();
      const bv = (b[k] ?? '').toString();
      return av.localeCompare(bv, undefined, {numeric:true, sensitivity:'base'}) * SORT.dir;
    });

    if (!list.length){
      tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
      return;
    }

    const frag = document.createDocumentFragment();
    for (const r of list){
      const tr = document.createElement('tr');
      tr.dataset.id = r.department_id;
      tr.innerHTML = `
        <td style="width:110px"><span class="badge text-bg-light border">#${r.department_id}</span></td>
        <td>${r.department_name || ''}</td>
        <td class="td-actions text-end" style="width:160px">
          <div class="actions-right">
            ${SUPER
              ? `<button class="btn btn-sm btn-warning" data-act="edit">កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del">លុប</button>`
              : `<span class="text-muted">—</span>`}
          </div>
        </td>`;
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    // update sort indicators
    tbl.querySelectorAll('th.th-sort').forEach(th=>{
      th.classList.remove('asc','desc');
      if (th.dataset.sort === SORT.key) th.classList.add(SORT.dir===1?'asc':'desc');
    });
  }

  // Search (filter)
  txtQ?.addEventListener('input', e=>{
    FILTER_Q = String(e.target.value||'').trim().toLowerCase();
    render();
  });

  // Sort by header (ensure your <th> has class "th-sort" and data-sort="field")
  tbl.querySelectorAll('th.th-sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.sort;
      if (!key) return;
      if (SORT.key === key) SORT.dir *= -1; else { SORT.key = key; SORT.dir = 1; }
      render();
    });
  });

  // Add
  btnAdd.addEventListener('click', ()=>{
    if (!SUPER) return alert('ត្រូវការ SUPER');
    frm.reset();
    idEl.value   = '';
    nameEl.value = '';
    nameEl.classList.remove('is-invalid');
    modal?.show();
  });

  // Row actions
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    if (!SUPER) return alert('ត្រូវការ SUPER');

    const id  = btn.closest('tr')?.dataset?.id;
    const row = ROWS.find(x=>String(x.department_id)===String(id));
    if (!row) return;

    if (btn.dataset.act === 'edit'){
      idEl.value   = row.department_id;
      nameEl.value = row.department_name || '';
      nameEl.classList.remove('is-invalid');
      modal?.show();
    }

    if (btn.dataset.act === 'del'){
      if (!confirm('តើចង់លុបធាតុនេះមែនទេ?')) return;
      try{
        await gasDelete('departments', ID_FIELDS.departments, row.department_id);
        ROWS = ROWS.filter(x=>String(x.department_id)!==String(id));
        render(); $status('លុបរួចរាល់');
      }catch(err){
        console.error(err);
        alert('បរាជ័យលុប: ' + (err?.message || err));
      }
    }
  });

  // Save
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!SUPER) return alert('ត្រូវការ SUPER');

    const name = (nameEl.value||'').trim();
    nameEl.classList.toggle('is-invalid', !name);
    if (!name) return;

    const payload = idEl.value
      ? { department_id: Number(idEl.value), department_name: name }
      : { department_name: name };

    const btn = document.getElementById('btnSaveDept');
    const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'កំពុងរក្សាទុក…';
    try{
      const res = await gasSave('departments', payload);
      const row = res.row || res;
      const i = ROWS.findIndex(x=>String(x.department_id)===String(row.department_id));
      if (i>=0) ROWS[i]=row; else ROWS.push(row);
      render(); modal?.hide(); $status('រក្សាទុករួចរាល់');
    }catch(err){
      console.error(err);
      alert('បរាជ័យរក្សាទុក: ' + (err?.message || err));
    }finally{
      btn.disabled = false; btn.innerHTML = old;
    }
  });
}





  /* ======================= Units ======================= */
  async function initUnits(){
    const auth = getAuth(); const SUPER = isSuper(auth);
    const tbody = document.querySelector('#tblUnits tbody');
    const btnAdd= document.getElementById('btnAddUnit');
    const frm   = document.getElementById('frmUnit');
    const modal = makeModal('mdlUnit');
    const idEl  = document.getElementById('unit_id');
    const nameEl= document.getElementById('unit_name');
    const selDept = document.getElementById('department_id');
    const status= (m)=>{ const el=document.getElementById('statusUnit'); if(el) el.textContent=m||''; };

    if (!tbody || !btnAdd || !frm || !idEl || !nameEl || !selDept) return;

    let depts = [], rows = [];
    const skel=()=>{ tbody.innerHTML=''; for(let i=0;i<3;i++){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="4" class="skel"></td>`; tbody.appendChild(tr);} };
    skel();

    try{
      depts = await gasList('departments');
      if (!SUPER && auth?.department_id){ depts = depts.filter(d=>String(d.department_id)===String(auth.department_id)); }
      rows = await gasList('units', SUPER?{}:{ department_id: auth?.department_id });
      fillDeptSelect(); render(rows);
      status(`បានផ្ទុក ${rows.length} ផ្នែក`);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="4" class="text-danger text-center py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
      status('បរាជ័យទាញទិន្នន័យ');
    }

    function fillDeptSelect(selected){
      selDept.innerHTML = `<option value="">— ជ្រើសការិយាល័យ —</option>`+
        depts.map(d=>`<option value="${d.department_id}">${d.department_name}</option>`).join('');
      selDept.disabled = !SUPER;
      if (selected) selDept.value = selected; else if(!SUPER) selDept.value = auth?.department_id || '';
    }
    function deptName(id){ return (depts.find(d=>String(d.department_id)===String(id))?.department_name)||''; }
    function render(list){
      if(!list.length){ tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`; return; }
      const frag = document.createDocumentFragment();
      for (const r of list){
        const tr = document.createElement('tr');
        tr.dataset.id = r.unit_id;
        tr.innerHTML = `
          <td style="width:90px">${r.unit_id}</td>
          <td>${r.unit_name||''}</td>
          <td style="width:220px">${deptName(r.department_id)}</td>
          <td class="text-end" style="width:160px">
            ${SUPER
              ? `<button class="btn btn-sm btn-warning me-1" data-act="edit">កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del">លុប</button>`
              : `<span class="text-muted">—</span>`}
          </td>`;
        frag.appendChild(tr);
      }
      tbody.innerHTML=''; tbody.appendChild(frag);
    }

    btnAdd.addEventListener('click', ()=>{ frm.reset(); idEl.value=''; fillDeptSelect(); modal?.show(); });
    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      const id  = btn.closest('tr')?.dataset?.id;
      const row = rows.find(x=>String(x.unit_id)===String(id));
      if (btn.dataset.act==='edit'){
        idEl.value = row.unit_id; nameEl.value = row.unit_name||''; fillDeptSelect(row.department_id); modal?.show();
      }
      if (btn.dataset.act==='del'){
        if (!confirm('លុបមែនទេ?')) return;
        try{ await gasDelete('units', ID_FIELDS.units, row.unit_id);
             rows = rows.filter(x=>String(x.unit_id)!==String(id)); render(rows); }
        catch(err){ alert(err?.message||err); }
      }
    });
    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=nameEl.value.trim(); nameEl.classList.toggle('is-invalid', !name); if(!name) return;
      const dep = SUPER ? selDept.value : (auth?.department_id || '');
      if (!dep){ alert('សូមជ្រើសការិយាល័យ'); return; }
      const payload = idEl.value ? { unit_id:Number(idEl.value), unit_name:name, department_id:dep }
                                 : { unit_name:name, department_id:dep };
      const btn = document.getElementById('btnSaveUnit'); const old=btn.innerHTML; btn.disabled=true; btn.innerHTML='កំពុងរក្សាទុក…';
      try{
        const res = await gasSave('units', payload);
        const row = res.row || res;
        const i = rows.findIndex(x=>String(x.unit_id)===String(row.unit_id));
        if (i>=0) rows[i]=row; else rows.push(row);
        render(rows); modal?.hide();
      }catch(err){ alert(err?.message||err); }
      finally{ btn.disabled=false; btn.innerHTML=old; }
    });
  }

 /* ======================= Periods view (sortable) ======================= */

async function initPeriods(){
  const SUPER = isSuper(getAuth());

  const table    = document.getElementById('tblPeriods');
  const tbody    = table?.querySelector('tbody');
  const ths      = Array.from(table?.querySelectorAll('thead th.th-sort') || []);
  const selYear  = document.getElementById('selYear');
  const txtSearch= document.getElementById('txtSearch');
  const btnGen   = document.getElementById('btnGenYear');

  const mdl      = makeModal('mdlPeriod');
  const frm      = document.getElementById('frmPeriod');
  const idEl     = document.getElementById('period_id');
  const nameEl   = document.getElementById('period_name');

  const PERIOD_ID_FIELD = (window.ID_FIELDS && ID_FIELDS.periods) || 'period_id';
  const $status = m => { const el=document.getElementById('statusPeriods'); if(el) el.textContent=m||''; };

  if (!table || !tbody || !selYear || !btnGen || !frm) return;
  if (!SUPER) btnGen.style.display = 'none';

  // ---------- helpers ----------
  const mNames = ['មករា','កុម្ភះ','មីនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
  const getYear  = pid => ( /^(\d{4})/.exec(String(pid||'')) || [] )[1] || '';
  const getTag   = pid => ( String(pid||'').match(/(M\d{2}|Q[1-4]|H[12]|N9|Y12)$/) || [] )[1] || '';
  const pretty   = (pid, fallback='')=>{
    const y = getYear(pid), tag = getTag(pid);
    if (/^M\d{2}$/.test(tag)) return `${mNames[+tag.slice(1)-1]} ${y}`;
    if (/^(Q[1-4]|H[12])$/.test(tag)) return `${tag} ${y}`;
    if (tag==='N9')  return `៩ខែ ${y}`;
    if (tag==='Y12') return `១២ខែ ${y}`;
    return fallback || y;
  };
  const seqOf = pid=>{
    const tag=getTag(pid);
    if (/^M\d{2}$/.test(tag)) return 100+(+tag.slice(1));
    if (/^Q[1-4]$/.test(tag)) return 200+(+tag.slice(1));
    if (/^H[12]$/.test(tag))  return 300+(tag==='H1'?1:2);
    if (tag==='N9') return 400;
    if (tag==='Y12')return 500;
    return 9999;
  };
  // normalize any row shapes (object/array, header names Khmer/EN)
  const norm = r=>{
    if (Array.isArray(r)) {
      const [period_id, period_name, year, month] = r;
      return { period_id, period_name, year, month };
    }
    const period_id   = r.period_id ?? r['Period ID'] ?? r.ID ?? r.id;
    const period_name = r.period_name ?? r['ឈ្មោះ'] ?? r.name ?? r['Name'];
    const year        = r.year ?? r['Year'];
    const month       = r.month ?? r['Month'];
    return { period_id, period_name, year, month };
  };

  // ---------- state ----------
  let ALL = [];
  const nowY = new Date().getFullYear();
  if (!selYear.options.length){
    for (let y=nowY-3;y<=nowY+3;y++){
      const o=document.createElement('option'); o.value=y; o.textContent=y; selYear.appendChild(o);
    }
  }
  selYear.value = selYear.value || String(nowY);
  let CUR_YEAR  = +selYear.value;
  let FILTER_Q  = '';
  let SORT      = { key:'id', dir:'asc' };

  const applySortClasses = ()=>{
    ths.forEach(th=>{
      th.classList.remove('active','desc');
      if (th.dataset.sort===SORT.key){ th.classList.add('active'); if (SORT.dir==='desc') th.classList.add('desc'); }
    });
  };

  // skeleton
  tbody.innerHTML=''; for(let i=0;i<4;i++){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="5" class="skel"></td>'; tbody.appendChild(tr); }

  // ---------- load ----------
  async function load(){
    try{
      $status('កំពុងផ្ទុកទិន្នន័យ…');
      const raw = await gasList('periods').catch(()=>[]);
      ALL = raw.map(norm).filter(x=>x.period_id);
      render();
      $status(`បានផ្ទុក ${ALL.length} រយៈពេល`);
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">បរាជ័យទាញទិន្នន័យ</td></tr>`;
      $status('បរាជ័យទាញទិន្នន័យ');
    }
  }
  await load(); applySortClasses();

  // ---------- render ----------
  function render(){
    const rows = ALL
      .filter(r => String(r.year || getYear(r.period_id)) === String(CUR_YEAR))
      .filter(r => FILTER_Q ? ( (r.period_id+' '+(r.period_name||'')+' '+pretty(r.period_id)).toLowerCase().includes(FILTER_Q) ) : true)
      .sort((a,b)=>{
        if (SORT.key==='id')   return (SORT.dir==='asc'?1:-1) * a.period_id.localeCompare(b.period_id);
        if (SORT.key==='name') return (SORT.dir==='asc'?1:-1) * ( (a.period_name||pretty(a.period_id)).toLowerCase().localeCompare((b.period_name||pretty(b.period_id)).toLowerCase()) );
        if (SORT.key==='year') return (SORT.dir==='asc'?1:-1) * ((+a.year||+getYear(a.period_id)) - (+b.year||+getYear(b.period_id)));
        if (SORT.key==='seq')  return (SORT.dir==='asc'?1:-1) * (seqOf(a.period_id) - seqOf(b.period_id));
        return 0;
      });

    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">គ្មានទិន្នន័យ</td></tr>`;
      return;
    }
    const frag = document.createDocumentFragment();
    for (const r of rows){
      const yy  = r.year || getYear(r.period_id);
      const tag = getTag(r.period_id);
      const mon = /^M\d{2}$/.test(tag) ? tag.slice(1) : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.period_id}</td>
        <td>${r.period_name || pretty(r.period_id)}</td>
        <td style="width:120px">${yy}</td>
        <td style="width:120px">${mon}</td>
        <td class="td-actions" style="width:180px">
          <div class="actions-right">
            ${SUPER
              ? `<button class="btn btn-sm btn-warning" data-act="edit" data-id="${r.period_id}">កែ</button>
                 <button class="btn btn-sm btn-danger"  data-act="del"  data-id="${r.period_id}">លុប</button>`
              : `<span class="text-muted">—</span>`}
          </div>
        </td>`;
      frag.appendChild(tr);
    }
    tbody.innerHTML=''; tbody.appendChild(frag);
  }

  // ---------- sort / search / year ----------
  ths.forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.sort;
      if (SORT.key===k) SORT.dir = (SORT.dir==='asc' ? 'desc' : 'asc');
      else { SORT.key=k; SORT.dir='asc'; }
      applySortClasses(); render();
    });
  });
  txtSearch?.addEventListener('input', e=>{ FILTER_Q = String(e.target.value||'').trim().toLowerCase(); render(); });
  const onYear = ()=>{ CUR_YEAR = +selYear.value || nowY; render(); };
  selYear.addEventListener('change', onYear);
  selYear.addEventListener('input',  onYear);

  // ---------- row actions ----------
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const id  = btn.dataset.id;
    const row = ALL.find(x=>String(x.period_id)===String(id)); if(!row) return;

    if (btn.dataset.act==='edit'){
      idEl.value = row.period_id;
      nameEl.value = row.period_name || pretty(row.period_id);
      nameEl.classList.remove('is-invalid');
      mdl?.show();
    }

    if (btn.dataset.act==='del'){
      if (!confirm(`លុប Period: ${id} ?`)) return;
      try{
        await gasDelete('periods', PERIOD_ID_FIELD, id);
        ALL = ALL.filter(x=>String(x.period_id)!==String(id));
        render(); $status('លុបរួចរាល់');
      }catch(err){ alert('បរាជ័យលុប: ' + (err?.message||err)); }
    }
  });

  // ---------- save rename ----------
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const pid  = idEl.value;
    const name = (nameEl.value||'').trim();
    nameEl.classList.toggle('is-invalid', !name);
    if (!name) return;

    const btn = document.getElementById('btnSavePeriod');
    const old = btn.innerHTML; btn.disabled=true; btn.innerHTML='កំពុងរក្សាទុក…';
    try{
      const saved = await gasSave('periods', { period_id: pid, period_name: name });
      const i = ALL.findIndex(x=>String(x.period_id)===String(pid));
      if (i>=0) ALL[i] = { ...ALL[i], ...(saved.row||saved) };
      render(); mdl?.hide(); $status('រក្សាទុករួចរាល់');
    }catch(err){ alert('បរាជ័យរក្សាទុក: ' + (err?.message||err)); }
    finally{ btn.disabled=false; btn.innerHTML=old; }
  });

  // ---------- generate year (send id+name+year+month) ----------
  function buildWanted(y){
    const rows=[];
    // 12 months
    for (let m=1;m<=12;m++){
      const mm  = String(m).padStart(2,'0');
      const pid = `${y}M${mm}`;
      rows.push({ period_id:pid, period_name:`${mNames[m-1]} ${y}`, year:y, month:mm });
    }
    // Q1..Q4
    for (let q=1;q<=4;q++){
      const pid = `${y}Q${q}`;
      rows.push({ period_id:pid, period_name:`Q${q} ${y}`, year:y, month:`Q${q}` });
    }
    // H1/H2
    rows.push({ period_id:`${y}H1`, period_name:`H1 ${y}`, year:y, month:'H1' });
    rows.push({ period_id:`${y}H2`, period_name:`H2 ${y}`, year:y, month:'H2' });
    // 9-month & 12-month
    rows.push({ period_id:`${y}N9`,  period_name:`៩ខែ ${y}`,  year:y, month:'N9'  });
    rows.push({ period_id:`${y}Y12`, period_name:`១២ខែ ${y}`, year:y, month:'Y12' });
    return rows;
  }

 btnGen.addEventListener('click', async ()=>{
  if (!SUPER) return alert('ត្រូវការ SUPER');

  const y = Number(selYear.value || new Date().getFullYear());
  if (!confirm(`បង្កើតរយៈពេលសម្រាប់ឆ្នាំ ${y} ?`)) return;

  const old = btnGen.innerHTML;
  btnGen.disabled = true;
  btnGen.innerHTML = 'កំពុងបង្កើត…';

  try {
    // 1) សាក bulk API: route=period&op=generate&year=YYYY
    const GAS_BASE = (window.GAS_BASE || (await import('../../../assets/js/config.js')).GAS_BASE);
    const token    = (await import('../../../assets/js/app.auth.js')).getAuth()?.token || '';
    const bulkOk = await (async () => {
      try {
        const u = new URL(GAS_BASE);
        u.searchParams.set('api','1');
        u.searchParams.set('route','period');   // ⚠️ singular 'period' សម្រាប់ generate
        u.searchParams.set('op','generate');
        u.searchParams.set('year', String(y));
        if (token) u.searchParams.set('token', token);

        const r = await fetch(u.toString(), { cache:'no-store' });
        const j = await r.json().catch(()=> ({}));
        if (j && j.ok === false) throw new Error(j.error || 'API error');
        return true; // success
      } catch (e) {
        // មិនគាំទ្រ bulk → fallback
        const msg = String(e?.message || e);
        if (/unknown op|unknown route|not found|404/i.test(msg)) return false;
        // ករណីផ្សេងៗ តែបើ JSON មិនត្រឡប់សញ្ញាស្ថានៈ → fallback ផងដែរ
        return false;
      }
    })();

    // 2) បើ bulk មិនមាន → build rows ហើយ save ជាចំណុះៗ
    if (!bulkOk) {
      const KH_MONTHS = ['មករា','កុម្ភះ','មីនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
      const want = [];
      for (let m=1; m<=12; m++){
        const mm = String(m).padStart(2,'0');
        want.push({ period_id:`${y}M${mm}`, period_name:`${KH_MONTHS[m-1]} ${y}`, year:y, month:mm });
      }
      for (let q=1; q<=4; q++) want.push({ period_id:`${y}Q${q}`, period_name:`Q${q} ${y}`, year:y, month:`Q${q}` });
      want.push({ period_id:`${y}H1`,  period_name:`H1 ${y}`,  year:y, month:'H1' });
      want.push({ period_id:`${y}H2`,  period_name:`H2 ${y}`,  year:y, month:'H2' });
      want.push({ period_id:`${y}N9`,  period_name:`៩ខែ ${y}`,  year:y, month:'N9' });
      want.push({ period_id:`${y}Y12`, period_name:`១២ខែ ${y}`, year:y, month:'Y12' });

      const have = new Set(ALL.map(r => String(r.period_id)));
      const todo = want.filter(r => !have.has(String(r.period_id)));
      if (!todo.length) { alert('ឆ្នាំនេះមានគ្រប់រួចហើយ'); btnGen.disabled=false; btnGen.innerHTML=old; return; }

      const CHUNK = 5; // កុំបុក quota
      for (let i = 0; i < todo.length; i += CHUNK) {
        await Promise.allSettled(
          todo.slice(i, i+CHUNK).map(row => gasSave('periods', row)) // ⬅️ អនុញ្ញាត fallback នៅក្នុង gasSave()
        );
      }
    }

    // reload table & keep year
    const rows = await gasList('periods').catch(()=>[]);
    ALL = rows;
    selYear.value = String(y);
    CUR_YEAR = y;
    render();
    $status('បង្កើតរួចរាល់');
  } catch (err) {
    console.error('[periods] generate failed:', err);
    alert('បរាជ័យបង្កើត: ' + (err?.message || err));
  } finally {
    btnGen.disabled = false;
    btnGen.innerHTML = old;
  }
});

}





  /* ---------- Modal helper (BS5/BS4/fallback) ---------- */
  function makeModal(id){
    const el = typeof id === 'string' ? document.getElementById(id) : id;
    if (!el) return null;
    if (window.bootstrap?.Modal){
      let inst = bootstrap.Modal.getInstance ? bootstrap.Modal.getInstance(el) : null;
      if (!inst) inst = new bootstrap.Modal(el, {backdrop:true, keyboard:true, focus:true});
      return { show:()=>inst.show(), hide:()=>inst.hide() };
    }
    if (window.jQuery?.fn?.modal){
      const $el = jQuery(el);
      return { show:()=>$el.modal('show'), hide:()=>$el.modal('hide') };
    }
    return { show(){ el.style.display='block'; }, hide(){ el.style.display='none'; } };
  }

  /* ---------- Footer Khmer clock ---------- */
  (function startKhClock(){
    const el = document.getElementById('clockKh'); if (!el) return;
    const months = ['មករា','កុម្ភៈ','មិនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
    const dow    = ['អាទិត្យ','ចន្ទ','អង្គារ','ពុធ','ព្រហស្បតិ៍','សុក្រ','សៅរ៍'];
    const pad=n=>String(n).padStart(2,'0');
    function fmt(){ const d=new Date();
      el.textContent = `${dow[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} • ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.title = `(${pad(d.getHours())}:${pad(d.getMinutes())}) PHD Report`;
    }
    fmt(); setInterval(fmt,1000);
  })();

  // expose GAS_BASE to periods generator (tiny helper)
  import * as cfg from './assets/js/config.js';
  window.GAS_BASE = cfg.GAS_BASE;
</script>


</body>
</html>