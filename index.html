<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>PHD Report | Dashboard</title>

  <!-- Fonts Khmer -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@300;400;500;700&display=swap" rel="stylesheet"/>

  <!-- Gull CSS & Plugins -->
  <link href="dist-assets/css/themes/lite-purple.min.css" rel="stylesheet"/>
  <link href="dist-assets/css/plugins/perfect-scrollbar.min.css" rel="stylesheet"/>
  <link href="dist-assets/css/plugins/datatables.min.css" rel="stylesheet"/>

  <style>
    :root{
      --kh-font: "Noto Sans Khmer","Khmer OS Siemreap","Battambang",
                 system-ui,-apple-system,"Segoe UI",Arial,Helvetica,sans-serif;
      --kh-head: "Khmer Moul","Noto Sans Khmer",sans-serif;
    }
    html,body{ font-family:var(--kh-font)!important; background:#fafbfc; height:100%; }
    .kh-head{ font-family:var(--kh-head)!important }

    .app-admin-wrap{ height:100%; }
    .main-content-wrap{ min-height:100dvh; display:flex; flex-direction:column; }
    .app-footer{ margin-top:auto; }

    .main-header{ position:sticky; top:0; z-index:100; background:#ffffffCC; border-bottom:1px solid #eef0f4; }
    .container-page{ max-width:1200px; margin:0 auto; padding:8px }
    .g-kpi .card{ border:0; box-shadow:0 8px 20px rgba(0,0,0,.06) }

    .app-loading{ position:fixed; inset:0; z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; background:#fff; transition:opacity .2s ease; }
    .app-loading.hidden{ opacity:0; pointer-events:none }
    .loader-spin{ width:52px; height:52px; border-radius:50%; border:4px solid #e9ecef; border-top-color:#6f42c1; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .skeleton{ position:relative; overflow:hidden; background:#e9ecef; border-radius:6px; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent); animation:shimmer 1.1s infinite; }
    .skeleton-text{ display:block; height:14px; width:70%; margin:10px 16px; }

    @keyframes shimmer{ 100% { transform: translateX(100%); } }

    .userbox{ display:flex; align-items:center; gap:10px; padding:6px 10px; background:#fff; border-radius:999px; box-shadow:0 4px 16px rgba(0,0,0,.08); border:1px solid #eee; }
    .userbox .avatar{ width:30px; height:30px; border-radius:50%; background:#6f42c1; color:#fff; display:grid; place-items:center; font-weight:700; }
    .badge-role{ padding:.15rem .45rem; font-size:.7rem; border-radius:6px }

    .footer-clock{ display:flex; align-items:center; gap:10px; font-weight:600; }
    .dot{ width:8px; height:8px; border-radius:50%; background:#28a745; box-shadow:0 0 0 0 rgba(40,167,69,.7); animation:pulse 2s infinite; }
    @keyframes pulse{ 0%{transform:scale(.9); box-shadow:0 0 0 0 rgba(40,167,69,.7);} 70%{transform:scale(1); box-shadow:0 0 0 8px rgba(40,167,69,0);} 100%{transform:scale(.9); box-shadow:0 0 0 0 rgba(40,167,69,0);} }

    @font-face { font-family:'iconsmind'; src: local('x'); } /* avoid 404s */

    /* 🔔 Top-bar notification style */
    #issueAlert .alert{ margin:0; padding:.25rem .5rem; border-radius:999px; line-height:1.1; }
    #issueAlert .badge{ font-weight:700; padding:.2rem .45rem; border-radius:999px; }
  </style>
</head>

<body class="text-start">
<!-- Full-page loading -->
<div id="appLoading" class="app-loading">
  <div class="loader-spin" aria-hidden="true"></div>
  <div id="appLoadingText" class="text-muted">កំពុងផ្ទុកទិន្នន័យ…</div>
</div>

<div class="app-admin-wrap layout-sidebar-compact sidebar-dark-purple sidenav-open clearfix">

  <!-- ======= LEFT: primary ======= -->
  <div class="side-content-wrap">
    <div class="sidebar-left open rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
      <ul class="navigation-left">
        <li class="nav-item active" data-item="dashboard">
          <a class="nav-item-hold" href="#/"><i class="nav-icon i-Bar-Chart"></i><span class="nav-text">ផ្ទាំងគ្រប់គ្រង</span></a><div class="triangle"></div>
        </li>
        <li class="nav-item"><a class="nav-item-hold" href="#/issues"><i class="nav-icon i-Information"></i><span class="nav-text">បញ្ហាប្រឈម</span></a><div class="triangle"></div></li>
        <li class="nav-item" data-item="depts"><a class="nav-item-hold" href="#"><i class="nav-icon i-Library"></i><span class="nav-text">ជំពូក</span></a><div class="triangle"></div></li>
        <li class="nav-item" data-item="reports"><a class="nav-item-hold" href="#"><i class="nav-icon i-File-Clipboard-File--Text"></i><span class="nav-text">របាយការណ៍</span></a><div class="triangle"></div></li>
        <li class="nav-item menu-super-only" data-item="users"><a class="nav-item-hold" href="#"><i class="nav-icon i-Administrator"></i><span class="nav-text">អ្នកប្រើប្រាស់</span></a><div class="triangle"></div></li>
        <li class="nav-item" data-item="settings"><a class="nav-item-hold" href="#"><i class="nav-icon i-Gear-2"></i><span class="nav-text">កំណត់</span></a><div class="triangle"></div></li>
      </ul>
    </div>

    <!-- ======= LEFT: secondary (submenus) ======= -->
    <div class="sidebar-left-secondary rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
      <i class="sidebar-close i-Close"></i>

      <header class="px-3 pt-3">
        <div class="logo d-flex align-items-center gap-2">
          <img src="dist-assets/images/logo-text.png" alt=""/> <span class="kh-head">PHD Report</span>
        </div>
      </header>

      <!-- Dashboard submenu -->
      <div class="submenu-area" data-parent="dashboard">
        <header><h6>Dashboard</h6><p>ស្ថានភាពសរុប</p></header>
        <ul class="childNav">
          <li class="nav-item"><a href="#/"><i class="nav-icon i-Clock-3"></i><span class="item-name">Overview</span></a></li>
        </ul>
      </div>

      <!-- Depts submenu (dynamic) -->
      <div class="submenu-area" data-parent="depts">
        <header><h6>បញ្ចូលទិន្នន័យ</h6><p>តាមផ្នែក</p></header>
        <ul id="deptMenu" class="childNav">
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
        </ul>
      </div>

      <!-- Reports submenu -->
      <div class="submenu-area" data-parent="reports">
        <header><h6>របាយការណ៍</h6><p>របាយការណែនាំ</p></header>
        <ul class="childNav">
          <li class="nav-item"><a href="#/reports"><i class="nav-icon i-Bar-Chart"></i><span class="item-name">របាយការណ៍សង្ខែប</span></a></li>
        </ul>
      </div>

      <!-- Settings submenu (role-aware) -->
      <div class="submenu-area" data-parent="settings">
        <header><h6>ការកំណត់</h6><p>ទិន្នន័យមេ</p></header>
        <ul id="settingsMenu" class="childNav">
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
          <li class="nav-item"><span class="item-name skeleton skeleton-text"></span></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ======= RIGHT: main ======= -->
  <div class="main-content-wrap d-flex flex-column">
    <div class="main-header px-3 py-2 d-flex align-items-center">
      <div class="logo"><img src="dist-assets/images/logo.png" alt=""/></div>
      <div class="menu-toggle ms-2"><div></div><div></div><div></div></div>
      <div class="flex-grow-1"></div>

      <!-- 🔔 Notification area -->
      <div id="issueAlert" class="me-2"></div>

      <!-- User box -->
      <div id="userBox" class="userbox">
        <div class="avatar" id="userAvatar">U</div>
        <div class="meta">
          <div id="userName" class="small">អ្នកប្រើប្រាស់</div>
          <div id="userRole" class="badge-role bg-light text-secondary">viewer</div>
        </div>
        <a id="btnLogin" class="btn btn-sm btn-outline-primary ms-2" href="login.html">ចូលប្រើប្រាស់</a>
      </div>
    </div>

    <!-- Router outlet -->
    <div id="route-outlet"></div>

    <!-- Footer always at bottom -->
    <div class="app-footer">
      <div class="footer-bottom border-top pt-3 d-flex flex-column flex-sm-row align-items-center">
        <span class="flex-grow-1"></span>
        <div class="d-flex align-items-center gap-3">
          <div class="footer-clock">
            <span class="dot" aria-hidden="true"></span>
            <span id="clockKh">-- -- ---- --:--:--</span>
          </div>
          <div class="d-flex align-items-center">
            <img class="logo me-2" src="dist-assets/images/logo-text.png" alt=""/>
            <div>
              <p class="m-0">&copy; PHD Report</p>
              <p class="m-0">លាង ផានិត្យ</p>
              <p class="m-0">០៩៧២០៩៧៨បប</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Vendor JS -->
<script src="dist-assets/js/plugins/jquery-3.3.1.min.js"></script>
<script src="dist-assets/js/plugins/bootstrap.bundle.min.js"></script>
<script src="dist-assets/js/plugins/perfect-scrollbar.min.js"></script>
<script src="dist-assets/js/plugins/datatables.min.js"></script>
<script src="dist-assets/js/plugins/echarts.min.js"></script>
<script src="dist-assets/js/scripts/script.min.js"></script>
<script src="dist-assets/js/scripts/sidebar.compact.script.min.js"></script>
<script src="dist-assets/js/scripts/customizer.script.min.js"></script>

<!-- App JS (single module) -->
<script type="module">
  import "./assets/js/firebase.client.js";
  import { whenAuthReady, ensureLoggedIn, getAuth, applyLoginButton } from "./assets/js/app.auth.js";
  import { startRouter } from "./assets/js/router.js";
  import { buildDeptMenu, buildSettingsMenu } from "./assets/js/app.menu.js";

  // Overlay
  function hideOverlay(){ document.getElementById('appLoading')?.classList.add('hidden'); }
  const overlayFailSafe = setTimeout(hideOverlay, 3000);

  // ----- Header -----
  function refreshHeader(){
    const a = getAuth();
    const nameEl = document.getElementById('userName');
    const roleEl = document.getElementById('userRole');
    const avatar = document.getElementById('userAvatar');
    const btn    = document.getElementById('btnLogin');

    const displayName = a?.full_name || a?.user_name || a?.username || 'អ្នកប្រើប្រាស់';
    if (nameEl) nameEl.textContent = displayName;

    const role = String(a?.role || 'viewer').toLowerCase();
    document.querySelectorAll('.menu-super-only').forEach(el=>{ el.style.display = (role==='super') ? '' : 'none'; });
    if (roleEl){
      roleEl.textContent = role;
      roleEl.className = 'badge-role ' + (
        role==='super' ? 'bg-primary text-white' :
        role==='admin' ? 'bg-success text-white' :
                         'bg-light text-secondary'
      );
    }
    if (avatar){
      const letter = (displayName.match(/[A-Za-zក-ហ]/) || ['U'])[0].toUpperCase();
      avatar.textContent = letter;
    }
    if (btn) applyLoginButton(btn);
  }

  // Khmer clock
  (function startKhClock(){
    const el = document.getElementById('clockKh'); if(!el) return;
    const months = ['មករា','កុម្ភៈ','មិនា','មេសា','ឧសភា','មិថុនា','កក្កដា','សីហា','កញ្ញា','តុលា','វិច្ឆិកា','ធ្នូ'];
    const dow    = ['អាទិត្យ','ចន្ទ','អង្គារ','ពុធ','ព្រហស្បតិ៍','សុក្រ','សៅរ៍'];
    const pad=n=>String(n).padStart(2,'0');
    function fmt(){ const d=new Date();
      el.textContent = `${dow[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} • ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    fmt(); setInterval(fmt,1000);
  })();

  // === 🔔 Top-bar Issues Alert ===
  function setIssueAlert(stats) {
    const host = document.getElementById('issueAlert');
    if (!host) return;
    const total   = +stats?.total   || 0;
    const blocked = +stats?.blocked || 0;
    const ongoing = +stats?.ongoing || 0;
    const planned = +stats?.planned || 0;
    if (total === 0) { host.innerHTML = ''; return; }
    const title = `សរុប ${total} • ឧបសគ្គ ${blocked} • កំពុងដំណើរការ ${ongoing} • បានគ្រោង ${planned}`;
    host.innerHTML = `
      <div class="alert alert-light border d-flex align-items-center gap-2 m-0" role="alert" title="${title}">
        <span class="small text-muted">បញ្ហា</span>
        <span class="badge text-bg-danger"  aria-label="blocked">${blocked}</span>
        <span class="badge text-bg-info"    aria-label="ongoing">${ongoing}</span>
        <span class="badge text-bg-warning" aria-label="planned">${planned}</span>
      </div>`;
  }
  window.setIssueAlert = setIssueAlert;

  // ===== Boot =====
  await whenAuthReady();                 // រង់ចាំ auth ready/cached
  await ensureLoggedIn('login.html');    // ⬅️ Guard បើមិន login នឹង redirect ទៅ login.html

  refreshHeader();
  await buildDeptMenu('deptMenu');
  await buildSettingsMenu('settingsMenu');

  hideOverlay(); clearTimeout(overlayFailSafe);

  window.addEventListener('auth:changed', async ()=>{
    refreshHeader();
    await buildDeptMenu('deptMenu');
    await buildSettingsMenu('settingsMenu');
    hideOverlay();
  });

  await startRouter();                   // ចាប់ផ្តើម SPA router
</script>


</body>
</html>
