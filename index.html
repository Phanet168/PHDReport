<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>ផ្ទាំងគ្រប់គ្រង | PHD Report</title>

  <!-- Google Khmer Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <!-- Gull CSS -->
  <link href="dist-assets/css/themes/lite-purple.min.css" rel="stylesheet" />
  <link href="dist-assets/css/plugins/perfect-scrollbar.min.css" rel="stylesheet" />

  <style>
    /* ===== Khmer Font Defaults ===== */
    :root{
      --kh-font: "Noto Sans Khmer", Nunito, Arial, Helvetica, sans-serif;
      --kh-head: "Khmer Moul","Noto Sans Khmer", sans-serif;
    }
    html, body{
      font-family: var(--kh-font) !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    .brand-kh, .h-kh, .kh-head{
      font-family: var(--kh-head) !important;
      letter-spacing: .2px;
    }
    /* Sidebar + submenu */
    .navigation-left .nav-text,
    .navigation-left .nav-item-hold,
    .navigation-left a,
    .sidebar-left-secondary,
    .sidebar-left-secondary .childNav .item-name,
    .sidebar-left-secondary .childNav a,
    .submenu-area header h6,
    .submenu-area header p{
      font-family: var(--kh-font) !important;
      letter-spacing: 0;
    }
    .btn, .btn *, .badge, .dropdown-menu, .dropdown-item,
    .form-control, .form-select, .custom-select, .search-input,
    input, textarea, select, label, small, code, kbd, table, th, td{
      font-family: var(--kh-font) !important;
    }
    .breadcrumb h1, .breadcrumb ul, .card-title, .app-footer, .customizer{
      font-family: var(--kh-font) !important;
    }
    .submenu-area header .logo .brand-kh{ font-family: var(--kh-head) !important; }
    i.nav-icon, i[class^="i-"], i[class*=" i-"]{ font-family: inherit; }
    .search-bar input::placeholder{ opacity:.8; }
    /* utility classes for role visibility */
    .menu-super-only { display: inherit; }
    .menu-input { display: inherit; }
  </style>
</head>

<body class="text-start">
  <div class="app-admin-wrap layout-sidebar-compact sidebar-dark-purple sidenav-open clearfix">
    <div class="side-content-wrap">
      <!-- Primary left -->
      <div class="sidebar-left open rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
        <ul class="navigation-left">
          <li class="nav-item" data-item="dashboard">
            <a class="nav-item-hold" href="#"><i class="nav-icon i-Bar-Chart"></i><span class="nav-text">ផ្ទាំងគ្រប់គ្រង</span></a><div class="triangle"></div>
          </li>

          <!-- Dynamic Departments -->
          <li class="nav-item active" data-item="depts">
            <a class="nav-item-hold" href="#"><i class="nav-icon i-Library"></i><span class="nav-text">ការិយាល័យ</span></a>
            <div class="triangle"></div>
          </li>

          <li class="nav-item" data-item="reports">
            <a class="nav-item-hold" href="#"><i class="nav-icon i-File-Clipboard-File--Text"></i><span class="nav-text">របាយការណ៍</span></a><div class="triangle"></div>
          </li>

          <!-- Users (example super-only section) -->
          <li class="nav-item menu-super-only" data-item="users">
            <a class="nav-item-hold" href="#"><i class="nav-icon i-Administrator"></i><span class="nav-text">អ្នកប្រើប្រាស់</span></a><div class="triangle"></div>
          </li>

          <!-- Settings (often super-only) -->
          <li class="nav-item menu-super-only" data-item="settings">
            <a class="nav-item-hold" href="#"><i class="nav-icon i-Gear-2"></i><span class="nav-text">កំណត់ផ្សេងៗ</span></a><div class="triangle"></div>
          </li>
        </ul>
      </div>

      <!-- Secondary left (submenus) -->
      <div class="sidebar-left-secondary rtl-ps-none" data-perfect-scrollbar data-suppress-scroll-x="true">
        <i class="sidebar-close i-Close"></i>
        <header class="px-3 pt-3">
          <div class="logo d-flex align-items-center gap-2">
            <img src="dist-assets/images/logo-text.png" alt="" />
            <span class="brand-kh">PHD Report</span>
          </div>
        </header>

        <!-- Dashboards submenu -->
        <div class="submenu-area" data-parent="dashboard">
          <header><h6>Dashboards</h6><p>មើលស្ថានភាពសរុប</p></header>
          <ul class="childNav">
            <li class="nav-item"><a href="#"><i class="nav-icon i-Clock-3"></i><span class="item-name">Version 1</span></a></li>
          </ul>
        </div>

        <!-- Departments submenu (built by JS) -->
        <div class="submenu-area" data-parent="depts">
          <header><h6>ការិយាល័យ</h6><p>ជ្រើសការិយាល័យ និងផ្នែក</p></header>
          <ul id="deptMenu" class="childNav">
            <li class="nav-item"><a href="#"><span class="item-name text-muted">កំពុងទាញទិន្នន័យ...</span></a></li>
          </ul>
        </div>

        <!-- Reports -->
        <div class="submenu-area" data-parent="reports">
          <header><h6>របាយការណ៍</h6><p>សង្ខេប និងនាំចេញ</p></header>
          <ul class="childNav">
            <li class="nav-item"><a href="#"><i class="nav-icon i-Bar-Chart"></i><span class="item-name">សង្ខេបឆ្នាំ</span></a></li>
          </ul>
        </div>

        <!-- Users -->
        <div class="submenu-area menu-super-only" data-parent="users">
          <header><h6>អ្នកប្រើប្រាស់</h6><p>គ្រប់គ្រងសិទ្ធិ</p></header>
          <ul class="childNav">
            <li class="nav-item"><a href="#"><i class="nav-icon i-Male"></i><span class="item-name">បញ្ជីអ្នកប្រើ</span></a></li>
          </ul>
        </div>

        <!-- Settings -->
        <div class="submenu-area menu-super-only" data-parent="settings">
          <header><h6>កំណត់</h6><p>ទិន្នន័យមេ</p></header>
          <ul class="childNav">
            <li class="nav-item"><a href="#/mgmt/departments"><i class="nav-icon i-Building"></i><span class="item-name">គ្រប់គ្រងការិយាល័យ</span></a></li>
            <li class="nav-item"><a href="#/mgmt/units"><i class="nav-icon i-Library"></i><span class="item-name">គ្រប់គ្រងផ្នែក</span></a></li>
            <li class="nav-item"><a href="#/mgmt/periods"><i class="nav-icon i-Calendar-4"></i><span class="item-name">រយៈពេល</span></a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content-wrap d-flex flex-column">
      <div class="main-header">
        <div class="logo"><img src="dist-assets/images/logo.png" alt="" /></div>
        <div class="menu-toggle"><div></div><div></div><div></div></div>
        <div class="d-flex align-items-center">
          <div class="search-bar"><input id="q" type="text" placeholder="ស្វែងរក..." /><i class="search-icon text-muted i-Magnifi-Glass1"></i></div>
        </div>
        <div style="margin:auto"></div>
        <div class="header-part-right">
          <a id="btnLogin" class="btn btn-outline-primary btn-sm" href="login.html">ចូលប្រើប្រាស់</a>
        </div>
      </div>

      <!-- ===== Body ===== -->
      <div class="main-content">
        <div class="breadcrumb">
          <h1 class="me-2">Version 1</h1>
          <ul><li><a href="#">Dashboard</a></li><li>Version 1</li></ul>
        </div>
        <div class="separator-breadcrumb border-top"></div>

        <!-- sample Gull cards/charts (unchanged) -->
        <div class="row">
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="card card-icon-bg card-icon-bg-primary o-hidden mb-4">
              <div class="card-body text-center">
                <i class="i-Add-User"></i>
                <div class="content"><p class="text-muted mt-2 mb-0">New Leads</p><p class="text-primary text-24 line-height-1 mb-2">205</p></div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="card card-icon-bg card-icon-bg-primary o-hidden mb-4">
              <div class="card-body text-center">
                <i class="i-Financial"></i>
                <div class="content"><p class="text-muted mt-2 mb-0">Sales</p><p class="text-primary text-24 line-height-1 mb-2">$4021</p></div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="card card-icon-bg card-icon-bg-primary o-hidden mb-4">
              <div class="card-body text-center">
                <i class="i-Checkout-Basket"></i>
                <div class="content"><p class="text-muted mt-2 mb-0">Orders</p><p class="text-primary text-24 line-height-1 mb-2">80</p></div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="card card-icon-bg card-icon-bg-primary o-hidden mb-4">
              <div class="card-body text-center">
                <i class="i-Money-2"></i>
                <div class="content"><p class="text-muted mt-2 mb-0">Expense</p><p class="text-primary text-24 line-height-1 mb-2">$1200</p></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-8 col-md-12">
            <div class="card mb-4"><div class="card-body"><div class="card-title">This Year Sales</div><div id="echartBar" style="height:300px"></div></div></div>
          </div>
          <div class="col-lg-4 col-sm-12">
            <div class="card mb-4"><div class="card-body"><div class="card-title">Sales by Countries</div><div id="echartPie" style="height:300px"></div></div></div>
          </div>
        </div>

        <!-- footer -->
        <div class="flex-grow-1"></div>
        <div class="app-footer">
          <div class="footer-bottom border-top pt-3 d-flex flex-column flex-sm-row align-items-center">
            <span class="flex-grow-1"></span>
            <div class="d-flex align-items-center">
              <img class="logo" src="dist-assets/images/logo.png" alt="" />
              <div><p class="m-0">&copy; PHD Report</p><p class="m-0">All rights reserved</p></div>
            </div>
          </div>
        </div>
      </div>
      <!-- /main-content -->
    </div>
  </div>

  <!-- Search UI of Gull (optional) -->
  <div class="search-ui">
    <div class="search-header">
      <img src="dist-assets/images/logo.png" alt="" class="logo" />
      <button class="search-close btn btn-icon bg-transparent float-end mt-2"><i class="i-Close-Window text-22 text-muted"></i></button>
    </div>
    <input type="text" placeholder="Type here" class="search-input" autofocus />
  </div>

  <!-- Gull JS -->
  <script src="dist-assets/js/plugins/jquery-3.3.1.min.js"></script>
  <script src="dist-assets/js/plugins/bootstrap.bundle.min.js"></script>
  <script src="dist-assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="dist-assets/js/scripts/script.min.js"></script>
  <script src="dist-assets/js/scripts/sidebar.compact.script.min.js"></script>
  <script src="dist-assets/js/scripts/customizer.script.min.js"></script>
  <script src="dist-assets/js/plugins/echarts.min.js"></script>
  <script src="dist-assets/js/scripts/echart.options.min.js"></script>
  <script src="dist-assets/js/scripts/dashboard.v1.script.min.js"></script>

  <!-- App: build dynamic Dept/Unit menu + login state (token-aware) -->
  <script type="module">
    import { getAuth, applyLoginButton, isSuper, isDataEntry, isViewer } from './assets/js/app.auth.js';

    // === CONFIG ===
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbwuvNrQOG7CoQiEb6LXyz-0KJgir_H5LPjGrcS79Vf9qH-0sU9Mln5N3YvQJn4u_n74HA/exec";
    const ls = window.localStorage;

    // ---- Guard early: require login on dashboard
    const auth = getAuth();
    if (!auth) {
      location.replace('login.html');
    }

    // ---- Login button (logout/username)
    const btnLogin = document.getElementById('btnLogin');
    if (btnLogin) applyLoginButton(btnLogin);

    // ---- Role-based menu visibility
    if (isViewer(auth)) {
      // viewer មិនចាំបាច់ឃើញ user/settings
      document.querySelectorAll('.menu-super-only').forEach(el => el.style.display = 'none');
    } else if (!isSuper(auth)) {
      // dataentry ក៏លាក់ super-only ដែរ
      document.querySelectorAll('.menu-super-only').forEach(el => el.style.display = 'none');
    }

    // ---- Helper: token param
    function tokenParam(){
      const t = auth?.token || '';
      return t ? `&token=${encodeURIComponent(t)}` : '';
    }

    // ---- GAS list helper (token-aware)
    async function gasList(route, params = {}){
      const u = new URL(GAS_BASE);
      u.searchParams.set('api','1');
      u.searchParams.set('route', route);
      u.searchParams.set('op','list');
      Object.entries(params).forEach(([k,v]) => {
        if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v);
      });
      // attach token
      if (auth?.token) u.searchParams.set('token', auth.token);

      const r = await fetch(u, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      if (j.error) throw new Error(j.error);
      return Array.isArray(j.rows) ? j.rows : (Array.isArray(j) ? j : []);
    }

    async function buildDeptMenu(){
      const box = document.getElementById('deptMenu');
      box.innerHTML = '<li class="nav-item"><a href="#"><span class="item-name text-muted">កំពុងទាញទិន្នន័យ...</span></a></li>';

      try{
        let depts = await gasList('departments');
        // Client-side narrow (server guard might not apply on departments table)
        if (!isSuper(auth) && auth?.department_id){
          depts = depts.filter(d => String(d.department_id) === String(auth.department_id));
        }
        if (!depts.length){
          box.innerHTML = '<li class="nav-item"><a href="#"><span class="item-name text-muted">គ្មានទិន្នន័យ</span></a></li>';
          return;
        }
        box.innerHTML = '';
        for (const d of depts){
          // department row
          const li = document.createElement('li'); li.className = 'nav-item';
          const a = document.createElement('a'); a.href='#';
          a.innerHTML = `<i class="nav-icon i-Building"></i><span class="item-name">${d.department_name}</span>`;
          li.appendChild(a);
          box.appendChild(li);

          // units under department
          const units = await gasList('units', { department_id: d.department_id });
          if (!units.length){
            const em = document.createElement('li'); em.className='nav-item';
            em.innerHTML = `<a href="#"><span class="item-name text-muted ps-4">— គ្មានផ្នែក</span></a>`;
            box.appendChild(em);
          } else {
            units.forEach(u=>{
              const liu = document.createElement('li'); liu.className='nav-item';
              const link = document.createElement('a');
              link.href = `pages/departments/${d.department_id}/units/${u.unit_id}/index.html`;
              link.innerHTML = `<i class="nav-icon i-Right"></i><span class="item-name ps-3">${u.unit_name}</span>`;
              liu.appendChild(link);
              box.appendChild(liu);
            });
          }
        }
      }catch(err){
        box.innerHTML = `<li class="nav-item"><a href="#"><span class="item-name text-danger">បរាជ័យ: ${err.message}</span></a></li>`;
      }
    }

    // ---- Search quick filter
    document.getElementById('q').addEventListener('input',(e)=>{
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('.childNav .item-name').forEach(el=>{
        const ok = el.textContent.toLowerCase().includes(q);
        el.closest('li').style.display = ok ? '' : 'none';
      });
    });

    // ---- Init
    buildDeptMenu();
  </script>
</body>
</html>


