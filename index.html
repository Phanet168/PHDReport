<!doctype html>
<html lang="km">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DMS Reports</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  body{ background:#f7f8fb }
  .card{ border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.05) }
</style>
</head>
<body class="p-3">
  <div class="container">
    <h1 class="mb-3">ប្រព័ន្ធគ្រប់គ្រងរបាយការណ៍</h1>

    <div class="card mb-3">
      <div class="card-body">
        <form id="frmAdd" class="row g-2 align-items-end">
          <div class="col-md-2">
            <label class="form-label">Year</label>
            <input type="number" class="form-control" id="year" value="2025">
          </div>
          <div class="col-md-3">
            <label class="form-label">Period ID</label>
            <input class="form-control" id="period_id" placeholder="2025M08">
          </div>
          <div class="col-md-3">
            <label class="form-label">Indicator ID</label>
            <input class="form-control" id="indicator_id" placeholder="123">
          </div>
          <div class="col-md-2">
            <label class="form-label">Value</label>
            <input type="number" class="form-control" id="value" value="0">
          </div>
          <div class="col-md-2">
            <label class="form-label">Plan</label>
            <input type="number" class="form-control" id="plan" value="0">
          </div>
          <div class="col-12 mt-2">
            <button class="btn btn-primary">Save Report</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="d-flex gap-2 align-items-end mb-3">
          <div>
            <label class="form-label">Year</label>
            <input type="number" class="form-control" id="lyear" value="2025">
          </div>
          <div>
            <label class="form-label">Indicator</label>
            <input class="form-control" id="lind" placeholder="(optional)">
          </div>
          <button class="btn btn-outline-secondary" id="btnLoad">Load Reports</button>
        </div>
        <table class="table table-striped" id="tbl">
          <thead><tr>
            <th>report_id</th><th>indicator_id</th><th>period_id</th>
            <th>value</th><th>plan_value</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
const API_BASE = '<<PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE>>';

// Save (create) report
document.getElementById('frmAdd').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    indicator_id: Number(document.getElementById('indicator_id').value),
    period_id: document.getElementById('period_id').value.trim(),
    value: Number(document.getElementById('value').value),
    plan_value: Number(document.getElementById('plan').value),
    year: Number(document.getElementById('year').value)
  };
  const url = `${API_BASE}?api=1&route=report&op=upsert`;
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const data = await res.json();
  alert('Saved report_id: ' + data.row.report_id);
});

// Load reports (by year + optional indicator)
document.getElementById('btnLoad').addEventListener('click', async ()=>{
  const y = document.getElementById('lyear').value;
  const ind = document.getElementById('lind').value.trim();
  const q = new URLSearchParams({ api:'1', route:'report', op:'list', year:String(y) });
  if (ind) q.set('indicator_id', ind);
  const url = `${API_BASE}?${q.toString()}`;
  const res = await fetch(url);
  const data = await res.json();
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
  data.rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.report_id}</td><td>${r.indicator_id}</td><td>${r.period_id}</td><td>${r.value}</td><td>${r.plan_value}</td>`;
    tb.appendChild(tr);
  });
});
</script>
</body>
</html>
