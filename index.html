<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PHD Report – ផ្ទាំងគ្រប់គ្រង</title>

  <!-- Khmer fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1a26; --bg-2:#111e30; --text:#cfe0ff; --primary:#6b5bff;
      --card:#ffffff; --ink:#0b1220; --muted:#6b7b95; --ring:#e9eef7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#f5f7fb; color:#111; font-family:"Noto Sans Khmer", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Top bar */
    .topbar{
      height:56px; display:flex; align-items:center; gap:10px;
      padding:0 16px; background:#fff; border-bottom:1px solid var(--ring);
      position:sticky; top:0; z-index:40;
    }
    .brand{font-family:"Khmer Moul"; color:var(--primary); font-size:22px; letter-spacing:.5px}
    .spacer{flex:1}
    .topbar .btn{
      border:1px solid var(--ring); background:#fff; padding:8px 12px;
      border-radius:10px; cursor:pointer;
    }

    /* Sidebar */
    .sidebar{
      width:270px; background:var(--bg); color:var(--text);
      position:fixed; inset:56px auto 0 0; padding:10px 0; overflow:auto;
      transform:translateX(0); transition:transform .25s ease;
    }
    .sidebar.collapsed{ transform:translateX(-100%); }
    .menu{list-style:none; margin:0; padding:0}
    .menu > li > a, .menu-toggle{
      width:100%; display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; color:var(--text); text-decoration:none; background:transparent; border:none; cursor:pointer;
    }
    .menu > li > a:hover, .menu-toggle:hover{ background:var(--bg-2); }
    .submenu{
      list-style:none; margin:0; padding:0 0 6px 8px; display:none; background:#0d1828;
    }
    .submenu.open{ display:block; }
    .submenu a{
      display:block; padding:10px 16px; color:#e5eeff; text-decoration:none; border-left:2px solid transparent;
    }
    .submenu a:hover{ background:#0b1626; border-left-color:var(--primary) }

    /* Main */
    .main{
      margin-left:270px; padding:18px; min-height:calc(100% - 56px);
      transition:margin-left .25s ease;
    }
    .sidebar.collapsed ~ .main{ margin-left:0; }

    /* Cards */
    .cards{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .card{
      grid-column:span 12; background:var(--card); border:1px solid var(--ring);
      border-radius:14px; padding:16px; box-shadow:0 8px 18px rgba(10,22,50,.04);
    }
    .card h3{margin:0 0 8px 0; font-size:18px}
    .muted{color:var(--muted); font-size:14px}

    /* Small */
    @media (min-width: 900px){
      .card--half{grid-column:span 6}
      .card--third{grid-column:span 4}
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <button id="btnToggle" class="btn">☰</button>
    <div class="brand">ផ្ទាំងគ្រប់គ្រង PHD</div>
    <div class="spacer"></div>
    <input id="q" class="btn" style="min-width:220px" placeholder="ស្វែងរក..." />
    <a id="btnLogin" class="btn" href="login.html">ចូលប្រើប្រាស់</a>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <ul class="menu" id="menuRoot">
      <li><a href="#/dashboard">ផ្ទាំងគ្រប់គ្រង</a></li>

      <li class="has">
        <button class="menu-toggle" aria-expanded="false">ការិយាល័យ <span>▾</span></button>
        <ul class="submenu" id="deptList">
          <li class="muted" style="padding:10px 16px;">កំពុងទាញទិន្នន័យ...</li>
        </ul>
      </li>

      <li><a href="#/reports">របាយការណ៍</a></li>
      <li><a href="#/users">គ្រប់គ្រងអ្នកប្រើប្រាស់</a></li>

      <li class="has">
        <button class="menu-toggle" aria-expanded="false">កំណត់ផ្សេងៗ <span>▾</span></button>
        <ul class="submenu">
          <li><a href="#/mgmt/departments">គ្រប់គ្រងការិយាល័យ</a></li>
          <li><a href="#/mgmt/units">គ្រប់គ្រងផ្នែក</a></li>
          <li><a href="#/mgmt/periods">គ្រប់គ្រងរយៈពេល</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- Main -->
  <main id="main" class="main">
    <div class="cards">
      <div class="card card--half">
        <h3>សេចក្តីសង្ខេប</h3>
        <div class="muted">សូមជ្រើសរើសមេនុយខាងឆ្វេងដើម្បីចាប់ផ្ដើម…</div>
      </div>

      <div class="card card--half">
        <h3>ការប្រកាសព័ត៌មាន</h3>
        <div class="muted">–</div>
      </div>

      <div class="card card--third">
        <h3>កំណត់ API</h3>
        <div class="muted">API បច្ចុប្បន្ន៖ Google Apps Script</div>
      </div>
    </div>
  </main>

  <script>
    // ===== Config =====
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbyHAneIbzeg4lQpizd232Hc_-70Cwz_2fpPqAA6pdboR4iLfoHb4Lf3M4DBjZP12nHp6g/exec";
    const ls = window.localStorage;

    // ===== Helpers =====
    function getAuth(){
      try{ return JSON.parse(ls.getItem("AUTH")||"null"); }catch(e){ return null; }
    }
    function isSuper(auth){
      return !!auth && (auth.user_type === "superuser" || auth.user_root === "all");
    }
    async function gasList(route, params={}){
      const u = new URL(GAS_BASE);
      u.searchParams.set("api","1");
      u.searchParams.set("route",route);
      u.searchParams.set("op","list");
      for(const [k,v] of Object.entries(params)) u.searchParams.set(k,v);
      const res = await fetch(u.toString(), {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const j = await res.json();
      if (j.error) throw new Error(j.error);
      return Array.isArray(j.rows) ? j.rows : (Array.isArray(j) ? j : []);
    }

    // ===== UI: toggle sidebar & submenu =====
    const sidebar = document.getElementById("sidebar");
    document.getElementById("btnToggle").onclick = () => {
      sidebar.classList.toggle("collapsed");
      document.querySelector(".main").classList.toggle("collapsed");
    };
    document.querySelectorAll(".menu-toggle").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const ul = btn.nextElementSibling;
        ul.classList.toggle("open");
        btn.setAttribute("aria-expanded", ul.classList.contains("open"));
      });
    });

    // ===== Build departments & units =====
    async function buildDeptMenu(){
      const auth = getAuth();
      const box = document.getElementById("deptList");
      box.innerHTML = '<li class="muted" style="padding:10px 16px;">កំពុងទាញទិន្នន័យ...</li>';

      try{
        let depts = await gasList("departments");  // GET → no CORS preflight
        if (!isSuper(auth) && auth?.department_id){
          depts = depts.filter(d => String(d.department_id) === String(auth.department_id));
        }

        if (!depts.length){
          box.innerHTML = '<li class="muted" style="padding:10px 16px;">គ្មានទិន្នន័យការិយាល័យ</li>';
          return;
        }

        box.innerHTML = "";
        for (const d of depts){
          const li = document.createElement("li");
          li.className = "has";
          const btn = document.createElement("button");
          btn.className = "menu-toggle";
          btn.innerHTML = `${d.department_name} <span>▾</span>`;
          const ul = document.createElement("ul");
          ul.className = "submenu";
          li.append(btn, ul);
          box.appendChild(li);

          btn.addEventListener("click", ()=>{
            ul.classList.toggle("open");
            btn.setAttribute("aria-expanded", ul.classList.contains("open"));
          });

          // Load units for each department
          const units = await gasList("units", { department_id: d.department_id });
          if (!units.length){
            const empty = document.createElement("li");
            empty.innerHTML = '<span class="muted" style="padding:10px 16px; display:block;">គ្មានផ្នែក</span>';
            ul.appendChild(empty);
          }else{
            units.forEach(u=>{
              const item = document.createElement("li");
              const a = document.createElement("a");
              a.textContent = u.unit_name;
              // redirect target page (you can create these pages later)
              a.href = `pages/departments/${d.department_id}/units/${u.unit_id}/index.html`;
              item.appendChild(a);
              ul.appendChild(item);
            });
          }
        }
      }catch(err){
        box.innerHTML = `<li class="muted" style="padding:10px 16px;color:#ffb0b0;">អានទិន្នន័យបរាជ័យ: ${err.message}</li>`;
      }
    }

    // ===== Init =====
    (function init(){
      const auth = getAuth();
      const btnLogin = document.getElementById("btnLogin");
      if(auth){
        btnLogin.textContent = (auth.user_name || "អ្នកប្រើប្រាស់") + " • ចេញ";
        btnLogin.href = "#";
        btnLogin.onclick = (e)=>{
          e.preventDefault();
          ls.removeItem("AUTH");
          location.reload();
        };
      }else{
        btnLogin.textContent = "ចូលប្រើប្រាស់";
        btnLogin.href = "login.html";
      }
      buildDeptMenu();

      // filter with "q" (optional – just for demo)
      document.getElementById("q").addEventListener("input", (e)=>{
        const q = e.target.value.toLowerCase();
        document.querySelectorAll("#menuRoot a").forEach(a=>{
          const ok = a.textContent.toLowerCase().includes(q);
          a.parentElement.style.display = ok ? "" : "none";
        });
      });
    })();
  </script>
</body>
</html>
