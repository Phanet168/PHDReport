<!DOCTYPE html>
const depId = auth.department_id; rows = rows.filter(r=> String((r.department_id||r.department_id))===String(depId) || String(r.department_id||'')==='');
}
if(filter.department_id) rows = rows.filter(r=> String(r.department_id)===String(filter.department_id));
if(filter.unit_id) rows = rows.filter(r=> String(r.unit_id)===String(filter.unit_id));


// Build head
const meta = Schema[route] || { id:'id', cols: [['id','ID',80],['name','Name',220]] };
const thead = meta.cols.map(([k,lab,w])=>`<th style="width:${w||140}px">${lab}</th>`).join('') + `<th style="width:160px">សកម្មភាព</th>`;
document.getElementById('thead').innerHTML = thead;


// Save state
this.state={route, rows, filtered:rows.slice(), meta};
$('#q').value=qPreset||''; this.applySearch();


// Role-based buttons
const canWrite = WRITE_ENABLED && looksLikeAppsScript(API_BASE) && isSuper; // only super admin may write
document.getElementById('btnAdd').style.display = canWrite? 'inline-block':'none';
document.getElementById('chipInfo').textContent = `ចំនួន: ${rows.length}`;
},
applySearch(){ const q=$('#q').value.trim().toLowerCase(); const {rows}=this.state; const out=q? rows.filter(r=> JSON.stringify(r).toLowerCase().includes(q)) : rows.slice(); this.state.filtered=out; this.render(); },
render(){ const tb=$('#tbody'); const {filtered, meta} = this.state; if(!filtered.length){ tb.innerHTML=`<tr><td class="muted" colspan="99" style="padding:12px">គ្មានទិន្នន័យ</td></tr>`; return; }
tb.innerHTML = filtered.map(r=>{
const tds = meta.cols.map(([k])=>`<td>${r[k]??''}</td>`).join('');
return `<tr>${tds}<td>
<button class="btn" data-act="edit" data-id="${r[meta.id]}"><i class="ri-edit-2-line"></i> កែ</button>
<button class="btn" data-act="del" data-id="${r[meta.id]}"><i class="ri-delete-bin-line"></i> លុប</button>
</td></tr>`;
}).join('');
},
openForm(mode,row){ const auth=requireAuth(); const isSuper=String(auth.user_type||'').toLowerCase().includes('super'); if(!(WRITE_ENABLED&&looksLikeAppsScript(API_BASE)&&isSuper)){ alert('READ-ONLY or role not allowed'); return; }
const {meta,route}=this.state; $('#dlgTitle').textContent = (mode==='add'?'បន្ថែម ':'កែ ') + route; const box=$('#formFields'); box.innerHTML='';
meta.cols.forEach(([k,lab])=>{ const v=row? (row[k]??'') : ''; box.insertAdjacentHTML('beforeend', `<label>${lab}<input name="${k}" value="${String(v).replace(/"/g,'&quot;')}" /></label>`); });
const dlg=$('#formDialog'); dlg.returnValue=''; dlg.showModal(); dlg.dataset.mode=mode; dlg.dataset.id=row?row[meta.id]:''; },
async saveForm(){ const auth=requireAuth(); const isSuper=String(auth.user_type||'').toLowerCase().includes('super'); if(!(WRITE_ENABLED&&looksLikeAppsScript(API_BASE)&&isSuper)) return;
const {meta,route}=this.state; const fd=new FormData($('#formGeneric')); const row={}; meta.cols.forEach(([k])=> row[k]=fd.get(k)); if(meta.id==='department_id'||meta.id==='unit_id'||meta.id==='period_id'){ if(row[meta.id]) row[meta.id]=Number(row[meta.id]); }
// upsert
await apiUpsert(route,row); $('#formDialog').close(); await this.show(route); },
async remove(id){ const auth=requireAuth(); const isSuper=String(auth.user_type||'').toLowerCase().includes('super'); if(!(WRITE_ENABLED&&looksLikeAppsScript(API_BASE)&&isSuper)) return; const {meta,route}=this.state; if(!confirm('បញ្ជាក់លុប?')) return; await apiDelete(route, meta.id, id); await this.show(route); }
};


// ============== BOOT ==============
document.addEventListener('DOMContentLoaded', async ()=>{
const auth = requireAuth(); if(!auth) return; // redirected
document.getElementById('who').textContent = `អ្នកប្រើ: ${auth.user_name} • តួនាទី: ${auth.user_type} • ការិយាល័យ: ${auth.department_id}`;
const isSuper = String(auth.user_type||'').toLowerCase().includes('super');


// Role-based menu visibility
if(!isSuper){ document.getElementById('grpUsers').style.display='none'; document.getElementById('grpSystem').style.display='none'; }
document.getElementById('modeBadge').textContent = (looksLikeAppsScript(API_BASE) && WRITE_ENABLED && isSuper) ? 'WRITE (Apps Script)' : 'READ-ONLY (Drive JSON)';


// Build department menu
await buildDepartmentMenu(auth);


// Menu interactions
document.getElementById('menu').addEventListener('click', (e)=>{
const a=e.target.closest('a.sub'); if(!a) return; e.preventDefault(); $$('#menu a.sub').forEach(x=>x.classList.remove('active')); a.classList.add('active');
const route=a.dataset.route||'dashboard'; const filter=a.dataset.filter? JSON.parse(a.dataset.filter):{}; if(route==='dashboard'){ $('#crud-sec').style.display='none'; $('#dashboard-sec').style.display='block'; } else { CRUD.show(route, filter); }
});


document.getElementById('q').addEventListener('input', ()=> CRUD.applySearch());
document.getElementById('btnAdd').addEventListener('click', ()=> CRUD.openForm('add'));
document.getElementById('tbody').addEventListener('click', (e)=>{ const b=e.target.closest('button[data-act]'); if(!b) return; const id=b.dataset.id; if(b.dataset.act==='edit'){ const row=CRUD.state.rows.find(r=> String(r[CRUD.state.meta.id])===String(id)); CRUD.openForm('edit', row);} else if(b.dataset.act==='del'){ CRUD.remove(id);} });
document.getElementById('formGeneric').addEventListener('submit',(e)=>{ if(e.submitter?.value!=='save') return; e.preventDefault(); CRUD.saveForm(); });
document.getElementById('btnLogout').addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
});
</script>
</body>
</html>
