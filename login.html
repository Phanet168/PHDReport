
<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login — PHD Report System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{ background:#f4f6fb; font-family:"Noto Sans Khmer", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    .card{ border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.06) }
    .brand{ font-weight:700 }
  </style>
</head>
<body class="d-flex align-items-center justify-content-center vh-100">
  <div class="container" style="max-width: 460px;">
    <div class="text-center mb-3">
      <div class="brand h3 mb-0">Provincial Health Dept</div>
      <div class="text-muted">PHD Report System</div>
    </div>

    <div class="card p-4">
      <div class="mb-3">
        <label class="form-label">Apps Script API URL</label>
        <input id="apiBase" class="form-control" placeholder="https://script.google.com/macros/s/AKfycbwnxRudS_il7Dvcdh7-QB36NJaP-6-hl5nMniXrbuKhMpHPK8CCEGkRIc9-okB-P0Z6Zw/exec">
        <div class="form-text">ដាក់ URL នេះម្តងតែប៉ុណ្ណោះ (រក្សាទុកក្នុង Browser)</div>
      </div>
      <div class="mb-3">
        <label class="form-label">ឈ្មោះអ្នកប្រើ</label>
        <input id="userName" class="form-control" autocomplete="username" required>
      </div>
      <div class="mb-3">
        <label class="form-label">ពាក្យសម្ងាត់</label>
        <input id="userPass" type="password" class="form-control" autocomplete="current-password" required>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary" id="btnLogin">Login</button>
      </div>
    </div>

    <div class="text-center small text-muted mt-3">© {{YEAR}} Provincial Health Department</div>
  </div>

  <script>
  // ===== config helpers =====
  const ls = window.localStorage;
  function getApiBase(){ return (ls.getItem('API_BASE')||'').trim(); }
  function setApiBase(v){ ls.setItem('API_BASE', v.trim()); }

  // quick sha256 hash (hex)
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function apiGet(params){
    const base = getApiBase();
    const usp = new URLSearchParams(params);
    const url = base + (base.includes('?')?'&':'?') + usp.toString();
    const res = await fetch(url);
    if(!res.ok) throw new Error('API error');
    return res.json();
  }

  // UI init
  const apiInput = document.getElementById('apiBase');
  apiInput.value = getApiBase();
  document.body.innerHTML = document.body.innerHTML.replace('{{YEAR}}', new Date().getFullYear());

  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const base = apiInput.value.trim();
    if(!base){ alert('សូមបញ្ចូល API URL មុន'); return; }
    setApiBase(base);

    const user = document.getElementById('userName').value.trim();
    const pass = document.getElementById('userPass').value;
    if(!user || !pass){ alert('សូមបំពេញឈ្មោះ និង ពាក្យសម្ងាត់'); return; }

    try{
      // NOTE: API list(user) មិនទាន់មាន filter តាម user_name → ទាញទាំងអស់ហើយ filter ខាង client
      const data = await apiGet({ api:1, route:'user', op:'list', limit: 5000 });
      const rows = data.rows || [];
      const u = rows.find(r => (String(r.user_name||'').toLowerCase() === user.toLowerCase()));
      if(!u){ alert('មិនមានអ្នកប្រើនេះ'); return; }

      const passHash = await sha256Hex(pass);
      const stored = String(u.user_pass||'');
      const ok = (stored.length === 64 ? (stored === passHash) : (stored === pass));
      if(!ok){ alert('ពាក្យសម្ងាត់មិនត្រឹមត្រូវ'); return; }

      const profile = {
        user_id: u.user_id,
        user_name: u.user_name,
        user_type: u.user_type,
        user_root: u.user_root,
        department_id: u.department_id,
        login_at: Date.now()
      };
      ls.setItem('AUTH', JSON.stringify(profile));
      location.href = 'index.html';
    }catch(err){
      console.error(err); alert('Login បរាជ័យ (API)');
    }
  });
  </script>
</body>
</html>
