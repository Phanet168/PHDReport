<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á”áŸ’ášá–áŸá“áŸ’á’</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@400;500&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0; display:flex; align-items:center; justify-content:center;
      height:100vh; background:#f4f6fb; font-family:"Noto Sans Khmer",sans-serif;
    }
    .card{
      width:360px; background:#fff; border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:24px;
    }
    h1{
      font-family:"Khmer Moul"; font-size:22px; margin:0 0 20px; text-align:center;
      color:#1a237e;
    }
    label{display:block; margin:10px 0 6px}
    .field{
      position:relative;
    }
    .field input{
      width:100%; padding:10px 38px 10px 12px;
      border:1px solid #ccc; border-radius:8px; font-size:15px;
    }
    .field .toggle{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      cursor:pointer; opacity:.6;
    }
    button{
      width:100%; margin-top:16px; padding:12px; font-size:16px;
      border:none; border-radius:8px; cursor:pointer;
      background:#3f51b5; color:#fff; font-family:"Noto Sans Khmer";
    }
    button:hover{background:#303f9f}
    .msg{margin-top:12px; font-size:14px; color:#d32f2f; text-align:center; display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>á”áŸ’ášá–áŸá“áŸ’á’ášá¶á™á€á¶ášááŸáŸá»áá¶á—á·á”á¶á›</h1>
    <form id="loginForm">
      <label>áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á”áŸ’ášá¾</label>
      <div class="field">
        <input id="username" required />
      </div>

      <label>á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹</label>
      <div class="field">
        <input id="password" type="password" required />
        <span id="btnTogglePw" class="toggle">ğŸ‘</span>
      </div>

      <button type="submit">á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>

 <script>
// ======= CONFIG =======
const GAS_BASE =
  "https://script.google.com/macros/s/AKfycbz-JxocdnaiHe3ySo_wiYEuvJq7GDhJKhin-B4uvejBhR506_YTfPeSc48FiTV7jL6b7A/exec";

// ======= LOGIN HANDLER (no-preflight) =======
async function gasLogin(username, password) {
  const url = GAS_BASE + "?api=1&route=auth&op=login";

  // 1) á€á»áŸ†á”áŸ’ášá¾ application/json áŠá¾á˜áŸ’á”á¸á‡áŸ€áŸ OPTIONS preflight
  //    á”áŸ’ášá¾ text/plain á¬ x-www-form-urlencoded
  const res = await fetch(url, {
    method: "POST",
    // NOTE: á€á»áŸ†áŠá¶á€áŸ‹ headers á•áŸ’áŸáŸá„áŸ—á‘áŸ€á
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ username, password })  // Apps Script á¢á¶á“ e.postData.contents
  });

  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

// ======= UI SUBMIT =======
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;

  const msg = document.getElementById("msg");
  msg.textContent = "";
  msg.classList.add("d-none");

  try {
    const j = await gasLogin(u, p);
    if (j && !j.error) {
      // Save auth profile
      localStorage.setItem("AUTH", JSON.stringify({
        user_id: j.user_id,
        user_name: j.user_name,
        user_type: j.user_type,
        user_root: j.user_root,
        department_id: j.department_id,
        login_at: Date.now()
      }));
      // redirect
      location.href = "index.html";
    } else {
      msg.textContent = j?.error || "Login á”ášá¶á‡áŸá™";
      msg.classList.remove("d-none");
    }
  } catch (err) {
    msg.textContent = "á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášáá—áŸ’á‡á¶á”áŸ‹ API: " + err.message;
    msg.classList.remove("d-none");
  }
});
</script>

</body>
</html>
