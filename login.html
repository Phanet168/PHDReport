<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>ចូលប្រើប្រាស់ | PHD Report</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800,900&display=swap" rel="stylesheet" />

  <!-- Gull Template CSS (use the same structure you showed) -->
  <link href="../dist-assets/css/themes/lite-purple.min.css" rel="stylesheet" />

  <style>
    .auth-layout-wrap{min-height:100vh}
    .toggle-eye{position:absolute; right:14px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:.6}
    .toggle-eye:hover{opacity:1}
    .position-relative{position:relative}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.6);border-top-color:#fff;display:inline-block;vertical-align:middle;animation:spin .9s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(1turn)}}
  </style>
</head>

<body>
  <div class="auth-layout-wrap" style="background-image:url(../dist-assets/images/photo-wide-4.jpg)">
    <div class="auth-content">
      <div class="card o-hidden">
        <div class="row">
          <!-- LEFT -->
          <div class="col-md-6">
            <div class="p-4">
              <div class="auth-logo text-center mb-4">
                <img src="../../dist-assets/images/logo.png" alt="logo" />
              </div>
              <h1 class="mb-2 text-18 font-weight-bold">ចូលប្រើប្រាស់ប្រព័ន្ធ</h1>
              <p class="mb-3 text-muted">សូមបញ្ចូលឈ្មោះអ្នកប្រើ និងពាក្យសម្ងាត់</p>

              <div id="msg" class="alert alert-danger d-none" role="alert"></div>

              <form id="loginForm" novalidate>
                <div class="form-group">
                  <label for="username">ឈ្មោះអ្នកប្រើ</label>
                  <input class="form-control form-control-rounded" id="username" name="username" autocomplete="username" required />
                </div>

                <div class="form-group position-relative">
                  <label for="password">ពាក្យសម្ងាត់</label>
                  <input class="form-control form-control-rounded" id="password" name="password" type="password" autocomplete="current-password" required />
                  <span id="btnTogglePw" class="toggle-eye">👁</span>
                </div>

                <button id="btnLogin" type="submit" class="btn btn-rounded btn-primary w-100 mt-2">
                  <span id="spin" class="spinner d-none"></span>
                  <span id="btnText">ចូលប្រើប្រាស់</span>
                </button>
              </form>

              <div class="mt-3 text-center">
                <a class="text-muted" href="forgot.html"><u>ភ្លេចពាក្យសម្ងាត់?</u></a>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="col-md-6 text-center" style="background-size:cover;background-image:url(../dist-assets/images/photo-long-3.jpg)"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbwdeEgEMYK8bCZqU0xmOEERIvqbqu21tUwDKDuBb9tUXhOVwb463Hjk2XZsz9T9lBmLZQ/exec";

    // ====== DOM helpers ======
    const $ = (s) => document.querySelector(s);
    function showMsg(text) {
      const el = $("#msg");
      if (!text) { el.classList.add("d-none"); el.textContent = ""; return; }
      el.textContent = text; el.classList.remove("d-none");
    }
    function setLoading(v) {
      $("#btnLogin").disabled = v;
      $("#spin").classList.toggle("d-none", !v);
      $("#btnText").textContent = v ? "កំពុងចូល..." : "ចូលប្រើប្រាស់";
    }

    // ====== Toggle password ======
    $("#btnTogglePw").addEventListener("click", () => {
      const i = $("#password");
      i.type = i.type === "password" ? "text" : "password";
    });

    // ====== CALL GAS (text/plain to avoid preflight) ======
    async function gasLogin(username, password) {
      const res = await fetch(GAS_BASE + "?api=1&route=auth&op=login", {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ username, password })
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    // ====== Submit handler ======
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      showMsg("");
      const u = $("#username").value.trim();
      const p = $("#password").value;
      if (!u || !p) { showMsg("សូមបំពេញទាំងពីរទំព័រ"); return; }

      try {
        setLoading(true);
        const j = await gasLogin(u, p);
        if (j && !j.error) {
          localStorage.setItem("AUTH", JSON.stringify({
            user_id: j.user_id,
            user_name: j.user_name,
            user_type: j.user_type,
            user_root: j.user_root,
            department_id: j.department_id,
            login_at: Date.now()
          }));
          // redirect
          location.href = "index.html";
        } else {
          showMsg(j?.error || "ឈ្មោះអ្នកប្រើ ឬ ពាក្យសម្ងាត់ មិនត្រឹមត្រូវ");
        }
      } catch (err) {
        showMsg("បរាជ័យក្នុងការតភ្ជាប់ API: " + err.message);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
