<!DOCTYPE html>


async function loginViaUsersJson(source, username, password){
const j = await fetchDriveJson(source);
const rows = Array.isArray(j)? j : (Array.isArray(j?.rows)? j.rows : []);
const u = rows.find(r=> String(r.user_name).toLowerCase()===username.toLowerCase() && String(r.user_pass)===String(password));
if(!u) return {ok:false, reason:'ឈ្មោះ ឬ ពាក្យសម្ងាត់មិនត្រឹមត្រូវ'};
const {user_pass, ...safe} = u; setAuth({...safe, login_at:Date.now()});
return {ok:true, profile:safe};
}


async function doLogin(username,password){
const api = getApiBase();
if(looksLikeAppsScript(api)){
const r = await loginViaAppsScript(api, username, password);
if(r.ok) return r; // success
}
if(DRIVE_USERS && DRIVE_USERS!=='PUT_USERS_FILE_ID_OR_URL_HERE'){
return loginViaUsersJson(DRIVE_USERS, username, password);
}
return {ok:false, reason:'មិនអាច Authenticate បាន'};
}


// Events
document.getElementById('apiInput').value = getApiBase();
document.getElementById('btnSaveApi').onclick = ()=>{ saveApiBase($('#apiInput').value.trim()); const m=$('#msg'); m.style.display='block'; m.style.color='#065f46'; m.textContent='រក្សាទុក API រួច'; };


document.getElementById('loginForm').addEventListener('submit', async (e)=>{
e.preventDefault(); const u=$('#username').value.trim(); const p=$('#password').value; const m=$('#msg');
if(!u||!p){ m.style.display='block'; m.textContent='សូមបំពេញឈ្មោះ និង ពាក្យសម្ងាត់'; return; }
m.style.display='none';
try{
const r = await doLogin(u,p);
if(r.ok){ location.href = DASHBOARD_PAGE; }
else { m.style.display='block'; m.textContent='បរាជ័យ: '+(r.reason||''); }
}catch(err){ m.style.display='block'; m.textContent='កំហុស: '+(err.message||err); }
});
</script>
</body>
</html>
