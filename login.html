<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login — PHD Report System</title>

  <!-- Theme CSS in your repo -->
  <link rel="stylesheet" href="assets/css/themes/lite-purple.min.css">
  <link rel="stylesheet" href="assets/css/third-party.bundle.css">
  <link rel="stylesheet" href="assets/fonts/icomoon/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --radius:16px }
    body{ font-family:"Noto Sans Khmer", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f6f7fb }
    .wrap{ min-height:100dvh; display:grid; place-items:center; padding:24px }
    .card{ width:min(460px, 94vw); border-radius:var(--radius) }
    .brand{ color:#4f46e5; font-weight:700; font-size:20px }
    .muted{ color:#6b7280 }
    .divider{ height:1px; background:#e5e7eb; margin:16px 0 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card p-4 shadow-lg">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="brand">PHD Report System</div>
        <span class="badge badge-outline-primary">Login</span>
      </div>

      <form id="loginForm">
        <div class="mb-3">
          <label class="form-label">ឈ្មោះអ្នកប្រើ</label>
          <input id="username" class="form-control" placeholder="ឧ. phanet" autofocus required>
        </div>
        <div class="mb-1">
          <label class="form-label">ពាក្យសម្ងាត់</label>
          <input id="password" type="password" class="form-control" required>
        </div>
        <small class="muted">ពាក្យសម្ងាត់នឹងត្រូវបំលែងជា SHA-256 ហើយប្រៀបធៀបទៅនឹង hash ក្នុង JSON។</small>

        <div class="divider"></div>

        <div class="mb-2">
          <label class="form-label">API Base (Google Apps Script Web App)</label>
          <input id="apiBase" class="form-control"
                 value="https://script.google.com/macros/s/AKfycbwnxRudS_il7Dvcdh7-QB36NJaP-6-hl5nMniXrbuKhMpHPK8CCEGkRIc9-okB-P0Z6Zw/exec"
                 placeholder="https://script.google.com/macros/s/XXXX/exec">
          <small class="muted">បើទុក URL ត្រឹមត្រូវ នឹងទាញ users JSON ពី Drive តាម Apps Script Web App។</small>
        </div>

        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-primary">ចូលប្រើប្រាស់</button>
        </div>
        <div id="msg" class="alert alert-danger d-none mt-3"></div>
      </form>
    </div>
  </div>

  <script>
    // ====== Config & helpers ======
    const DASHBOARD_PAGE = "index.html";
    const ls = window.localStorage;

    const $ = (sel, el=document) => el.querySelector(sel);

    function saveApiBase(v){ v ? ls.setItem("API_BASE", v) : ls.removeItem("API_BASE"); }
    function getApiBase(){ return (ls.getItem("API_BASE")||"").trim(); }
    function setAuth(profile){ ls.setItem("AUTH", JSON.stringify(profile)); }

    async function sha256Hex(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    async function fetchUsersJson(apiBase){
      const res = await fetch(apiBase, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      return res.json(); // expect: array of users
    }

    async function loginWithDriveJson(username, password, apiBase) {
      const users = await fetchUsersJson(apiBase);
      // users: [{user_id,user_name,user_pass(user_pass_sha256),user_type,user_root,department_id}, ...]
      const u = users.find(x => (x.user_name||"").toLowerCase() === username.toLowerCase());
      if(!u) return { ok:false, reason:"រកមិនឃើញអ្នកប្រើ" };

      const hash = await sha256Hex(password);
      const stored = String(u.user_pass || u.user_pass_sha256 || "").toLowerCase();
      if(hash !== stored) return { ok:false, reason:"ពាក្យសម្ងាត់មិនត្រឹមត្រូវ" };

      const profile = {
        user_id: u.user_id,
        user_name: u.user_name,
        user_type: u.user_type,
        user_root: u.user_root,
        department_id: u.department_id,
        login_at: Date.now()
      };
      setAuth(profile);
      return { ok:true, profile };
    }

    // ====== Submit handler ======
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = $("#username").value.trim();
      const password = $("#password").value;
      const apiBase  = $("#apiBase").value.trim();
      const msg = $("#msg");

      msg.classList.add("d-none");
      if(!username || !password || !apiBase){
        msg.textContent = "សូមបញ្ចូលព័ត៍មានអស់ទាំងអស់ (មានទាំង API Base)"; 
        msg.classList.remove("d-none"); 
        return;
      }

      try{
        saveApiBase(apiBase);
        const res = await loginWithDriveJson(username, password, apiBase);
        if(res.ok){
          location.href = DASHBOARD_PAGE;
        }else{
          msg.textContent = "Login បរាជ័យ: " + res.reason;
          msg.classList.remove("d-none");
        }
      }catch(err){
        console.error(err);
        msg.textContent = "មានបញ្ហាភ្ជាប់ទៅ API (Apps Script) — សូមពិនិត្យ URL ឬ Access";
        msg.classList.remove("d-none");
      }
    });
  </script>
</body>
</html>
