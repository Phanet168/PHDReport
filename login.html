<script>
  const DASHBOARD_PAGE = "index.html";
  const ls = window.localStorage;
  const $ = (s,el=document)=>el.querySelector(s);

  function saveApiBase(v){ v ? ls.setItem("API_BASE", v) : ls.removeItem("API_BASE"); }
  function getApiBase(){ return (ls.getItem("API_BASE")||"").trim(); }
  function setAuth(profile){ ls.setItem("AUTH", JSON.stringify(profile)); }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function fetchJson(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    return res.json();
  }

  // === NEW: detect Apps Script style ===
  function looksLikeAppsScript(url){
    return /script\.google\.com\/macros\/s\/.+\/exec/.test(url);
  }

  // === NEW: login via GAS auth route (plaintext as in your server) ===
  async function loginViaAppsScript(apiBase, username, password){
    const url = apiBase + (apiBase.includes("?") ? "&" : "?") + "api=1&route=auth&op=login";
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username, password })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    if(json && !json.error){
      // server already strips user_pass; use what it returns
      const profile = {
        user_id: json.user_id,
        user_name: json.user_name,
        user_type: json.user_type,
        user_root: json.user_root,
        department_id: json.department_id,
        login_at: Date.now()
      };
      setAuth(profile);
      return { ok:true, profile };
    }else{
      return { ok:false, reason: json?.error || "Login failed" };
    }
  }

  // === fallback: read users JSON directly and compare SHA256 (old behavior) ===
  async function resolveUsers(url){
    const j = await fetchJson(url);
    if (Array.isArray(j)) return j;        // users array
    if (Array.isArray(j.users)) return j.users; // {users:[...]}
    if (j.rows && Array.isArray(j.rows)) return j.rows; // {rows:[...]} (e.g. /users&op=list)
    throw new Error("Unsupported JSON schema");
  }
  async function loginViaUsersJson(sourceUrl, username, password){
    const users = await resolveUsers(sourceUrl);
    const u = users.find(x => String(x.user_name||"").toLowerCase() === username.toLowerCase());
    if(!u) return { ok:false, reason:"រកមិនឃើញអ្នកប្រើ" };
    const hash = await sha256Hex(password);
    const stored = String(u.user_pass||u.user_pass_sha256||"").toLowerCase();
    if(hash !== stored) return { ok:false, reason:"ពាក្យសម្ងាត់មិនត្រឹមត្រូវ" };
    const profile = {
      user_id:u.user_id, user_name:u.user_name, user_type:u.user_type,
      user_root:u.user_root, department_id:u.department_id, login_at:Date.now()
    };
    setAuth(profile);
    return { ok:true, profile };
  }

  // === combine flow ===
  async function doLogin(username, password, sourceUrl){
    const api = sourceUrl.trim();
    if(!api) throw new Error("Empty API/JSON URL");
    // 1) GAS auth route
    if (looksLikeAppsScript(api)) {
      return loginViaAppsScript(api, username, password);
    }
    // 2) users.json / raw GitHub / or /users&op=list
    return loginViaUsersJson(api, username, password);
  }

  // === API dialog handlers (ប្រើដដែល) ===
  const apiDialog = document.getElementById("apiDialog");
  const apiForm   = document.getElementById("apiForm");
  const apiInput  = document.getElementById("apiInput");
  const apiMsg    = document.getElementById("apiMsg");
  const msg       = document.getElementById("msg");
  const hint      = document.getElementById("hint");

  function openApiDialog(){ apiMsg.classList.add("d-none"); apiInput.value=getApiBase()||""; apiDialog.showModal(); }
  document.getElementById("btnOpenApi").onclick = openApiDialog;

  apiForm.addEventListener("submit", async (e)=>{
    if(e.submitter?.value!=="confirm") return;
    e.preventDefault();
    apiMsg.classList.add("d-none");
    try{
      const v = apiInput.value.trim();
      // quick probe:
      if (looksLikeAppsScript(v)) {
        // ping lightweight endpoint: users list (GET)
        const url = v + (v.includes("?") ? "&" : "?") + "api=1&route=users&op=list&limit=1";
        await fetchJson(url);
      } else {
        // expect to be users.json or {users:[...]} or {rows:[...]}
        await resolveUsers(v);
      }
      saveApiBase(v);
      apiDialog.close();
      hint.textContent = "រក្សាទុក API/JSON សម្រេច — សាកល្បង Login ម្តងទៀត។";
      hint.classList.remove("d-none");
    }catch(err){
      apiMsg.textContent = "URL មិនត្រឹមត្រូវ ឬអានបរាជ័យ: " + err.message;
      apiMsg.classList.remove("d-none");
    }
  });

  // === login submit ===
  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    msg.classList.add("d-none"); hint.classList.add("d-none");
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;
    const apiBase  = getApiBase();

    if(!username || !password){
      msg.textContent = "សូមបំពេញ ឈ្មោះអ្នកប្រើ និង ពាក្យសម្ងាត់";
      msg.classList.remove("d-none"); return;
    }
    if(!apiBase){
      hint.textContent = "មិនទាន់កំណត់ API/JSON URL — សូមបញ្ចូល URL ជាមុនសិន។";
      hint.classList.remove("d-none");
      return openApiDialog();
    }
    try{
      const res = await doLogin(username, password, apiBase);
      if(res.ok) location.href = DASHBOARD_PAGE;
      else { msg.textContent = "Login បរាជ័យ: " + (res.reason||""); msg.classList.remove("d-none"); }
    }catch(err){
      msg.textContent = "អានពី API បរាជ័យ: " + err.message;
      msg.classList.remove("d-none");
      // ដោយស្វ័យប្រវត្តិ បើក dialog ឲ្យកែ URL
      openApiDialog();
    }
  });
</script>
