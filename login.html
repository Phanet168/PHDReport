<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login â€” PHD Report System</title>

  <!-- Gull CSS: á”áŸ’ášá¶á€áŠáá¶ path ááŸ’ášá¹á˜ â€” á”á¾áááˆáŸ’á˜áŸ„áŸ‡ "themes" áŸášáŸáŸáš themes/  -->
  <link rel="stylesheet" href="assets/css/themes/title-purple.min.css">
  <link rel="stylesheet" href="assets/css/themes/perfect-scrollbar.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style> body{font-family:"Noto Sans Khmer","Roboto",sans-serif} </style>
</head>
<body>
  <!-- Auth layout ášá”áŸáŸ‹ Gull -->
  <div class="auth-layout-wrap" style="background:linear-gradient(135deg,#5f4dee,#a16ae8);">
    <div class="auth-content">
      <div class="card o-hidden">
        <div class="row">
          <div class="col-md-12">
            <div class="p-4 p-md-5">
              <div class="text-center mb-3">
                <h3 class="mb-0">Provincial Health Dept</h3>
                <div class="text-muted">PHD Report System</div>
              </div>

              <form id="loginForm">
                <div class="form-group mb-3">
                  <label class="text-muted">Apps Script API URL</label>
                  <input id="apiBase" class="form-control form-control-rounded"
                         placeholder="https://script.google.com/macros/s/AKfycbwnxRudS_il7Dvcdh7-QB36NJaP-6-hl5nMniXrbuKhMpHPK8CCEGkRIc9-okB-P0Z6Zw/exec">
                  <small class="form-text text-muted">ášá€áŸ’áŸá¶á‘á»á€á€áŸ’á“á»á„ Browser á˜áŸ’áá„ááŸ‚á”áŸ‰á»ááŸ’ááŸ„áŸ‡</small>
                </div>
                <div class="form-group mb-3">
                  <label>áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á”áŸ’ášá¾</label>
                  <input id="userName" class="form-control form-control-rounded" autocomplete="username" required>
                </div>
                <div class="form-group mb-4 position-relative">
                  <label>á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹</label>
                  <input id="userPass" type="password" 
                 class="form-control form-control-rounded pe-5" 
                  autocomplete="current-password" required>
                  <button type="button" class="btn btn-sm btn-link position-absolute top-50 end-0 translate-middle-y me-2" 
     id="togglePass" tabindex="-1">
    ğŸ‘
  </button>
</div>

                <button type="submit" class="btn btn-primary btn-rounded btn-block">á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</button>
              </form>

              <div id="loginMsg" class="text-danger small mt-3 d-none">Login á”ášá¶á‡áŸá™</div>
              <div class="text-center text-muted small mt-3">Â© <span id="yr"></span> Provincial Health Department</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vendor JS -->
  <script src="assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script>
  // ===== Settings =====
  const DASHBOARD_PAGE = 'dashboard.html';   // á”áŸ’áá¼ášá‘áŸ…á‘áŸ†á–áŸáš dashboard ášá”áŸáŸ‹á”á„
  const ls = window.localStorage;

  const apiInput = document.getElementById('apiBase');
  const msg = document.getElementById('loginMsg');
  document.getElementById('yr').textContent = new Date().getFullYear();

  // remember API URL
  apiInput.value = (ls.getItem('API_BASE')||'').trim();

  function setApiBase(v){ ls.setItem('API_BASE', v.trim()); }
  function getApiBase(){ return (ls.getItem('API_BASE')||'').trim(); }

  // helpers
  async function sha256Hex(str){
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function apiGet(params){
    const base = getApiBase();
    const qs = new URLSearchParams(params).toString();
    const url = base + (base.includes('?')?'&':'?') + qs;
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('API GET failed');
    return res.json();
  }

  // login
  document.getElementById('loginForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.classList.add('d-none'); msg.textContent = '';

    const base = apiInput.value.trim();
    if(!base){ msg.textContent='áŸá¼á˜á”á‰áŸ’á…á¼á› API URL'; msg.classList.remove('d-none'); return; }
    setApiBase(base);

    const user = document.getElementById('userName').value.trim();
    const pass = document.getElementById('userPass').value;
    if(!user || !pass){ msg.textContent='áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„ á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹'; msg.classList.remove('d-none'); return; }

    try{
      const { rows=[] } = await apiGet({ api:1, route:'user', op:'list', limit:5000 });
      const u = rows.find(r => String(r.user_name||'').toLowerCase() === user.toLowerCase());
      if(!u){ msg.textContent='á˜á·á“á˜á¶á“á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á“áŸáŸ‡'; msg.classList.remove('d-none'); return; }

      const stored = String(u.user_pass||'');
      const ok = (stored.length === 64) ? (await sha256Hex(pass)) === stored : (stored === pass);
      if(!ok){ msg.textContent='á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ'; msg.classList.remove('d-none'); return; }

      const profile = {
        user_id: u.user_id, user_name: u.user_name,
        user_type: u.user_type, user_root: u.user_root,
        department_id: u.department_id, login_at: Date.now()
      };
      ls.setItem('AUTH', JSON.stringify(profile));
      location.href = DASHBOARD_PAGE;   // âœ… redirect ááŸ’ášá¹á˜
    }catch(err){
      console.error(err);
      msg.textContent='Login á”ášá¶á‡áŸá™ (API)'; msg.classList.remove('d-none');
    }
  });
  </script>
</body>
</html>
