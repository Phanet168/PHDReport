<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ចូលប្រើប្រាស់ | PHD Report</title>

  <!-- Khmer + Nunito -->
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Gull theme (utilities/buttons) -->
  <link href="dist-assets/css/themes/lite-purple.min.css" rel="stylesheet"/>

  <style>
    :root{
      --card-w: 420px; --boxH: 46px; --radius: 14px; --bd: #E5E7EB;
      --focus: #7C4DFF; --focus-ring: #7C4DFF33;
      --shadow: 0 12px 32px rgba(24,24,40,.08); --shadow-soft: 0 8px 20px rgba(24,24,40,.06);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:linear-gradient(180deg,#F6F7FB, #EEF1F8);
      font-family:"Noto Sans Khmer", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .login-wrap{ width:min(92vw, var(--card-w)); background:#fff; border-radius:18px; box-shadow: var(--shadow-soft); padding:28px 26px 26px; }
    .kh-title{ font-family:"Khmer Moul"; color:#4A148C; letter-spacing:.2px; }

    .form-group{ margin-bottom:14px; }
    .input-group{ border:1px solid var(--bd); border-radius: var(--radius); height: var(--boxH);
      overflow:hidden; background:#fff; transition: box-shadow .2s, border-color .2s; }
    .input-group:focus-within{ border-color: var(--focus); box-shadow: 0 0 0 4px var(--focus-ring); }
    .input-group-text{ width:44px; border:0; background:#fff; color:#6B7280; display:flex; align-items:center; justify-content:center; }
    .form-control{ border:0 !important; height:var(--boxH); padding:0 12px; font-size:15px; box-shadow:none !important; }
    .eye-btn{ cursor:pointer; user-select:none; }

    .btn-primary{ height:48px; border-radius:14px; font-weight:600; background:#6C2BD9; border-color:#6C2BD9; box-shadow: var(--shadow); }
    .btn-primary:hover{ background:#5B21B6; border-color:#5B21B6; }

    .logo-dot{ width:52px; height:52px; border-radius:14px; display:grid; place-items:center;
      background:linear-gradient(135deg,#7C4DFF,#6C2BD9); color:#fff; font-weight:800; font-size:22px;
      box-shadow: 0 10px 24px rgba(124,77,255,.25); margin-inline:auto; }
  </style>
</head>
<body>

  <main class="login-wrap">
    <div class="text-center mb-3">
      <div class="logo-dot">PHD</div>
    </div>
    <h2 class="kh-title text-center mb-1">ប្រព័ន្ធរាយការណ៍សុខាភិបាល</h2>
    <p class="text-muted text-center mb-4">សូមបញ្ចូលឈ្មោះអ្នកប្រើ និងពាក្យសម្ងាត់</p>

    <div id="msg" class="alert alert-danger d-none" role="alert"></div>

    <form id="loginForm" novalidate>
      <div class="form-group">
        <label for="username" class="mb-1">ឈ្មោះអ្នកប្រើ</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-person"></i></span>
          <input id="username" class="form-control" autocomplete="username" required>
        </div>
      </div>

      <div class="form-group">
        <label for="password" class="mb-1">ពាក្យសម្ងាត់</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-lock"></i></span>
          <input id="password" type="password" class="form-control" autocomplete="current-password" required>
          <span id="btnTogglePw" class="input-group-text eye-btn" title="បង្ហាញ/លាក់"><i class="bi bi-eye"></i></span>
        </div>
      </div>

      <button id="btnLogin" type="submit" class="btn btn-primary w-100 mt-2">
        <span id="btnText">ចូលប្រើប្រាស់</span>
      </button>

      <div class="mt-3 text-center">
        <a class="text-muted" href="#"><u>ភ្លេចពាក្យសម្ងាត់?</u></a>
      </div>
    </form>
  </main>

  <!-- ================== LOGIN SCRIPT ================== -->
  <script>
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbwuvNrQOG7CoQiEb6LXyz-0KJgir_H5LPjGrcS79Vf9qH-0sU9Mln5N3YvQJn4u_n74HA/exec";

    // LocalStorage AUTH helpers
    const LS = window.localStorage;
    const setAuth = (obj)=>LS.setItem('AUTH', JSON.stringify(obj||null));
    const getAuth = ()=>{ try { return JSON.parse(LS.getItem('AUTH')||'null'); } catch { return null; } };

    // Role helpers
    const isSuper     = a => String(a?.user_type||'').toLowerCase() === 'superuser';
    const isDataEntry = a => ['admin','dataentry'].includes(String(a?.user_type||'').toLowerCase());
    const isViewer    = a => String(a?.user_type||'').toLowerCase() === 'viewer';

    // Redirect after login
    function gotoAfterLogin(auth){
      if (isSuper(auth))      return location.replace('index.html');
      if (isDataEntry(auth))  return location.replace('pages/admin/index.html');
      if (isViewer(auth))     return location.replace('pages/user/index.html');
      location.replace('index.html');
    }

    // UI helpers
    const $ = (s)=>document.querySelector(s);
    const msgBox = $("#msg");

    $("#btnTogglePw").addEventListener("click", () => {
      const inp = $("#password"); const ico = $("#btnTogglePw i");
      if (inp.type === "password") { inp.type = "text"; ico.className = "bi bi-eye-slash"; }
      else { inp.type = "password"; ico.className = "bi bi-eye"; }
    });
    // Alias for router
function login(username, password) {
  return login_(username, password);
}


    function showMsg(t){
      if(!t){ msgBox.classList.add("d-none"); msgBox.textContent=""; return; }
      msgBox.textContent = t; msgBox.classList.remove("d-none");
    }

    // API call
  async function apiLogin(username, password){
  const res = await fetch(GAS_BASE + "?api=1&route=auth&op=login", {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ username, password })
  });
  if(!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const u = $("#username").value.trim();
  const p = $("#password").value;
  try {
    const user = await apiLogin(u,p);
    if(user && !user.error){
      localStorage.setItem("AUTH", JSON.stringify(user));
      if(user.role === "super")      location.href = "index.html";
      else if(user.role === "dataentry") location.href = "pages/admin/index.html";
      else location.href = "pages/user/index.html";
    }else{
      showMsg(user?.error || "Login បរាជ័យ");
    }
  }catch(err){
    showMsg("API Error: " + err.message);
  }
});

    // Shortcut Enter
    ['#username','#password'].forEach(sel=>{
      document.querySelector(sel).addEventListener('keydown', e=>{
        if(e.key==='Enter') document.getElementById('btnLogin').click();
      });
    });

    // Auto redirect if already logged in
    (function redirectIfAlreadyLoggedIn(){
      const a = getAuth();
      if (a && a.user_type) { gotoAfterLogin(a); }
    })();
  </script>
</body>
</html>
