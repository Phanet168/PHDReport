<!-- login.html -->
<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ចូលប្រើប្រព័ន្ធ | PHD Report</title>

  <!-- YOUR THEME/ASSETS (match repo tree) -->
  <link rel="stylesheet" href="assets/css/third-party.bundle.css">
  <link rel="stylesheet" href="assets/css/themes/lite-purple.min.css">

  <!-- Khmer Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Khmer+Moul&family=Noto+Sans+Khmer:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --brand:#5b6ef5; --shadow:0 15px 40px rgba(0,0,0,.08); }
    html,body{ height:100%; background:linear-gradient(135deg,#eef2ff,#f8fafc 45%,#ffffff); font-family:"Noto Sans Khmer",system-ui,Segoe UI,Arial,sans-serif; }
    .wrap{ min-height:100%; display:grid; place-items:center; padding:24px }
    .card-login{ width:min(440px,92vw); border-radius:22px; box-shadow:var(--shadow); border:0; overflow:hidden }
    .card-login .head{ background:#0f172a; color:#fff; padding:22px 24px }
    .brand{ font-family:"Khmer Moul",system-ui; font-size:28px; letter-spacing:.2px }
    .muted{ opacity:.9; font-size:12px }
    .body{ padding:22px 24px 26px; background:#fff }
    .k-input{ position:relative; margin-bottom:14px }
    .k-input input{ width:100%; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:12px 42px 12px 12px; outline:none }
    .k-input input:focus{ border-color:#93c5fd; box-shadow:0 0 0 .25rem rgba(147,197,253,.25) }
    .k-input .icon{ position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#64748b; cursor:pointer }
    .btn-k{ width:100%; border:0; border-radius:12px; padding:12px 14px; background:var(--brand); color:#fff; font-weight:700 }
    .btn-k[disabled]{ opacity:.75; cursor:wait }
    .help{ display:flex; align-items:center; gap:8px; color:#475569; font-size:13px; margin-top:8px }
    .err{ display:none; margin-top:10px; border-radius:12px; padding:10px 12px; background:#fef2f2; color:#b91c1c; border:1px solid #fecaca }
    .foot{ padding:12px 24px 18px; font-size:12px; color:#64748b; background:#fff }
    .api-link{ text-decoration:none; color:#64748b }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card card-login">
    <div class="head">
      <div class="brand">ប្រព័ន្ធរាយការណ៍សុខភាព</div>
      <div class="muted">សូមចូលប្រើជាមួយគណនីដែលបានផ្តល់ជូន</div>
    </div>

    <form id="f" class="body" autocomplete="on">
      <label class="form-label">ឈ្មោះអ្នកប្រើ</label>
      <div class="k-input">
        <input id="u" name="username" placeholder="ឈ្មោះអ្នកប្រើ" required autofocus>
        <i class="icon i-Administrator"></i>
      </div>

      <label class="form-label">ពាក្យសម្ងាត់</label>
      <div class="k-input">
        <input id="p" name="password" type="password" placeholder="ពាក្យសម្ងាត់" required>
        <i id="toggle" class="icon i-Eye"></i>
      </div>

      <button id="btn" class="btn-k" type="submit">ចូលប្រើប្រព័ន្ធ</button>
      <div id="err" class="err">ចូលប្រើបរាជ័យ៖ សូមពិនិត្យឈ្មោះអ្នកប្រើ/ពាក្យសម្ងាត់ម្តងទៀត។</div>

      <div class="help">
        <i class="i-Security-Block"></i>
        <span>សិទ្ធិ Supper Admin អាចចូលគ្រប់ការិយាល័យ។ អ្នកប្រើធម្មតាចូលបានតែការិយាល័យរបស់ខ្លួន។</span>
      </div>
    </form>

    <div class="foot">
      <a class="api-link" href="#" title="API in code">API ត្រូវបានកំណត់ក្នុងកូដ</a>
    </div>
  </div>
</div>

<!-- Core JS from your template -->
<script src="assets/js/jquery-3.3.1.min.js"></script>
<script src="assets/js/bootstrap.bundle.min.js"></script>

<script>
const GAS_BASE =
  "https://script.google.com/macros/s/AKfycbyHAneIbzeg4lQpizd232Hc_-70Cwz_2fpPqAA6pdboR4iLfoHb4Lf3M4DBjZP12nHp6g/exec";

async function gasLogin(username, password){
  const url = GAS_BASE + "?api=1&route=auth&op=login";
  // NOTE: Content-Type: text/plain  -> គ្មាន preflight
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ username, password }),
    // មិនចាំបាច់: mode:'cors'  (default)
  });
  if(!res.ok){ throw new Error("HTTP " + res.status); }
  const data = await res.json();   // Apps Script បញ្ជូន JSON
  if(data.error){ throw new Error(data.error); }
  return data; // {user_id, user_name, user_type, user_root, department_id, ...}
}

// ហៅពី form submit
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;
  const msg = document.getElementById("msg");
  msg.textContent = ""; msg.classList.add("d-none");

  try{
    const profile = await gasLogin(u,p);

    // guard: supper/super admin ទៅគ្រប់គ្រងទូលំទូលាយ, otherwise redirect ទៅផ្ទាំងការិយាល័យខ្លួន
    localStorage.setItem("AUTH", JSON.stringify({ ...profile, login_at: Date.now() }));

    if (String(profile.user_type).toLowerCase()==="superuser" ||
        String(profile.user_root).toLowerCase()==="all") {
      location.href = "./pages/super-admin/index.html";
    } else {
      // Redirect ទៅផ្ទាំងការិយាល័យតាម department_id
      location.href = `./pages/departments/${profile.department_id}/index.html`;
    }
  }catch(err){
    msg.textContent = "Login បរាជ័យ: " + err.message;
    msg.classList.remove("d-none");
  }
});
</script>

</body>
</html>
